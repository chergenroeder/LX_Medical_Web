/*! wsc Built on: 2017-10-24 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d={};d.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},d.localCName=d.generateIdentifier(),d.splitLines=function(a){return a.trim().split("\n").map(function(a){return a.trim()})},d.splitSections=function(a){var b=a.split("\nm=");return b.map(function(a,b){return(b>0?"m="+a:a).trim()+"\r\n"})},d.matchPrefix=function(a,b){return d.splitLines(a).filter(function(a){return 0===a.indexOf(b)})},d.parseCandidate=function(a){var b;b=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" ");for(var c={foundation:b[0],component:b[1],protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],port:parseInt(b[5],10),type:b[7]},d=8;d<b.length;d+=2)switch(b[d]){case"raddr":c.relatedAddress=b[d+1];break;case"rport":c.relatedPort=parseInt(b[d+1],10);break;case"tcptype":c.tcpType=b[d+1]}return c},d.writeCandidate=function(a){var b=[];b.push(a.foundation),b.push(a.component),b.push(a.protocol.toUpperCase()),b.push(a.priority),b.push(a.ip),b.push(a.port);var c=a.type;return b.push("typ"),b.push(c),"host"!==c&&a.relatedAddress&&a.relatedPort&&(b.push("raddr"),b.push(a.relatedAddress),b.push("rport"),b.push(a.relatedPort)),a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(b.push("tcptype"),b.push(a.tcpType)),"candidate:"+b.join(" ")},d.parseRtpMap=function(a){var b=a.substr(9).split(" "),c={payloadType:parseInt(b.shift(),10)};return b=b[0].split("/"),c.name=b[0],c.clockRate=parseInt(b[1],10),c.numChannels=3===b.length?parseInt(b[2],10):1,c},d.writeRtpMap=function(a){var b=a.payloadType;return void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType),"a=rtpmap:"+b+" "+a.name+"/"+a.clockRate+(1!==a.numChannels?"/"+a.numChannels:"")+"\r\n"},d.parseExtmap=function(a){var b=a.substr(9).split(" ");return{id:parseInt(b[0],10),uri:b[1]}},d.writeExtmap=function(a){return"a=extmap:"+(a.id||a.preferredId)+" "+a.uri+"\r\n"},d.parseFmtp=function(a){for(var b,c={},d=a.substr(a.indexOf(" ")+1).split(";"),e=0;e<d.length;e++)b=d[e].trim().split("="),c[b[0].trim()]=b[1];return c},d.writeFmtp=function(a){var b="",c=a.payloadType;if(void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.parameters&&Object.keys(a.parameters).length){var d=[];Object.keys(a.parameters).forEach(function(b){d.push(b+"="+a.parameters[b])}),b+="a=fmtp:"+c+" "+d.join(";")+"\r\n"}return b},d.parseRtcpFb=function(a){var b=a.substr(a.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}},d.writeRtcpFb=function(a){var b="",c=a.payloadType;return void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(function(a){b+="a=rtcp-fb:"+c+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"}),b},d.parseSsrcMedia=function(a){var b=a.indexOf(" "),c={ssrc:parseInt(a.substr(7,b-7),10)},d=a.indexOf(":",b);return d>-1?(c.attribute=a.substr(b+1,d-b-1),c.value=a.substr(d+1)):c.attribute=a.substr(b+1),c},d.getDtlsParameters=function(a,b){var c=d.splitLines(a);c=c.concat(d.splitLines(b));var e=c.filter(function(a){return 0===a.indexOf("a=fingerprint:")})[0].substr(14),f={role:"auto",fingerprints:[{algorithm:e.split(" ")[0],value:e.split(" ")[1]}]};return f},d.writeDtlsParameters=function(a,b){var c="a=setup:"+b+"\r\n";return a.fingerprints.forEach(function(a){c+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"}),c},d.getIceParameters=function(a,b){var c=d.splitLines(a);c=c.concat(d.splitLines(b));var e={usernameFragment:c.filter(function(a){return 0===a.indexOf("a=ice-ufrag:")})[0].substr(12),password:c.filter(function(a){return 0===a.indexOf("a=ice-pwd:")})[0].substr(10)};return e},d.writeIceParameters=function(a){return"a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n"},d.parseRtpParameters=function(a){for(var b={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=d.splitLines(a),e=c[0].split(" "),f=3;f<e.length;f++){var g=e[f],h=d.matchPrefix(a,"a=rtpmap:"+g+" ")[0];if(h){var i=d.parseRtpMap(h),j=d.matchPrefix(a,"a=fmtp:"+g+" ");switch(i.parameters=j.length?d.parseFmtp(j[0]):{},i.rtcpFeedback=d.matchPrefix(a,"a=rtcp-fb:"+g+" ").map(d.parseRtcpFb),b.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":b.fecMechanisms.push(i.name.toUpperCase())}}}return d.matchPrefix(a,"a=extmap:").forEach(function(a){b.headerExtensions.push(d.parseExtmap(a))}),b},d.writeRtpDescription=function(a,b){var c="";return c+="m="+a+" ",c+=b.codecs.length>0?"9":"0",c+=" UDP/TLS/RTP/SAVPF ",c+=b.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType}).join(" ")+"\r\n",c+="c=IN IP4 0.0.0.0\r\n",c+="a=rtcp:9 IN IP4 0.0.0.0\r\n",b.codecs.forEach(function(a){c+=d.writeRtpMap(a),c+=d.writeFmtp(a),c+=d.writeRtcpFb(a)}),c+="a=rtcp-mux\r\n"},d.parseRtpEncodingParameters=function(a){var b,c=[],e=d.parseRtpParameters(a),f=e.fecMechanisms.indexOf("RED")!==-1,g=e.fecMechanisms.indexOf("ULPFEC")!==-1,h=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute}),i=h.length>0&&h[0].ssrc,j=d.matchPrefix(a,"a=ssrc-group:FID").map(function(a){var b=a.split(" ");return b.shift(),b.map(function(a){return parseInt(a,10)})});j.length>0&&j[0].length>1&&j[0][0]===i&&(b=j[0][1]),e.codecs.forEach(function(a){if("RTX"===a.name.toUpperCase()&&a.parameters.apt){var d={ssrc:i,codecPayloadType:parseInt(a.parameters.apt,10),rtx:{payloadType:a.payloadType,ssrc:b}};c.push(d),f&&(d=JSON.parse(JSON.stringify(d)),d.fec={ssrc:b,mechanism:g?"red+ulpfec":"red"},c.push(d))}}),0===c.length&&i&&c.push({ssrc:i});var k=d.matchPrefix(a,"b=");return k.length&&(0===k[0].indexOf("b=TIAS:")?k=parseInt(k[0].substr(7),10):0===k[0].indexOf("b=AS:")&&(k=parseInt(k[0].substr(5),10)),c.forEach(function(a){a.maxBitrate=k})),c},d.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},d.writeMediaSection=function(a,b,c,e){var f=d.writeRtpDescription(a.kind,b);if(f+=d.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=d.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":"active"),f+="a=mid:"+a.mid+"\r\n",f+=a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var g="msid:"+e.id+" "+a.rtpSender.track.id+"\r\n";f+="a="+g,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+g}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n"},d.getDirection=function(a,b){for(var c=d.splitLines(a),e=0;e<c.length;e++)switch(c[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[e].substr(2)}return b?d.getDirection(b):"sendrecv"},b.exports=d},{}],2:[function(a,b,c){"use strict";!function(){var c=a("./utils").log,d=a("./utils").browserDetails;b.exports.browserDetails=d,b.exports.extractVersion=a("./utils").extractVersion,b.exports.disableLog=a("./utils").disableLog;var e=a("./chrome/chrome_shim")||null,f=a("./edge/edge_shim")||null,g=a("./firefox/firefox_shim")||null,h=a("./safari/safari_shim")||null;switch(d.browser){case"opera":case"chrome":if(!e||!e.shimPeerConnection)return void c("Chrome shim is not included in this adapter release.");c("adapter.js shimming chrome."),b.exports.browserShim=e,e.shimGetUserMedia(),e.shimMediaStream(),e.shimSourceObject(),e.shimPeerConnection(),e.shimOnTrack();break;case"firefox":if(!g||!g.shimPeerConnection)return void c("Firefox shim is not included in this adapter release.");c("adapter.js shimming firefox."),b.exports.browserShim=g,g.shimGetUserMedia(),g.shimSourceObject(),g.shimPeerConnection(),g.shimOnTrack();break;case"edge":if(!f||!f.shimPeerConnection)return void c("MS edge shim is not included in this adapter release.");c("adapter.js shimming edge."),b.exports.browserShim=f,f.shimGetUserMedia(),f.shimPeerConnection();break;case"safari":if(!h)return void c("Safari shim is not included in this adapter release.");c("adapter.js shimming safari."),b.exports.browserShim=h,h.shimGetUserMedia();break;default:c("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":5,"./firefox/firefox_shim":7,"./safari/safari_shim":9,"./utils":10}],3:[function(a,b,c){"use strict";var d=a("../utils.js").log,e=a("../utils.js").browserDetails,f={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){var b=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=a),this.addEventListener("addstream",this._ontrackpoly=function(a){a.stream.addEventListener("addtrack",function(c){var d=new Event("track");d.track=c.track,d.receiver={track:c.track},d.streams=[a.stream],b.dispatchEvent(d)}),a.stream.getTracks().forEach(function(b){var c=new Event("track");c.track=b,c.receiver={track:b},c.streams=[a.stream],this.dispatchEvent(c)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(a){var b=this;return this._srcObject=a,this.src&&URL.revokeObjectURL(this.src),a?(this.src=URL.createObjectURL(a),a.addEventListener("addtrack",function(){b.src&&URL.revokeObjectURL(b.src),b.src=URL.createObjectURL(a)}),void a.addEventListener("removetrack",function(){b.src&&URL.revokeObjectURL(b.src),b.src=URL.createObjectURL(a)})):void(this.src="")}}))},shimPeerConnection:function(){window.RTCPeerConnection=function(a,b){d("PeerConnection"),a&&a.iceTransportPolicy&&(a.iceTransports=a.iceTransportPolicy);var c=new webkitRTCPeerConnection(a,b),e=c.getStats.bind(c);return c.getStats=function(a,b,c){var d=this,f=arguments;if(arguments.length>0&&"function"==typeof a)return e(a,b);var g=function(a){var b={},c=a.result();return c.forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:a.type};a.names().forEach(function(b){c[b]=a.stat(b)}),b[c.id]=c}),b},h=function(a,b){var c=new Map(Object.keys(a).map(function(b){return[b,a[b]]}));return b=b||a,Object.keys(b).forEach(function(a){c[a]=b[a]}),c};if(arguments.length>=2){var i=function(a){f[1](h(g(a)))};return e.apply(this,[i,arguments[0]])}return new Promise(function(b,c){1===f.length&&"object"==typeof a?e.apply(d,[function(a){b(h(g(a)))},c]):e.apply(d,[function(a){b(h(g(a),a.result()))},c])}).then(b,c)},c},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var c=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){b.apply(a,[d,e,c])})}return b.apply(this,arguments)}}),e.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=arguments,c=this,d=new Promise(function(d,e){b.apply(c,[a[0],d,e])});return a.length<2?d:d.then(function(){a[1].apply(null,[])},function(b){a.length>=3&&a[2].apply(null,[b])})}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){return arguments[0]=new("addIceCandidate"===a?RTCIceCandidate:RTCSessionDescription)(arguments[0]),b.apply(this,arguments)}});var a=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?a.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}};b.exports={shimMediaStream:f.shimMediaStream,shimOnTrack:f.shimOnTrack,shimSourceObject:f.shimSourceObject,shimPeerConnection:f.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils.js":10,"./getusermedia":4}],4:[function(a,b,c){"use strict";var d=a("../utils.js").log;b.exports=function(){var a=function(a){if("object"!=typeof a||a.mandatory||a.optional)return a;var b={};return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d="object"==typeof a[c]?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);var e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];var f={};"number"==typeof d.ideal?(f[e("min",c)]=d.ideal,b.optional.push(f),f={},f[e("max",c)]=d.ideal,b.optional.push(f)):(f[e("",c)]=d.ideal,b.optional.push(f))}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(function(a){void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b},b=function(b,c){if(b=JSON.parse(JSON.stringify(b)),b&&b.audio&&(b.audio=a(b.audio)),b&&"object"==typeof b.video){var e=b.video.facingMode;if(e=e&&("object"==typeof e?e:{ideal:e}),e&&("user"===e.exact||"environment"===e.exact||"user"===e.ideal||"environment"===e.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete b.video.facingMode,"environment"===e.exact||"environment"===e.ideal))return navigator.mediaDevices.enumerateDevices().then(function(f){f=f.filter(function(a){return"videoinput"===a.kind});var g=f.find(function(a){return a.label.toLowerCase().indexOf("back")!==-1})||f.length&&f[f.length-1];return g&&(b.video.deviceId=e.exact?{exact:g.deviceId}:{ideal:g.deviceId}),b.video=a(b.video),d("chrome: "+JSON.stringify(b)),c(b)});b.video=a(b.video)}return d("chrome: "+JSON.stringify(b)),c(b)},c=function(a){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[a.name]||a.name,message:a.message,constraint:a.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},e=function(a,d,e){b(a,function(a){navigator.webkitGetUserMedia(a,d,function(a){e(c(a))})})};navigator.getUserMedia=e;var f=function(a){return new Promise(function(b,c){navigator.getUserMedia(a,b,c)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:f,enumerateDevices:function(){return new Promise(function(a){var b={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(c){a(c.map(function(a){return{label:a.label,kind:b[a.kind],deviceId:a.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var g=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(a){return b(a,function(a){return g(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("","NotFoundError");return b},function(a){return Promise.reject(c(a))})})}}else navigator.mediaDevices.getUserMedia=function(a){return f(a)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){d("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){d("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":10}],5:[function(a,b,c){"use strict";var d=a("sdp"),e=a("../utils").browserDetails,f={shimPeerConnection:function(){if(window.RTCIceGatherer){window.RTCIceCandidate||(window.RTCIceCandidate=function(a){return a}),window.RTCSessionDescription||(window.RTCSessionDescription=function(a){return a});var a=Object.getOwnPropertyDescriptor(MediaStreamTrack.prototype,"enabled");Object.defineProperty(MediaStreamTrack.prototype,"enabled",{set:function(b){a.set.call(this,b);var c=new Event("enabled");c.enabled=b,this.dispatchEvent(c)}})}window.RTCPeerConnection=function(a){var b=this,c=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(a){b[a]=c[a].bind(c)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return b.localStreams},this.getRemoteStreams=function(){return b.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},a&&a.iceTransportPolicy)switch(a.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=a.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}if(this.usingBundle=a&&"max-bundle"===a.bundlePolicy,a&&a.iceServers){var d=JSON.parse(JSON.stringify(a.iceServers));this.iceOptions.iceServers=d.filter(function(a){if(a&&a.urls){var b=a.urls;return"string"==typeof b&&(b=[b]),b=b.filter(function(a){return 0===a.indexOf("turn:")&&a.indexOf("transport=udp")!==-1&&a.indexOf("turn:[")===-1||0===a.indexOf("stun:")&&e.version>=14393})[0],!!b}return!1})}this._config=a,this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var a=this,b=d.splitSections(a.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(c){var d=!c.candidate||0===Object.keys(c.candidate).length;if(d)for(var e=1;e<b.length;e++)b[e].indexOf("\r\na=end-of-candidates\r\n")===-1&&(b[e]+="a=end-of-candidates\r\n");else c.candidate.candidate.indexOf("typ endOfCandidates")===-1&&(b[c.candidate.sdpMLineIndex+1]+="a="+c.candidate.candidate+"\r\n");if(a.localDescription.sdp=b.join(""),a.dispatchEvent(c),null!==a.onicecandidate&&a.onicecandidate(c),!c.candidate&&"complete"!==a.iceGatheringState){var f=a.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});f&&(a.iceGatheringState="complete")}}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.getConfiguration=function(){return this._config},window.RTCPeerConnection.prototype.addStream=function(a){var b=a.clone();a.getTracks().forEach(function(a,c){var d=b.getTracks()[c];a.addEventListener("enabled",function(a){d.enabled=a.enabled})}),this.localStreams.push(b),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(a){var b=this.localStreams.indexOf(a);b>-1&&(this.localStreams.splice(b,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})},window.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})},window.RTCPeerConnection.prototype._getCommonCapabilities=function(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]};return a.codecs.forEach(function(a){for(var d=0;d<b.codecs.length;d++){var e=b.codecs[d];if(a.name.toLowerCase()===e.name.toLowerCase()&&a.clockRate===e.clockRate){e.numChannels=Math.min(a.numChannels,e.numChannels),c.codecs.push(e),e.rtcpFeedback=e.rtcpFeedback.filter(function(b){for(var c=0;c<a.rtcpFeedback.length;c++)if(a.rtcpFeedback[c].type===b.type&&a.rtcpFeedback[c].parameter===b.parameter)return!0;return!1});break}}}),a.headerExtensions.forEach(function(a){for(var d=0;d<b.headerExtensions.length;d++){var e=b.headerExtensions[d];if(a.uri===e.uri){c.headerExtensions.push(e);break}}}),c},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(a,b){var c=this,e=new RTCIceGatherer(c.iceOptions),f=new RTCIceTransport(e);e.onlocalcandidate=function(g){var h=new Event("icecandidate");h.candidate={sdpMid:a,sdpMLineIndex:b};var i=g.candidate,j=!i||0===Object.keys(i).length;j?(void 0===e.state&&(e.state="completed"),h.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"):(i.component="RTCP"===f.component?2:1,h.candidate.candidate=d.writeCandidate(i));var k=d.splitSections(c.localDescription.sdp);h.candidate.candidate.indexOf("typ endOfCandidates")===-1?k[h.candidate.sdpMLineIndex+1]+="a="+h.candidate.candidate+"\r\n":k[h.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n",c.localDescription.sdp=k.join("");var l=c.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});switch(c.iceGatheringState){case"new":c._localIceCandidatesBuffer.push(h),j&&l&&c._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":c._emitBufferedCandidates(),c.dispatchEvent(h),null!==c.onicecandidate&&c.onicecandidate(h),l&&(c.dispatchEvent(new Event("icecandidate")),null!==c.onicecandidate&&c.onicecandidate(new Event("icecandidate")),c.iceGatheringState="complete");break;case"complete":}},f.onicestatechange=function(){c._updateConnectionState()};var g=new RTCDtlsTransport(f);return g.ondtlsstatechange=function(){c._updateConnectionState()},g.onerror=function(){g.state="failed",c._updateConnectionState()},{iceGatherer:e,iceTransport:f,dtlsTransport:g}},window.RTCPeerConnection.prototype._transceive=function(a,b,c){var e=this._getCommonCapabilities(a.localCapabilities,a.remoteCapabilities);b&&a.rtpSender&&(e.encodings=a.sendEncodingParameters,e.rtcp={cname:d.localCName},a.recvEncodingParameters.length&&(e.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(e)),c&&a.rtpReceiver&&("video"===a.kind&&a.recvEncodingParameters&&a.recvEncodingParameters.forEach(function(a){delete a.rtx}),e.encodings=a.recvEncodingParameters,e.rtcp={cname:a.cname},a.sendEncodingParameters.length&&(e.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),a.rtpReceiver.receive(e))},window.RTCPeerConnection.prototype.setLocalDescription=function(a){var b,c,e=this;if("offer"===a.type)this._pendingOffer&&(b=d.splitSections(a.sdp),c=b.shift(),b.forEach(function(a,b){var c=d.parseRtpParameters(a);e._pendingOffer[b].localCapabilities=c}),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===a.type){b=d.splitSections(e.remoteDescription.sdp),c=b.shift();var f=d.matchPrefix(c,"a=ice-lite").length>0;b.forEach(function(a,b){var g=e.transceivers[b],h=g.iceGatherer,i=g.iceTransport,j=g.dtlsTransport,k=g.localCapabilities,l=g.remoteCapabilities,m="0"===a.split("\n",1)[0].split(" ",2)[1];if(!m&&!g.isDatachannel){var n=d.getIceParameters(a,c);if(f){var o=d.matchPrefix(a,"a=candidate:").map(function(a){return d.parseCandidate(a)}).filter(function(a){return"1"===a.component});o.length&&i.setRemoteCandidates(o)}var p=d.getDtlsParameters(a,c);f&&(p.role="server"),e.usingBundle&&0!==b||(i.start(h,n,f?"controlling":"controlled"),j.start(p));var q=e._getCommonCapabilities(k,l);e._transceive(g,q.codecs.length>0,!1)}})}switch(this.localDescription={type:a.type,sdp:a.sdp},a.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+a.type+'"')}var g=arguments.length>1&&"function"==typeof arguments[1];if(g){var h=arguments[1];window.setTimeout(function(){h(),"new"===e.iceGatheringState&&(e.iceGatheringState="gathering"),e._emitBufferedCandidates()},0)}var i=Promise.resolve();return i.then(function(){g||("new"===e.iceGatheringState&&(e.iceGatheringState="gathering"),window.setTimeout(e._emitBufferedCandidates.bind(e),500))}),i},window.RTCPeerConnection.prototype.setRemoteDescription=function(a){var b=this,c=new MediaStream,e=[],f=d.splitSections(a.sdp),g=f.shift(),h=d.matchPrefix(g,"a=ice-lite").length>0;switch(this.usingBundle=d.matchPrefix(g,"a=group:BUNDLE ").length>0,f.forEach(function(f,i){var j=d.splitLines(f),k=j[0].substr(2).split(" "),l=k[0],m="0"===k[1],n=d.getDirection(f,g),o=d.matchPrefix(f,"a=mid:");if(o=o.length?o[0].substr(6):d.generateIdentifier(),"application"===l&&"DTLS/SCTP"===k[2])return void(b.transceivers[i]={mid:o,isDatachannel:!0});var p,q,r,s,t,u,v,w,x,y,z,A,B=d.parseRtpParameters(f);m||(z=d.getIceParameters(f,g),A=d.getDtlsParameters(f,g),A.role="client"),w=d.parseRtpEncodingParameters(f);var C,D=d.matchPrefix(f,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];D&&(C=D.value);var E=d.matchPrefix(f,"a=end-of-candidates",g).length>0,F=d.matchPrefix(f,"a=candidate:").map(function(a){return d.parseCandidate(a)}).filter(function(a){return"1"===a.component});if("offer"!==a.type||m)"answer"!==a.type||m||(p=b.transceivers[i],q=p.iceGatherer,r=p.iceTransport,s=p.dtlsTransport,t=p.rtpSender,u=p.rtpReceiver,v=p.sendEncodingParameters,x=p.localCapabilities,b.transceivers[i].recvEncodingParameters=w,b.transceivers[i].remoteCapabilities=B,b.transceivers[i].cname=C,(h||E)&&F.length&&r.setRemoteCandidates(F),b.usingBundle&&0!==i||(r.start(q,z,"controlling"),s.start(A)),b._transceive(p,"sendrecv"===n||"recvonly"===n,"sendrecv"===n||"sendonly"===n),!u||"sendrecv"!==n&&"sendonly"!==n?delete p.rtpReceiver:(y=u.track,e.push([y,u]),c.addTrack(y)));else{var G=b.usingBundle&&i>0?{iceGatherer:b.transceivers[0].iceGatherer,iceTransport:b.transceivers[0].iceTransport,dtlsTransport:b.transceivers[0].dtlsTransport}:b._createIceAndDtlsTransports(o,i);if(E&&G.iceTransport.setRemoteCandidates(F),x=RTCRtpReceiver.getCapabilities(l),x.codecs=x.codecs.filter(function(a){return"rtx"!==a.name}),v=[{ssrc:1001*(2*i+2)}],u=new RTCRtpReceiver(G.dtlsTransport,l),y=u.track,e.push([y,u]),c.addTrack(y),b.localStreams.length>0&&b.localStreams[0].getTracks().length>=i){var H;"audio"===l?H=b.localStreams[0].getAudioTracks()[0]:"video"===l&&(H=b.localStreams[0].getVideoTracks()[0]),H&&(t=new RTCRtpSender(H,G.dtlsTransport))}b.transceivers[i]={iceGatherer:G.iceGatherer,iceTransport:G.iceTransport,dtlsTransport:G.dtlsTransport,localCapabilities:x,remoteCapabilities:B,rtpSender:t,rtpReceiver:u,kind:l,mid:o,cname:C,sendEncodingParameters:v,recvEncodingParameters:w},b._transceive(b.transceivers[i],!1,"sendrecv"===n||"sendonly"===n)}}),this.remoteDescription={type:a.type,sdp:a.sdp},a.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+a.type+'"')}return c.getTracks().length&&(b.remoteStreams.push(c),window.setTimeout(function(){var a=new Event("addstream");a.stream=c,b.dispatchEvent(a),null!==b.onaddstream&&window.setTimeout(function(){b.onaddstream(a)},0),e.forEach(function(d){var e=d[0],f=d[1],g=new Event("track");g.track=e,g.receiver=f,g.streams=[c],b.dispatchEvent(a),null!==b.ontrack&&window.setTimeout(function(){b.ontrack(g)},0)})},0)),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop(),a.dtlsTransport&&a.dtlsTransport.stop(),a.rtpSender&&a.rtpSender.stop(),a.rtpReceiver&&a.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(a){this.signalingState=a;var b=new Event("signalingstatechange");this.dispatchEvent(b),null!==this.onsignalingstatechange&&this.onsignalingstatechange(b)},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var a=new Event("negotiationneeded");this.dispatchEvent(a),null!==this.onnegotiationneeded&&this.onnegotiationneeded(a)},window.RTCPeerConnection.prototype._updateConnectionState=function(){var a,b=this,c={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(a){c[a.iceTransport.state]++,c[a.dtlsTransport.state]++}),c.connected+=c.completed,a="new",c.failed>0?a="failed":c.connecting>0||c.checking>0?a="connecting":c.disconnected>0?a="disconnected":c.new>0?a="new":(c.connected>0||c.completed>0)&&(a="connected"),a!==b.iceConnectionState){b.iceConnectionState=a;var d=new Event("iceconnectionstatechange");this.dispatchEvent(d),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(d)}},window.RTCPeerConnection.prototype.createOffer=function(){var a=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var b;1===arguments.length&&"function"!=typeof arguments[0]?b=arguments[0]:3===arguments.length&&(b=arguments[2]);var c=[],e=0,f=0;if(this.localStreams.length&&(e=this.localStreams[0].getAudioTracks().length,f=this.localStreams[0].getVideoTracks().length),b){if(b.mandatory||b.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==b.offerToReceiveAudio&&(e=b.offerToReceiveAudio),void 0!==b.offerToReceiveVideo&&(f=b.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(a){c.push({kind:a.kind,track:a,wantReceive:"audio"===a.kind?e>0:f>0}),"audio"===a.kind?e--:"video"===a.kind&&f--});e>0||f>0;)e>0&&(c.push({kind:"audio",wantReceive:!0}),e--),f>0&&(c.push({kind:"video",wantReceive:!0}),f--);var g=d.writeSessionBoilerplate(),h=[];c.forEach(function(b,c){var e=b.track,f=b.kind,g=d.generateIdentifier(),i=a.usingBundle&&c>0?{iceGatherer:h[0].iceGatherer,iceTransport:h[0].iceTransport,dtlsTransport:h[0].dtlsTransport}:a._createIceAndDtlsTransports(g,c),j=RTCRtpSender.getCapabilities(f);j.codecs=j.codecs.filter(function(a){return"rtx"!==a.name}),j.codecs.forEach(function(a){"H264"===a.name&&void 0===a.parameters["level-asymmetry-allowed"]&&(a.parameters["level-asymmetry-allowed"]="1")});var k,l,m=[{ssrc:1001*(2*c+1)}];e&&(k=new RTCRtpSender(e,i.dtlsTransport)),b.wantReceive&&(l=new RTCRtpReceiver(i.dtlsTransport,f)),h[c]={iceGatherer:i.iceGatherer,iceTransport:i.iceTransport,dtlsTransport:i.dtlsTransport,localCapabilities:j,remoteCapabilities:null,rtpSender:k,rtpReceiver:l,kind:f,mid:g,sendEncodingParameters:m,recvEncodingParameters:null}}),this.usingBundle&&(g+="a=group:BUNDLE "+h.map(function(a){return a.mid}).join(" ")+"\r\n"),c.forEach(function(b,c){var e=h[c];g+=d.writeMediaSection(e,e.localCapabilities,"offer",a.localStreams[0])}),this._pendingOffer=h;var i=new RTCSessionDescription({type:"offer",sdp:g});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,i),Promise.resolve(i)},window.RTCPeerConnection.prototype.createAnswer=function(){var a=this,b=d.writeSessionBoilerplate();this.usingBundle&&(b+="a=group:BUNDLE "+this.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n"),this.transceivers.forEach(function(c){if(c.isDatachannel)return void(b+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+c.mid+"\r\n");var e=a._getCommonCapabilities(c.localCapabilities,c.remoteCapabilities);b+=d.writeMediaSection(c,e,"answer",a.localStreams[0])});var c=new RTCSessionDescription({
type:"answer",sdp:b});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,c),Promise.resolve(c)},window.RTCPeerConnection.prototype.addIceCandidate=function(a){if(a){var b=a.sdpMLineIndex;if(a.sdpMid)for(var c=0;c<this.transceivers.length;c++)if(this.transceivers[c].mid===a.sdpMid){b=c;break}var e=this.transceivers[b];if(e){var f=Object.keys(a.candidate).length>0?d.parseCandidate(a.candidate):{};if("tcp"===f.protocol&&(0===f.port||9===f.port))return;if("1"!==f.component)return;"endOfCandidates"===f.type&&(f={}),e.iceTransport.addRemoteCandidate(f);var g=d.splitSections(this.remoteDescription.sdp);g[b+1]+=(f.type?a.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=g.join("")}}else this.transceivers.forEach(function(a){a.iceTransport.addRemoteCandidate({})});return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var a=[];this.transceivers.forEach(function(b){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(c){b[c]&&a.push(b[c].getStats())})});var b=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(c){var d=new Map;Promise.all(a).then(function(a){a.forEach(function(a){Object.keys(a).forEach(function(b){d.set(b,a[b]),d[b]=a[b]})}),b&&window.setTimeout(b,0,d),c(d)})})}}};b.exports={shimPeerConnection:f.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils":10,"./getusermedia":6,sdp:1}],6:[function(a,b,c){"use strict";b.exports=function(){var a=function(a){return{name:{PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:a.message,constraint:a.constraint,toString:function(){return this.name}}},b=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return b(c).catch(function(b){return Promise.reject(a(b))})}}},{}],7:[function(a,b,c){"use strict";var d=a("../utils").browserDetails,e={shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=a),this.addEventListener("addstream",this._ontrackpoly=function(a){a.stream.getTracks().forEach(function(b){var c=new Event("track");c.track=b,c.receiver={track:b},c.streams=[a.stream],this.dispatchEvent(c)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(a){this.mozSrcObject=a}}))},shimPeerConnection:function(){if("object"==typeof window&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(a,b){if(d.version<38&&a&&a.iceServers){for(var c=[],e=0;e<a.iceServers.length;e++){var f=a.iceServers[e];if(f.hasOwnProperty("urls"))for(var g=0;g<f.urls.length;g++){var h={url:f.urls[g]};0===f.urls[g].indexOf("turn")&&(h.username=f.username,h.credential=f.credential),c.push(h)}else c.push(a.iceServers[e])}a.iceServers=c}return new mozRTCPeerConnection(a,b)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=RTCPeerConnection.prototype[a];RTCPeerConnection.prototype[a]=function(){return arguments[0]=new("addIceCandidate"===a?RTCIceCandidate:RTCSessionDescription)(arguments[0]),b.apply(this,arguments)}});var a=RTCPeerConnection.prototype.addIceCandidate;if(RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?a.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())},d.version<48){var b=function(a){var b=new Map;return Object.keys(a).forEach(function(c){b.set(c,a[c]),b[c]=a[c]}),b},c=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(a,d,e){return c.apply(this,[a||null]).then(function(a){return b(a)}).then(d,e)}}}}};b.exports={shimOnTrack:e.shimOnTrack,shimSourceObject:e.shimSourceObject,shimPeerConnection:e.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils":10,"./getusermedia":8}],8:[function(a,b,c){"use strict";var d=a("../utils").log,e=a("../utils").browserDetails;b.exports=function(){var a=function(a){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[a.message]||a.message,constraint:a.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},b=function(b,c,f){var g=function(a){if("object"!=typeof a||a.require)return a;var b=[];return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d=a[c]="object"==typeof a[c]?a[c]:{ideal:a[c]};if(void 0===d.min&&void 0===d.max&&void 0===d.exact||b.push(c),void 0!==d.exact&&("number"==typeof d.exact?d.min=d.max=d.exact:a[c]=d.exact,delete d.exact),void 0!==d.ideal){a.advanced=a.advanced||[];var e={};"number"==typeof d.ideal?e[c]={min:d.ideal,max:d.ideal}:e[c]=d.ideal,a.advanced.push(e),delete d.ideal,Object.keys(d).length||delete a[c]}}}),b.length&&(a.require=b),a};return b=JSON.parse(JSON.stringify(b)),e.version<38&&(d("spec: "+JSON.stringify(b)),b.audio&&(b.audio=g(b.audio)),b.video&&(b.video=g(b.video)),d("ff37: "+JSON.stringify(b))),navigator.mozGetUserMedia(b,c,function(b){f(a(b))})},c=function(a){return new Promise(function(c,d){b(a,c,d)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:c,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(a){var b=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];a(b)})},e.version<41){var f=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return f().then(void 0,function(a){if("NotFoundError"===a.name)return[];throw a})}}if(e.version<49){var g=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(b){return g(b).then(function(a){if(b.audio&&!a.getAudioTracks().length||b.video&&!a.getVideoTracks().length)throw a.getTracks().forEach(function(a){a.stop()}),new DOMException("The object can not be found here.","NotFoundError");return a},function(b){return Promise.reject(a(b))})}}navigator.getUserMedia=function(a,c,d){return e.version<44?b(a,c,d):(console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),void navigator.mediaDevices.getUserMedia(a).then(c,d))}}},{"../utils":10}],9:[function(a,b,c){"use strict";var d={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};b.exports={shimGetUserMedia:d.shimGetUserMedia}},{}],10:[function(a,b,c){"use strict";var d=!0,e={disableLog:function(a){return"boolean"!=typeof a?new Error("Argument type: "+typeof a+". Please use a boolean."):(d=a,a?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==typeof window){if(d)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)},detectBrowser:function(){var a={};if(a.browser=null,a.version=null,"undefined"==typeof window||!window.navigator)return a.browser="Not a browser.",a;if(navigator.mozGetUserMedia)a.browser="firefox",a.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)a.browser="chrome",a.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return a.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",a;a.browser="safari",a.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return a.browser="Not a supported browser.",a;a.browser="edge",a.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return a}};b.exports={log:e.log,disableLog:e.disableLog,browserDetails:e.detectBrowser(),extractVersion:e.extractVersion}},{}]},{},[2]);var cloud=function(a){function b(){var a={};if(a.browser=null,a.version=null,"undefined"==typeof window||!window.navigator)return a.browser="Not a browser.",a;if(navigator.mozGetUserMedia)a.browser="firefox",a.version=c(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)a.browser="chrome",a.version=c(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return a.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",a;a.browser="safari",a.version=c(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return a.browser="Not a supported browser.",a;a.browser="edge",a.version=c(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return a}function c(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)}var d=a._private=a._private||{},e=b(),f={};f.isFirefox="firefox"===e.browser,f.isChrome="chrome"===e.browser,f.isEdge="edge"===e.browser,f.isIE=!1,f.isSafari=!1,f.version=e.version,f.supportSessionStorage=!1;try{f.supportSessionStorage="sessionStorage"in window&&null!=window.sessionStorage}catch(a){}var g;return g=navigator.userAgent.indexOf("MSIE")!==-1?/MSIE (\d+\.\d+);/:/Trident.*rv[ :]*(\d+\.\d+)/,g.test(navigator.userAgent)&&(f.isIE=!0,f.version=Number(RegExp.$1)),navigator.userAgent.indexOf("Safari")===-1||f.isChrome||f.isFirefox||f.isEdge||(f.isSafari=!0),d.browser=f,a}(cloud||{}),cloud=function(a){"use strict";var b=a._private=a._private||{},c={};return c.LOGLEVEL={DEBUG:2,INFO:4,WARN:6,ERROR:8,OFF:10},c.SESSIONSTATE={NONE:"NONE",CONNECTED:"CONNECTED",RECONNECTING:"RECONNECTING",RELOADING:"RELOADING",HIBERNATED:"HIBERNATED",SUSPENDED:"SUSPENDED",FAILED:"FAILED",CLOSED:"CLOSED"},c.CALLSTATE={NONE:"NONE",STARTED:"STARTED",RESPONDED:"RESPONDED",ESTABLISHED:"ESTABLISHED",UPDATING:"UPDATING",UPDATE_FAILED:"UPDATE_FAILED",UPDATED:"UPDATED",FAILED:"FAILED",ERROR:"ERROR",ENDED:"ENDED"},c.MEDIASTREAMEVENT={LOCAL_STREAM_ADDED:"LOCAL_STREAM_ADDED",LOCAL_STREAM_REMOVED:"LOCAL_STREAM_REMOVED",LOCAL_STREAM_ERROR:"LOCAL_STREAM_ERROR",REMOTE_STREAM_ADDED:"REMOTE_STREAM_ADDED",REMOTE_STREAM_REMOVED:"REMOTE_STREAM_REMOVED",REMOTE_STREAM_ERROR:"REMOTE_STREAM_ERROR"},c.MEDIADIRECTION={SENDONLY:"sendonly",RECVONLY:"recvonly",SENDRECV:"sendrecv",NONE:"inactive",INACTIVE:"inactive"},c.ERRORCODE={UNAUTHORIZED:401,FORBIDDEN:403,RESOURCE_UNAVAILABLE:404,PROXYAUTH_REQUIRED:407,TEMPORARILY_UNAVAILABLE:480,BUSY_HERE:486,REQUEST_TERMINATED:487,SYSTEM_ERROR:500,BUSY_EVERYWHERE:600,DECLINED:603,WEBSOCKET_ERROR:1001,PEERCONNECTION_ERROR:1101,SET_LOCAL_SDP_ERROR:1102,SET_REMOTE_SDP_ERROR:1103,GENERATE_SDP_ERROR:1104,MEDIA_ERROR:1201,GET_USER_MEDIA_ERROR:1202,RESTORE_FAILED:1301,SAVE_FAILED:1302,SIGNALING_ERROR:1401,ICE_CONNECTION_ERROR:1501},c.PROTOCOL={HOST:"HOST",STUN:"STUN",TURN:"TURN"},c.LOGTYPE={EVENT_LOG:"event",ERROR_LOG:"error"},c.EVENTLOG={CALL_START:"call starts",CALL_END:"call ends",CALL_UPDATE:"call updates",ESTABLISH_PEER_CONNECTION_START:"establishing peer connection starts",ESTABLISH_PEER_CONNECTION_END:"establishing peer connection ends",PEER_CONNECTION_CREATE_OFFER:"peer connection creates offer",PEER_CONNECTION_CREATE_ANSWER:"peer connection creates answer",NETWORK_SWITCHED:"network switched",GET_USER_MEDIA:"succeed to get user media",ON_ICE_CANDIDATE:"onicecandidate",ON_ADD_STREAM:"onaddstream",ON_REMOVE_STREAM:"onremovestream",ON_SIGNALING_STATE_CHANGE:"onsignalingstatechange",ON_ICE_CONNECTION_STATE_CHANGE:"oniceconnectionstatechange",ON_NEGOTIATION_NEEDED:"onnegotiationneeded",ON_DATA_CHANNEL:"ondatachannel",ON_ICE_GATHERING_STATE_CHANGE:"onicegatheringstatechange"},c.ERRORLOG={ERROR_FROM_SERVER:"receive error responded from server",GET_USER_MEDIA_ERROR:"failed to get access to local media",GENERATE_SDP_ERROR:"failed to generate SDP",ICE_CONNECTION_ERROR:"ice connection failed",SET_REMOTE_SDP_ERROR:"failed to set remote SDP"},c.AUTHTYPE={SERVICE:"SERVICE",TURN:"TURN"},c.ConnectionStateEnum={INIT:"init",ESTABLISHED:"established",ERROR:"error",CLOSED:"closed"},c.PACKAGE={ALL:"all",REGISTER:"register",CALL:"call",CONVERSATION:"conversation",MESSAGE_NOTIFICATION:"message_notification",MESSAGING:"messaging",CAPABILITY:"capability",CHAT:"chat",FILE_TRANSFER:"file_transfer"},c.CONSTCS={SERVER:"s",CLIENT:"c"},c.RESUME_STATE={waittingFinalResp:"waittingFinalResp",reStartingCall:"reStartingCall"},c.OFFER_ANSWER_STATE={INITIAL:"Initial state",OFFER_SENT:"Offer sent",OFFER_GOT:"Offer received",OFFER_REJECTED:"My offer was rejected by the other peer",OFFER_REJECT:"I Rejected the other peer's offer",ANSWER_SENT:"Answer sent",ANSWER_GOT:"Answer received",ACK_SENT:"Ack sent",ACK_GOT:"Ack received",GLARE:"Glare state"},c.TYPE={REQUEST:"request",ACK:"acknowledgement",RESPONSE:"response",MESSAGE:"message",ERROR:"error"},c.ACTION={CONNECT:"connect",START:"start",SHUTDOWN:"shutdown",COMPLETE:"complete",NOTIFY:"notify",RELAY:"relay",RELIABLE_RELAY:"reliableRelay",TRICKLE:"trickle",PRACK:"prack",ENQUIRY:"enquiry",MODIFY:"modify",HIBERNATE:"hibernate",ICE_ENQUIRY:"iceEnquiry",RELAY_FAILED:"relayFailed",AUDIT:"audit"},c.MESSAGESTATE={INITIAL:"initial",SUBSEQUENT:"subsequent",FINAL:"final"},c.CONVERSATION={ADD_STREAM:"add_stream",REMOVE_STREAM:"remove_stream",BEGIN_RECORD:"begin_record",END_RECORD:"end_record",LIST_PARTICIPANTS:"list_participants",STREAM_OPTIONS:"media_direction",STREAM_LAYOUT:"video_layout",RECORDING_RULES:"recording_rules",PAUSE_RESUME_STREAM:"pause_resume_stream",UPDATE_PROFILE:"update_profile",CANCEL:"cancel",CREATE_SIDEBAR:"create_sidebar",REMOTE_ADD_STREAM:"remote_add_stream"},c.CONVERSATIONSTATE={STREAM_ADDED:"stream_added",STREAM_REMOVED:"stream_removed",STREAM_REJECTED:"stream_rejected",STREAM_JOINED:"stream_joined",STREAM_STARTED:"stream_started",STREAM_LEFT:"stream_left",STREAM_CHANGED:"stream_changed",STREAM_ACTIVE:"stream_active",RECORDING_STARTED:"recording_started",RECORDING_ENDED:"recording_ended",PROFILE_UPDATED:"profile_updated",SIDEBAR_CREATED:"sidebar_created"},c.STREAMTYPE={AUDIOVIDEO:"audiovideo",SCREENSHARE:"screenshare"},c.STREAMSIZE={MAX:"maximize",MIN:"minimize",PRIMARY:"primary",NORMAL:"normal"},c.RELAYTYPE={COMMAND:"command",TEXT:"text",DATA:"data"},c.RELAYSTATUS={ACCEPTED:"accepted",DECLINED:"declined"},c.PAUSERESUME={PAUSE:"pause",RESUME:"resume"},c.PAUSERESUMEREASON={PAUSE_RESUME:"pause_resume",UPGRADE_DOWNGRADE:"upgrade_downgrade"},c.ICE_CHECK_PERIOD=2e3,c.PROTOCOL_VERSION="4.0",c.ExperienceFactor={VIDEO_INBOUND:"video_inbound",VIDEO_OUTBOUND:"video_outbound",AUDIO_INBOUND:"audio_inbound",AUDIO_OUTBOUND:"audio_outbound"},c.ExperienceStatus={GOOD:2,BAD:1,NOT_AVAILABLE:0},b.wscConst=c,a.MEDIADIRECTION=c.MEDIADIRECTION,a.SESSIONSTATE=c.SESSIONSTATE,a.CONNECTIONSTATE=c.SESSIONSTATE,a.CALLSTATE=c.CALLSTATE,a.STREAMSTATE=c.CALLSTATE,a.MEDIASTREAMEVENT=c.MEDIASTREAMEVENT,a.ERRORCODE=c.ERRORCODE,a.AUTHTYPE=c.AUTHTYPE,a.ConnectionStateEnum=c.ConnectionStateEnum,a.LOGLEVEL=c.LOGLEVEL,a.MSSAGETYPE=c.TYPE,a.ACTION=c.ACTION,a.CONVERSATION=c.CONVERSATION,a.CONVERSATIONSTATE=c.CONVERSATIONSTATE,a.STREAMTYPE=c.STREAMTYPE,a.STREAMSIZE=c.STREAMSIZE,a.RELAYTYPE=c.RELAYTYPE,a.RELAYSTATUS=c.RELAYSTATUS,a.PAUSERESUME=c.PAUSERESUME,a.PAUSERESUMEREASON=c.PAUSERESUMEREASON,a.ExperienceFactor=c.ExperienceFactor,a.ExperienceStatus=c.ExperienceStatus,a}(cloud||{}),cloud=function(a){var b=a._private=a._private||{},c=b.wscUtils=b.wscUtils||{};return c.Map=function(){"use strict";this.mapSize=0,this.entry={}},c.Map.prototype={put:function(a,b){this.containsKey(a)||(this.mapSize=this.mapSize+1),this.entry[a]=b},get:function(a){var b=null;return this.containsKey(a)&&(b=this.entry[a]),b},remove:function(a){var b=!1;return this.containsKey(a)&&delete this.entry[a]&&(b=!0,this.mapSize=this.mapSize-1),b},clear:function(){for(var a in this.entry)delete this.entry[a];this.mapSize=0},containsKey:function(a){var b=!1;return a in this.entry&&(b=!0),b},containsValue:function(a){for(var b in this.entry)if(this.entry[b]===a)return!0;return!1},values:function(){var a=[];for(var b in this.entry)this.entry.hasOwnProperty(b)&&a.push(this.entry[b]);return a},keys:function(){var a=[];for(var b in this.entry)a.push(b);return a},size:function(){return this.mapSize}},c.Queue=function(){var a=[],b=0;this.toJSON=function(){var c={array:a,offset:b};return c},this.length=function(){return a.length-b},this.enqueue=function(b){a.push(b)},this.dequeue=function(){if(0===a.length)return null;var c=a[b];return 2*++b>=a.length&&(a=a.slice(b),b=0),c},this.peek=function(){return a.length>0?a[b]:null}},a.Map=c.Map,a}(cloud||{}),cloud=function(a){var b=a._private=a._private||{},c=b.wscUtils=b.wscUtils||{},d=b.wscConst,e=console,f=null,g=d.LOGLEVEL.WARN,h="";return c.setLogger=function(a){e=a,c.AspectConfig.aspectClassMap.clear(),c.initAspectConfig()},c.getLogger=function(){return f},c.setLogLevel=function(a){g=a},c.getLogLevel=function(){return g},c.setsessionid=function(a){h=a},c.printTimeStr=function(a){var b,c=new Date;return b=a?c.getDateStr(a):c.getDateStr(),b+" "},Date.prototype.getDateStr=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};a||(a="yyyy-MM-dd hh:mm:ss"),/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},c.waveFunc=function(a,b){if(b){if(b.prototype){var d=function(){};d.prototype=b.prototype;var e=a.prototype;a.prototype=new d,e&&c.deepCopy(e,a.prototype),a.prototype.constructor=a}if(b.prototype)a.superclass=b.prototype,a.superclass.constructor=b;else{for(var f in b)"object"==typeof b&&"error"!=f&&"warn"!=f&&"log"!=f&&"info"!=f&&"debug"!=f?a[f]=function(a){return function(){b[a](arguments[0])}}(f):a[f]=b[f];a.superclass=b,a.prototype=void 0}}},c.AspectConfig={},c.getCaller_line=function(){var a=null;try{a=(new Error).stack.split("\n")[4],a.indexOf("Error")>=0&&(a=null)}catch(a){}return a},c.isDebugEnabled=function(){var a=!1;if(g===d.LOGLEVEL.DEBUG&&(a=!0),a&&e){var b=c.getCaller_line();if(b=b?"Debug line:"+b:"Debug:",b.indexOf("tmpProxyClass")>0)return!0;e.debug(c.printTimeStr()+"[wsc "+b+"]")}return a},c.isInfoEnabled=function(){var a=!1;return g<=d.LOGLEVEL.INFO&&(a=!0),a&&e&&e.info(c.printTimeStr()+"[wsc Info]:"),a},c.isWarnEnabled=function(){var a=!1;if(g<=d.LOGLEVEL.WARN&&(a=!0),a&&e){var b=c.getCaller_line();if(b=b?"Warn line:"+b:"Warn:",b.indexOf("tmpProxyClass")>0)return!0;e.warn(c.printTimeStr()+"[wsc "+b+"]")}return a},c.isErrorEnabled=function(){var a=!1;if(g<=d.LOGLEVEL.ERROR&&(a=!0),a&&e){var b=null;if(b=c.getCaller_line(),b=b?"Error line:"+b:"Error:",b.indexOf("tmpProxyClass")>0)return!0}return a},c.AspectConfig.aspectClassMap=new c.Map,d.WAVETYPE={BEFORE:"before",AFTER:"after",AFTERRETURN:"afterReturn",AFTERTHROW:"afterThrow"},c.AspectConfig.wavePointcut=function(a,b,g,h){var i,j,k=c.AspectConfig.aspectClassMap.get(a);null==k?(k=function(){k.superclass&&k.superclass.prototype&&k.superclass.constructor.apply(this,arguments)},c.waveFunc(k,a),j=k):(i=function(){i.superclass&&i.superclass.prototype&&i.superclass.constructor.apply(this,arguments)},c.waveFunc(i,k),j=i);var l,m=b.indexOf("*"),n=!1;m>=0&&(l=m>0?new RegExp("^"+b.substr(0,m)):new RegExp(b.substr(1)+"$"));var o=function(c){var d=null,e=j;f.superclass&&(e=f.superclass);try{for(;e.superclass;)e=e.superclass;d=e[b]?e[b].apply(e,c):a[b].apply(a,c)}catch(a){f.warn(a)}return d};if(a.prototype){if(a.prototype[b]){switch(h){case d.WAVETYPE.BEFORE:j.prototype[b]=function(){var a=!1,c=null;try{a=g(arguments)}catch(a){throw a}if(a&&(c=j.superclass[b].apply(this,arguments),null!==c&&void 0!==c))return c};break;case d.WAVETYPE.AFTER:j.prototype[b]=function(){var a=null;try{a=j.superclass[b].apply(this,arguments)}catch(a){throw e.error(b+" exception:"+a),a}if(g(arguments),null!==a&&void 0!==a)return a};break;case d.WAVETYPE.AFTERRETURN:j.prototype[b]=function(){var a=null;if(a=j.superclass[b].apply(this,arguments),g(arguments),null!==a&&void 0!==a)return a};break;case d.WAVETYPE.AFTERTHROW:j.prototype[b]=function(){var a=null;try{if(a=j.superclass[b].apply(this,arguments),null!==a&&void 0!==a)return a}catch(a){g(b,a)}}}n=!0}else if(m>=0)for(var p in a.prototype)if(l.test(p)){switch(h){case d.WAVETYPE.BEFORE:j.prototype[p]=function(){var a=!1,b=null;try{a=g(arguments)}catch(a){throw a}if(a&&(b=j.superclass[p].apply(this,arguments),null!==b&&void 0!==b))return b};break;case d.WAVETYPE.AFTER:j.prototype[p]=function(){var a=null;try{a=j.superclass[p].apply(this,arguments)}catch(a){throw e.error(p+" exception:"+a),a}if(g(arguments),null!==a&&void 0!==a)return a};break;case d.WAVETYPE.AFTERRETURN:j.prototype[p]=function(){var a=null;if(a=j.superclass[p].apply(this,arguments),g(arguments),null!==a&&void 0!==a)return a};break;case d.WAVETYPE.AFTERTHROW:j.prototype[p]=function(){var a=null;try{if(a=j.superclass[p].apply(this,arguments),null!==a&&void 0!==a)return a}catch(a){g(p,a)}}}n=!0}}else if(a[b]){switch(h){case d.WAVETYPE.BEFORE:j[b]=function(){var a=g(arguments);if(a){var b=o(arguments);if(null!==b&&void 0!==b)return b}};break;case d.WAVETYPE.AFTER:j[b]=function(){try{var a=o(arguments)}catch(a){e.error(b+" exception:"+a)}if(g(arguments),null!==a&&void 0!==a)return a};break;case d.WAVETYPE.AFTERRETURN:j[b]=function(){var a=o(arguments);if(g(arguments),null!==a&&void 0!==a)return a};break;case d.WAVETYPE.AFTERTHROW:j[b]=function(){try{var a=o(arguments);if(null!==a&&void 0!==a)return a}catch(a){g(b,a)}}}n=!0}else if(m>=0)for(var p in a)if(l.test(p)){switch(h){case d.WAVETYPE.BEFORE:j[p]=function(){var a=g(arguments);if(a){var b=o(arguments);if(null!==b&&void 0!==b)return b}};break;case d.WAVETYPE.AFTER:j[p]=function(){try{var a=o(arguments);if(null!==a&&void 0!==a)return a}catch(a){e.error(p+" exception:"+a)}return g(arguments),a};break;case d.WAVETYPE.AFTERRETURN:j[p]=function(){var a=o(arguments);if(g(arguments),null!==a&&void 0!==a)return a};break;case d.WAVETYPE.AFTERTHROW:j[p]=function(){try{var a=o(arguments);if(null!==a&&void 0!==a)return a}catch(a){g(p,a)}}}n=!0}n&&c.AspectConfig.aspectClassMap.put(a,j)},c.AspectConfig.before=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.BEFORE)},c.AspectConfig.after=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.AFTER)},c.AspectConfig.afterReturn=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.AFTERRETURN)},c.AspectConfig.afterThrow=function(a,b,e){c.AspectConfig.wavePointcut(a,b,e,d.WAVETYPE.AFTERTHROW)},c.AspectConfig.getWavedObject=function(a){var b=c.AspectConfig.aspectClassMap.get(a),d=null;return b||(b=a),d=new b},c.AspectConfig.getWavedClass=function(a){var b=c.AspectConfig.aspectClassMap.get(a);return b||(b=a),b},c.initAspectConfig=function(){e?(c.AspectConfig.before(e,"info",c.isInfoEnabled),c.AspectConfig.before(e,"debug",c.isDebugEnabled),c.AspectConfig.before(e,"warn",c.isWarnEnabled),c.AspectConfig.before(e,"error",c.isErrorEnabled),c.AspectConfig.before(e,"log",c.isInfoEnabled),f=c.AspectConfig.getWavedClass(e)):(e={},f=e),f.info||(f.info=function(){},e.info=function(){}),f.debug||(f.debug=function(){},e.debug=function(){}),f.warn||(f.warn=function(){},e.warn=function(){}),f.error||(f.error=function(){},e.error=function(){}),f.log||(f.log=function(){},e.log=function(){})},c.initAspectConfig(),a.setLogLevel=c.setLogLevel,a.getLogLevel=c.getLogLevel,a.setLogger=c.setLogger,a.getLogger=c.getLogger,a}(cloud||{}),cloud=function(a){function b(a){var b=!1;if("undefined"==typeof t)return Promise.reject("Audio context is not supported.");var d=function(d){var e=[],f=[];return d.forEach(function(b){b.kind===a&&e.push(b)}),0==e.length?Promise.resolve({available:!1,details:f}):u(e,function(a){return new c(a).test().then(function(a){return f.push(a),b=b||a.available,{available:b,details:f}})}).catch(function(a){return q.debug(a),Promise.resolve({available:!1,details:[]})})};return navigator.mediaDevices.enumerateDevices().then(d).catch(function(a){return q.debug("Device selection is not supported",a),Promise.resolve({available:!1,details:[]})})}function c(a){this.sourceInfo=a;var b,c,d,e,f={},g=6,h=10,i=[],j=0,k=this;for(c=g;c--;)i[c]=[];this.test=function(){f.sourceId=this.sourceInfo.deviceId,f.label=this.sourceInfo.label;var a;return a=new Promise(function(a,c){k.resolve=a,k.reject=c;var h={audio:{optional:[{echoCancellation:!1},{sourceId:k.sourceInfo.deviceId}]}};r(h,function(c){var h=2,i=0;return b=c,c.getAudioTracks().length<1?(q.warn("There is not audio track in the stream."),f.available=!1,void a(f)):(d=t.createMediaStreamSource(c),e=t.createScriptProcessor(i,g,h),d&&e?(d.connect(e),e.connect(t.destination),e.onaudioprocess=l,void 0):(q.warn("AudioStreamSource or ScriptProcessor is invalid."),f.available=!1,void a(f)))},c)})};var l=function(a){var g,h,l,n=a.inputBuffer.length,o=a.inputBuffer.numberOfChannels,p=a.inputBuffer.sampleRate,q=2;for(g=0;g<o;g++)h=a.inputBuffer.getChannelData(g),l=new Float32Array(n),l.set(h),i[g].push(l);if(j+=n,j/p>=q){var r=b.getAudioTracks();for(c=r.length;c--;)r[c].stop();d.disconnect(e),e.disconnect(t.destination),m(i),k.resolve(f)}},m=function(a){var b=[];if(a.forEach(function(a,c){n(a)&&b.push(c)}),b.length>0?(f.available=!0,q.debug(b.length+" active audio input channels are found")):(f.available=!1,q.warn("Can not detect any active input channels. Please check if microphone is valid.")),f.channelNumber=b.length,2===b.length){for(var c=a[b[0]],d=a[b[1]],e=1/65536,g=0,h=c.length;g<h;g++){var i=c[g],j=d[g];if(i.length!==j.length)return f.isStereo=!0,void q.info("Microphone might be stero.");for(var k=0;k<i.length;k++)if(Math.abs(i[k]-j[k])>e)return f.isStereo=!0,void q.info("Microphone might be stero.")}f.isStereo=!1,q.info("Microphone might be mono.")}},n=function(a){for(var b=1/32767,c=0,d=a.length;c<d;c++){var e=a[c];if(e.length>0)for(var f=0,g=0;g<e.length;g++)if(Math.abs(e[g])>b){if(f+=1,f>h)return!0}else f=0}return!1}}function d(a){this.sourceInfo=a;var b={};this.test=function(){var a=[],d=this;return b.sourceId=this.sourceInfo.deviceId,b.label=this.sourceInfo.label,u(w,function(e){var f={audio:!1,video:{mandatory:{minWidth:e.width,minHeight:e.height,maxWidth:e.width,maxHeight:e.height},optional:[{sourceId:d.sourceInfo.deviceId}]}};return c(f).then(function(c){return c&&(c.getVideoTracks()[0].stop(),a.push(e.width+"x"+e.height)),b.availableResolutions=a,a.length>0&&(b.available=!0),b})}).catch(function(a){q.debug(a)})};var c=function(a){return new Promise(function(b,c){r(a,b,function(a){q.warn("getUserMedia error when check resolution of camera",a),b()})})}}function e(a,b,c,d){this.turnURI=a,this.username=b,this.password=c,this.protocol=d;var e=function(a){q.debug("dumbFunc: ",a)};this.test=function(){if(!this.turnURI||!this.username||!this.password)return Promise.reject("TURN URI, username and password are required");if("string"!=typeof this.turnURI||"string"!=typeof this.username||"string"!=typeof this.password)return Promise.reject("TURN URI, username and password must be string type");var a={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};f(a,d);var b={iceServers:[a]};return new Promise(function(a,c){var d;try{var f={};q.debug("Constraints used for peerConnection: "+JSON.stringify(f)),d=new RTCPeerConnection(b,f)}catch(b){return q.error("Fail to create peer connection: "+b),void a(!1)}d.onicecandidate=function(b){if("closed"===d.signalingState)return void a(!1);if(!b.candidate)return d.close(),q.warn("No relay candidate is got before end of candidates"),void a(!1);var c=v(b.candidate.candidate);return"relay"===c.type?(q.info("Got a relay candidate",b.candidate),d.close(),void a(!0)):void q.debug("Got a non-relay candidate",b.candidate)};var g={offerToReceiveAudio:1};d.createOffer(function(a){q.debug("got offer: ",a),d.setLocalDescription(a,e,e)},e,g)})};var f=function(a,b){for(var c="transport="+b,d=[],e=0;e<a.urls.length;e++){var f=a.urls[e];f.indexOf(c)!==-1?d.push(f):f.indexOf("?transport=")===-1&&"turn"===f.slice(0,4)&&d.push(f+"?"+c)}a.urls=d}}function f(a,b,c){this.turnURI=a,this.username=b,this.password=c,this.test=function(){var a={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")},b={iceServers:[a]};return new Promise(function(a,c){var d,e=function(b,c){q.warn(c),b.end(),a(0)},f=new m(b,e),g=3,h=null,i=0,j=0,k=!1,l="",n=100,o=null,p=null;l="12345";for(var r=5,s=0;s<r;s++)l+=l+l;d=l.length*n,p=f.pc1.createDataChannel(null),p.onopen=function(){h||(h=new Date);var a=function(){for(var b=0;b!==n&&!(p.bufferedAmount>=d);++b)i+=l.length,p.send(l);new Date-h>=1e3*g?k=!0:setTimeout(a,1)};a()},f.pc2.ondatachannel=function(b){o=b.channel,o.onmessage=function(b){if(j+=b.data.length,k&&i===j){f.end();var c=j/(new Date-h);c=Math.round(1e3*c*8)/1e3,f.end(),a(c)}}},f.start()})}}function g(a,b,c){this.turnURI=a,this.username=b,this.password=c,this.testResult={}}function h(a,b,c){"undefined"!=typeof t&&"undefined"!=typeof t.createScriptProcessor||c&&c("Audio context is not supported.");var d=function(a){var c,d={available:!1,details:[]};c=a.filter(function(a){return"audioinput"===a.kind}),0==c.length&&b(d);var e=function(a,c,d){this.available=this.available||d.available,this.details.push(d),a&&c?a.test(c):b(this)},f=c.map(function(a){return new i(a)}),g=f.shift(),h=f.reverse().reduce(function(a,b){return e.bind(d,b,a)},e.bind(d,null,null));g.test(h)};"undefined"!=typeof navigator.mediaDevices&&"undefined"!=typeof navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(d).catch(function(a){q.debug("Device selection is not supported",a),b&&b({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&"undefined"!=typeof MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(a){d(a.map(function(a){return{label:a.label,kind:kinds[a.kind],deviceId:a.id,groupId:""}}))}):c("Devices cannot be enumerated.")}function i(a){this.sourceInfo=a;var b,c,d,e,f={},g=6,h=10,i=[],j=0;for(c=g;c--;)i[c]=[];this.test=function(a){f.sourceId=this.sourceInfo.deviceId,f.label=this.sourceInfo.label;var c={audio:{optional:[{echoCancellation:!1},{sourceId:this.sourceInfo.deviceId}]}};r(c,function(c){var h=2,i=0;return b=c,c.getAudioTracks().length<1?(q.warn("There is not audio track in the stream."),f.available=!1,void a(f)):(d=t.createMediaStreamSource(c),e=t.createScriptProcessor(i,g,h),d&&e?(d.connect(e),e.connect(t.destination),e.onaudioprocess=k.bind(null,a),void 0):(q.warn("AudioStreamSource or ScriptProcessor is invalid."),f.available=!1,void a(f)))},function(){f.available=!1,a(f)})};var k=function(a,g){var h,k,m,n=g.inputBuffer.length,o=g.inputBuffer.numberOfChannels,p=g.inputBuffer.sampleRate,q=2;
for(h=0;h<o;h++)k=g.inputBuffer.getChannelData(h),m=new Float32Array(n),m.set(k),i[h].push(m);if(j+=n,j/p>=q){var r=b.getAudioTracks();for(c=r.length;c--;)r[c].stop();d.disconnect(e),e.disconnect(t.destination),l(i),a(f)}},l=function(a){var b=[];if(a.forEach(function(a,c){m(a)&&b.push(c)}),b.length>0?(f.available=!0,q.debug(b.length+" active audio input channels are found")):(f.available=!1,q.warn("Can not detect any active input channels. Please check if microphone is valid.")),f.channelNumber=b.length,2===b.length){for(var c=a[b[0]],d=a[b[1]],e=1/65536,g=0,h=c.length;g<h;g++){var i=c[g],j=d[g];if(i.length!==j.length)return f.isStereo=!0,void q.info("Microphone might be stero.");for(var k=0;k<i.length;k++)if(Math.abs(i[k]-j[k])>e)return f.isStereo=!0,void q.info("Microphone might be stero.")}f.isStereo=!1,q.info("Microphone might be mono.")}},m=function(a){for(var b=1/32767,c=0,d=a.length;c<d;c++){var e=a[c];if(e.length>0)for(var f=0,g=0;g<e.length;g++)if(Math.abs(e[g])>b){if(f+=1,f>h)return!0}else f=0}return!1}}function j(a){this.sourceInfo=a;var b={};this.test=function(a){b.sourceId=this.sourceInfo.deviceId,b.label=this.sourceInfo.label,b.availableResolutions=[];var c=function(c,d,e){e&&(e.getVideoTracks()[0].stop(),b.availableResolutions.push(c.video.mandatory.minWidth+"x"+c.video.mandatory.minHeight)),d?d():(b.available=b.availableResolutions.length>0,a(b))},d=function(c,d){q.warn("getUserMedia error when check resolution of camera",d),c?c():(b.available=b.availableResolutions.length>0,a(b))},e=w.map(function(a){return{audio:!1,video:{mandatory:{minWidth:a.width,minHeight:a.height,maxWidth:a.width,maxHeight:a.height},optional:[{sourceId:b.sourceId}]}}}),f=e.reverse().shift(),g=e.reduce(function(a,b){return r.bind(null,b,c.bind(null,b,a),d.bind(null,a))},r.bind(null,f,c.bind(null,f,null),d.bind(null,null)));g()}}function k(a,b,c,d){this.turnURI=a,this.username=b,this.password=c,this.protocol=d;var e=function(a){q.debug("dumbFunc: ",a)};this.test=function(a){var b={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};f(b,d);var c,g={iceServers:[b]};try{var h={};q.debug("Constraints used for peerConnection: "+JSON.stringify(h)),c=new RTCPeerConnection(g,h)}catch(b){return q.error("Fail to create peer connection: "+b),void a(!1)}c.onicecandidate=function(b){if("closed"===c.signalingState)return void a(!1);if(!b.candidate)return c.close(),q.warn("No relay candidate is got before end of candidates"),void a(!1);var d=v(b.candidate.candidate);return"relay"===d.type?(q.info("Got a relay candidate",b.candidate),c.close(),void a(!0)):void q.debug("Got a non-relay candidate",b.candidate)};var i={offerToReceiveAudio:1};c.createOffer(function(a){q.debug("got offer: ",a),c.setLocalDescription(a,e,e)},e,i)};var f=function(a,b){for(var c="transport="+b,d=[],e=0;e<a.urls.length;e++){var f=a.urls[e];f.indexOf(c)!==-1?d.push(f):f.indexOf("?transport=")===-1&&"turn"===f.slice(0,4)&&d.push(f+"?"+c)}a.urls=d}}function l(a,b,c){this.turnURI=a,this.username=b,this.password=c,this.testResult={}}function m(a,b){var c={};q.debug("Constraints used for peerConnection: "+JSON.stringify(c)),this.pc1=new RTCPeerConnection(a,c),this.pc2=new RTCPeerConnection(a,c);var d,e=this.pc1,f=this.pc2,g=!1,h=!1,i=this,j=function(a,c){a.candidate?"relay"===v(a.candidate.candidate).type&&(c.addIceCandidate(a.candidate),h=!0):h||b(i,"No relay candidate is got before end of candidates")};e.onicecandidate=function(a){j(a,f)},f.onicecandidate=function(a){j(a,e)};var k=function(a){q.debug("offer answer",a),b(i,a)};this.start=function(){e.createOffer(function(a){if(g){var b=a.sdp;b=b.replace(/(m=video 1 [^\r]+) 116 117\r\n/g,function(a,b){return b.trim()+"\r\n"}),b=b.split(/a=rtpmap:116 red\/90000\r\n/g).join(""),b=b.split(/a=rtpmap:117 ulpfec\/90000\r\n/g).join(""),b=b.split(/a=rtpmap:98 rtx\/90000\r\n/g).join(""),b=b.split(/a=fmtp:98 apt=116\r\n/g).join(""),a.sdp=b}e.setLocalDescription(a,function(){f.setRemoteDescription(a,function(){f.createAnswer(function(a){g&&(a.sdp=a.sdp.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+d+"\r\n")),f.setLocalDescription(a,function(){e.setRemoteDescription(a)},k)},k)},k)},k)},k)},this.end=function(){"closed"!=this.pc1.signalingState&&this.pc1.close(),"closed"!=this.pc2.signalingState&&this.pc2.close()},this.setMaxVideoBitRate=function(a){d=a},this.disableVideoFec=function(){g=!0}}var n=a._private=a._private||{},o=n.wscUtils=n.wscUtils||{},p=n.wscConst,q=a.getLogger(),r=navigator.getUserMedia;try{var s=window.AudioContext||window.webkitAudioContext,t=new s}catch(a){q.debug("Failed to instantiate an audio context, error: "+a)}window.msCrypto&&(window.crypto=window.msCrypto),"function"!=typeof Array.prototype.find&&(Array.prototype.find=function(a){"use strict";if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;f<d;f++)if(b=c[f],a.call(e,b,f,c))return b});var u=function(a,b){return a.reduce(function(a,c){return a.then(function(){return b(c)})},Promise.resolve())},v=function(a){var b=a.split(/\s+/);return b.length>7?{type:b[7],protocol:b[2],address:b[4]}:{}},w=[{label:"720p",width:1280,height:720,ratio:"16:9"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p",width:640,height:360,ratio:"16:9"}];if(o.Message=function(a){"use strict";if(this.control={type:void 0,package_type:void 0,session_id:void 0,subsession_id:void 0,sequence:void 0,message_state:void 0,correlation_id:void 0,ack_sequence:void 0,version:void 0},this.header={action:void 0,initiator:void 0,target:void 0,error_code:void 0,reason:void 0,participant:void 0,conversation_key:void 0,instruction:void 0,conversation_topic:void 0,recording_channel:void 0,web_context:void 0,conversation_info:void 0,stream_id:void 0,stream_type:void 0},this.payload={},a){"string"==typeof a&&(a=JSON.parse(a));for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])}},o.Message.systemHeaders={action:"action",initiator:"initiator",target:"target",cslr:"cslr",cslw:"cslw",csuw:"csuw",sslr:"sslr",error_code:"error_code",response_code:"response_code",reason:"reason",participant:"participant",enquiry_data:"enquiry_data",authorization:"authorization",authenticate:"authenticate",expiry:"expiry",participants:"participants",conversation_key:"conversation_key",instruction:"instruction",conversation_topic:"conversation_topic",recording_channel:"recording_channel",web_context:"web_context",conversation_info:"conversation_info",stream_id:"stream_id",stream_type:"stream_type"},o.Message.prototype={isRequest:function(){var a=this.control.type;return a===p.TYPE.REQUEST},isResponse:function(){var a=this.control.type;return a===p.TYPE.RESPONSE},isEnquiry:function(){var a=this.header.action;return a===p.ACTION.ENQUIRY},isModify:function(){var a=this.header.action;return a===p.ACTION.MODIFY},isFinalResponse:function(){var a=this.control.type,b=this.control.message_state;return a===p.TYPE.RESPONSE&&b===p.MESSAGESTATE.FINAL},isError:function(){var a=this.control.type;return a===p.TYPE.ERROR},isMessage:function(){var a=this.control.type;return a===p.TYPE.MESSAGE},isReliableRelay:function(){var a=this.header.action;return a===p.ACTION.RELIABLE_RELAY},isACK:function(){var a=this.control.type;return a===p.TYPE.ACK},isReconnect:function(){var a=this.control.package_type,b=this.control.session_id,c=this.header.action;return!(a!==p.PACKAGE.REGISTER||!b||c!==p.ACTION.CONNECT)},ack:function(a){var b=new o.Message;b.control.session_id=this.control.session_id,b.control.subsession_id=this.control.subsession_id,b.control.type=p.TYPE.ACK,b.control.package_type=this.control.package_type,b.control.sequence=this.control.sequence,a.sendMessage(b)},complete:function(a){var b=new o.Message;b.control.session_id=this.control.session_id,b.control.subsession_id=this.control.subsession_id,b.control.correlation_id=this.control.correlation_id,b.control.type=p.TYPE.MESSAGE,b.control.package_type=this.control.package_type,b.header.action=p.ACTION.COMPLETE,b.header.stream_id=this.header.stream_id,b.header.stream_type=this.header.stream_type,a.sendMessage(b)},addExtHeaders:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];this.header[b]||(this.header[b]=c)}},getExtHeaders:function(){var a;if(this.header)for(var b in this.header)if(this.header.hasOwnProperty(b)){if(o.Message.systemHeaders[b])continue;a||(a={}),a[b]=this.header[b]}return a},addExtPayloads:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];this.payload[b]||(this.payload[b]=c)}}},o.ErrorInfo=function(a,b){this.code=a,this.reason=b},o.wscLoginWithOAuthToken=function(a,b,c,d,e){var f=d+"?oauth_token="+a+"&final_redirect_uri="+b+"&wsc_app_uri="+e;if(q.debug("Login WebRTC Session Controller by OAuth token to destination -> "+f),!c){var g="The parameter loginWindowType is required.";throw q.error(g),g}"current_window"===c?window.location.href=f:"new_window"===c&&window.open(f,"Wsc Login","width=500,height=500,left=200,top=100")},o.AuthHandler=function(a){"use strict";this.session=a,a.authHandler=this,this.refresh=null,this.toJSON=function(){var a={session:""};return o.toJSON(a,this)}},o.checkAuthInfo=function(a,b){var c=!1;if(a===p.AUTHTYPE.SERVICE){if(!b)return!1;c=!0}else if(a===p.AUTHTYPE.TURN){if(!b)return!0;null!=b.iceServers&&(c=!0)}return c},o.getRTCConfiguration=function(a){var b,c=a.authHandler,d=0,e=null,f=!0;if(c&&c.refresh)for(;f&&d<3;){d++;try{if(e=c.refresh(p.AUTHTYPE.TURN),o.checkAuthInfo(p.AUTHTYPE.TURN,e))break;if(e===!1){b="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",q.warn(b),f=!1;break}b="No correct information was return from the callback function 'AuthHandler.refresh()'. Please try again.",q.warn(b)}catch(a){q.error("Handle unauthenticated message error: "+a),f=!1}}else q.warn("No AuthHandler object created for this Session, or this AuthHandler does not have the callback function 'AuthHandler.refresh()'."),f=!1;if(f===!1&&(e=null),e||(e={iceServers:[],iceTransportPolicy:"all"}),a.iceServerListFromServer){var g=a.iceServerListFromServer.concat(e.iceServers);e.iceServers=g}return e},o.calcHa1=function(a,b){var c="";return b.algorithm&&"md5"!==b.algorithm.toLowerCase()||(c=n.DigestUtils.getHA1(a.username,b.realm,a.password)),c},o.extend=function(a,b){var c=function(){};c.prototype=b.prototype;var d=a.prototype;a.prototype=new c,d&&o.deepCopy(d,a.prototype),a.prototype.constructor=a,a.superclass=b.prototype,a.superclass&&(a.superclass.constructor=b)},o.deepCopy=function(a,b){b=b||{};for(var c in a)"object"==typeof a[c]?(b[c]=a[c].constructor===Array?[]:{},o.deepCopy(a[c],b[c])):b[c]=a[c];return b},o.toJSON=function(a,b){var c={};for(var d in b)d in a||(c[d]=b[d]);return c},o.testBrowser=function(){var a,b,c,d,e,f,g,h=!1;return n.browser.isChrome&&(b="Chrome",h=!0,c=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),d=void 0,e=void 0),n.browser.isFirefox&&(b="Firefox",h=!0,c=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),d=void 0,e=void 0),navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&(b="Edge",h=!0,c=parseInt(navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)[2],10),d=void 0,e=void 0),n.browser.isIE&&(b="IE",h=!1,c=parseInt(navigator.userAgent.match(/rv\:([0-9]+)\./)[1],10),d=void 0,e=void 0),n.browser.isSafari&&(b="Safari",h=!1,c=parseInt(navigator.userAgent.match(/Safari\/([0-9]+)\./)[1],10),d=void 0,e=void 0),g=n.browser.supportSessionStorage,f="WebSocket"in window,a=h&&f&&g,{compatible:a,details:{browserName:b,browserVersion:c,supportedMinimumVersion:d,supportedMaximumVersion:e,supportWebRTC:h,supportWebSocket:f,supportSessionStorage:g}}},o.testMicrophone=function(){return b("audioinput")},o.testAudio=function(){return b("audiooutput")},o.testCamera=function(){var a=!1,b=function(b){var c=[],e=[];return b.forEach(function(a){"videoinput"===a.kind&&c.push(a)}),0==c.length?Promise.resolve({available:!1,details:e}):u(c,function(b){return new d(b).test().then(function(b){return e.push(b),a=a||b.available,{available:a,details:e}})}).catch(function(a){return q.debug(a),Promise.resolve({available:!1,details:[]})})};return navigator.mediaDevices.enumerateDevices().then(b).catch(function(a){return q.debug("Device selection is not supported",a),Promise.resolve({available:!1,details:[]})})},o.testNetwork=function(a,b,c){var d={};return d.details={},new e(a,b,c,"udp").test().then(function(f){return q.debug("udp connectivity test..."),d.details.udpConnectivity=f,new e(a,b,c,"tcp").test()}).then(function(e){return q.debug("tcp connectivity test..."),d.details.tcpConnectivity=e,new f(a,b,c).test()}).then(function(e){return q.debug("data channel connectivity test..."),d.details.dataThroughput=e,new g(a,b,c).test()}).then(function(a){return q.debug("video bandwidth connectivity test..."),d.details.videoBandwidth=a,d.connectivity=(d.details.udpConnectivity||d.details.tcpConnectivity)&&d.details.dataThroughput>0&&d.details.videoBandwidth>0,d}).catch(function(a){return q.error("Error happens when test network. ",a),Promise.reject(a)})},g.prototype={test:function(){var a={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")},b={iceServers:[a]};return new Promise(function(a,c){function d(b){n.pc1.addStream(b),n.start(),j=setTimeout(function(){s(),null==k&&(k=setTimeout(function(){p();var b=-1;i>0&&(b=Math.round(h/i)),a(b)},f))},2e3)}var e=2e3,f=4e4,g=1e3,h=0,i=0,j=null,k=null,l=function(b,c){q.warn(c),p(),a(-1)},n=new m(b,l);n.setMaxVideoBitRate(e),n.disableVideoFec();var o={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};r(o,d,function(b){q.warn("getUserMedia error when testing video bandwidth",b),a(-1)});var p=function(){if(j&&clearTimeout(j),k&&clearTimeout(k),n&&n.pc1){var a=n.pc1.getLocalStreams();a.length>0&&a[0].getTracks().forEach(function(a){a.stop()}),n.end()}},s=function(){n.pc1.getStats(null,function(b){var c;for(var d in b){var e=b[d];if("bweforvideo"===e.id){c=e.googAvailableSendBandwidth/1e3;break}}void 0==c?(q.warn("Cannot get bandwidth from getStats()."),p(),a(-1)):(h+=c,i+=1)},function(b){q.warn("Error when get statistics.",b),p(),a(-1)}),j=setTimeout(s,g)}})}},o.testMicrophoneCallback=function(a,b){return h("audioinput",a,b)},o.testAudioCallback=function(a,b){return h("audiooutput",a,b)},o.testCameraCallback=function(a,b){var c=function(b){var c,d={available:!1,details:[]};c=b.filter(function(a){return"videoinput"===a.kind}),0==c.length&&a(d);var e=function(b,c,d){this.available=this.available||d.available,this.details.push(d),b&&c?b.test(c):a(this)},f=c.map(function(a){return new j(a)}),g=f.shift(),h=f.reverse().reduce(function(a,b){return e.bind(d,b,a)},e.bind(d,null,null));g.test(h)};"undefined"!=typeof navigator.mediaDevices&&"undefined"!=typeof navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(c).catch(function(b){q.debug("Device selection is not supported",b),a&&a({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&"undefined"!=typeof MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(a){c(a.map(function(a){return{label:a.label,kind:kinds[a.kind],deviceId:a.id,groupId:""}}))}):b("Devices cannot be enumerated.")},o.testNetworkCallback=function(a,b,c,d,e){a&&b&&c||e("TURN URI, username and password are required"),"string"==typeof a&&"string"==typeof b&&"string"==typeof c||e("TURN URI, username and password must be string type");var f={},g=3,h=[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}],i={iceServers:h};f.connectivity=!1,f.details={},new k(a,b,c,"udp").test(function(e){q.debug("udp connectivity test...Done"),f.details.udpConnectivity=e,new k(a,b,c,"tcp").test(function(e){q.debug("tcp connectivity test...Done"),f.details.tcpConnectivity=e,new o.DataChannelThroughput_CallbackBased(i,g).test(function(e){q.debug("data channel connectivity test...Done"),f.details.dataThroughput=e,new l(a,b,c).test(function(a){q.debug("video bandwidth connectivity test...Done"),f.details.videoBandwidth=a,f.connectivity=(f.details.udpConnectivity||f.details.tcpConnectivity)&&f.details.dataThroughput>0&&f.details.videoBandwidth>0,d(f)})})})})},o.DataChannelThroughput_CallbackBased=function(a,b){this.test=function(c,d){var e,f,g,h=function(a,b){q.warn("No relay candidate is got before end of candidates"),a.end(),"function"==typeof c&&c(0),"function"==typeof d&&d(b)},i=new m(a,h),j=null,k=0,l=0,n=!1,p="12345678",r=null,s=null;if(!o.__throughputPayloadData__){o.__throughputPayloadData__="";for(var t=128,u=0;u<t;u++)o.__throughputPayloadData__+=p}s=i.pc1.createDataChannel(null),s.onopen=function(){e&&clearTimeout(e),j||(j=new Date);var a=function(){s.bufferedAmount<o.__throughputPayloadData__.length&&(k+=o.__throughputPayloadData__.length,s.send(o.__throughputPayloadData__)),new Date-j>=1e3*b?n=!0:g=setTimeout(a,1)};a(),f=setTimeout(function(){q.debug("Timeout for network status detection, interrupt it and get throughput"),v()},1e3*b+500)};var v=function(){clearTimeout(g),i.end();var a=Math.round(8*l/(new Date-j));q.debug("Network status detection succeeds. The throughput is: "+a+" kbps"),"function"==typeof c&&c(a)};i.pc2.ondatachannel=function(a){r=a.channel,r.onmessage=function(a){l+=a.data.length,n&&k===l&&(clearTimeout(f),v())}};var w=1e4;e=setTimeout(function(){q.debug("Takes more than "+w+"ms to open the data channel. End the call and invoke error callback"),"function"==typeof d&&(i.end(),d("Takes more than "+w+"ms to open the data channel."))},w),i.start()}},l.prototype={test:function(a){function b(b){n.pc1.addStream(b),n.start(),j=setTimeout(function(){s(),null==k&&(k=setTimeout(function(){p();var b=-1;i>0&&(b=Math.round(h/i)),a(b)},f))},2e3)}var c={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")},d={iceServers:[c]},e=2e3,f=4e4,g=1e3,h=0,i=0,j=null,k=null,l=function(b,c){q.warn(c),p(),a(-1)},n=new m(d,l);n.setMaxVideoBitRate(e),n.disableVideoFec();var o={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};r(o,b,function(b){q.warn("getUserMedia error when testing video bandwidth",b),a(-1)});var p=function(){if(j&&clearTimeout(j),k&&clearTimeout(k),n&&n.pc1){var a=n.pc1.getLocalStreams();a.length>0&&a[0].getTracks().forEach(function(a){a.stop()}),n.end()}},s=function(){n.pc1.getStats(null,function(b){var c;for(var d in b){var e=b[d];if("bweforvideo"===e.id){c=e.googAvailableSendBandwidth/1e3;break}}void 0==c?(q.warn("Cannot get bandwidth from getStats()."),p(),a(-1)):(h+=c,i+=1)},function(b){q.warn("Error when get statistics.",b),p(),a(-1)}),j=setTimeout(s,g)}}},n.browser.isIE){var x=JSON.stringify;JSON.stringify=function(){var a=Array.prototype.slice.call(arguments);return(1===a.length||a.length>1&&(null===a[1]||void 0===a[1]))&&(a[1]=function(a,b){return b&&b.call&&b.apply?void 0:b}),x.apply(this,a)}}return a.extend=o.extend,a.wscLoginWithOAuthToken=o.wscLoginWithOAuthToken,a.Message=o.Message,a.ErrorInfo=o.ErrorInfo,a.AuthHandler=o.AuthHandler,a.testBrowser=o.testBrowser,a.testMicrophone=o.testMicrophone,a.testAudio=o.testAudio,a.testCamera=o.testCamera,a.testNetwork=o.testNetwork,a.testMicrophoneCallback=o.testMicrophoneCallback,a.testAudioCallback=o.testAudioCallback,a.testCameraCallback=o.testCameraCallback,a.testNetworkCallback=o.testNetworkCallback,a}(cloud||{}),cloud=function(a){"use strict";function b(a,b){return r.debug("Browser is: "+JSON.stringify(q,null,2)),(q.isIE||q.isSafari)&&(r.debug("Filtering SDP to remove 'rtcp-fb:* nack' support"),b=b.split("\r\n").filter(function(a){return!a.match(/rtcp-fb:\* nack.*/)}).join("\r\n"),r.debug("Filtering SDP to remove b=AS:0"),b=b.split("\r\n").filter(function(a){return"b=AS:0"!==a}).join("\r\n")),b=b.split("\r\n").map(function(b){var c=b.match(/a=setup:.*/g);return"offer"===a&&c?(r.debug("SDP offer contains: "+c),"a=setup:actpass"!==c[0]?(r.debug("SDP offer should not contain "+c),"a=setup:actpass"):b):b}).join("\r\n")}function c(a,b){var c=b.pkgInstance.videoSendBitrate;return c?(r.debug("Prefer video send bitrate: "+c),e(a,c,"video")):a}function d(a,b){var c=b.pkgInstance.videoRecvBitrate;return c?(r.debug("Prefer video receive bitrate: "+c),e(a,c,"video")):a}function e(a,b,c){var d=a.split("\r\n"),e=l(d,"m=",c);if(null===e)return r.debug("Failed to add bandwidth line to sdp, as no m-line found"),a;var f=m(d,e+1,-1,"m=");null===f&&(f=d.length);var g=m(d,e+1,f,"c=");if(null===g)return r.debug("Failed to add bandwidth line to sdp, as no c-line found"),a;var h=m(d,g+1,f,"b=AS");h&&d.splice(h,1);var i="b=AS:"+b;return d.splice(g+1,0,i),a=d.join("\r\n")}function f(a,b){var c=b.pkgInstance.removeVideoFec;if(!c)return a;r.debug("Removing FEC-related SDP lines (red / ulpfec / rtx)");var d=a.split("\r\n"),e=l(d,"a=rtpmap","red");if(null===e)return a;var f=j(d[e]);if(d=h(d,f),d=g(d,"ulpfec"),e=l(d,"a=fmtp",f.toString()),null===e)return a;var i=k(d[e]),m=i.pt;return null===m?a:(d.splice(e,1),d=h(d,m),d.join("\r\n"))}function g(a,b){var c=l(a,"a=rtpmap",b);if(null===c)return a;var d=j(a[c]);a.splice(c,1);var e=l(a,"m=","video");return null===e?a:(a[e]=i(a[e],d),a)}function h(a,b){var c=l(a,"a=rtpmap",b.toString());if(null===c)return a;a.splice(c,1);var d=l(a,"m=","video");return null===d?a:(a[d]=i(a[d],b),a)}function i(a,b){a=a.split(" ");for(var c=0;c<a.length;++c)a[c]===b.toString()&&a.splice(c,1);return a.join(" ")}function j(a){var b=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),c=a.match(b);return c&&2===c.length?c[1]:null}function k(a){var b={},c=a.indexOf(" "),d=a.substring(c+1).split("; "),e=new RegExp("a=fmtp:(\\d+)"),f=a.match(e);if(!f||2!==f.length)return null;b.pt=f[1];for(var g={},h=0;h<d.length;++h){var i=d[h].split("=");2===i.length&&(g[i[0]]=i[1])}return b.params=g,b}function l(a,b,c){return m(a,0,-1,b,c)}function m(a,b,c,d,e){for(var f=c!==-1?c:a.length,g=b;g<f;++g)if(0===a[g].indexOf(d)&&(!e||a[g].toLowerCase().indexOf(e.toLowerCase())!==-1))return g;return null}var n=a._private=a._private||{},o={},p=n.wscConst,q=n.browser,r=a.getLogger();return o.collectHostIPsByPc=function(a,b){function c(a){if(a.candidate)r.debug("Collected candidate: candidate- "+JSON.stringify(a.candidate));else if(i&&i.localDescription){var c=i.localDescription.sdp;r.debug("Collecting host ips from sdp -"+c);var d=f(c);e(d)}else b()}function d(a){r.error("Create offer error while collect Host IP, "+a);var b=[];e(b)}function e(c){try{i&&(i.close(),i=null),j&&(j.close(),j=null),c.length>0?(r.debug("Collected hostIPs: "+JSON.stringify(c,null,2)),a&&a(c)):b()}catch(a){r.error(a)}}function f(a){for(var b=[],c=a.split("\r\n"),d=0;d<c.length;d++){var e=c[d],f=null;if(e.match(/^c=/i)){var g=e.split(/\s+/);f=g[2]}else if(e.match(/^a=candidate:.*typ host/i)){var h=e.split(/\s+/);f=h[4]}f&&b.indexOf(f)===-1&&b.push(f)}return b}var g=null,h={};r.debug("Constraints used for peerConnection: "+JSON.stringify(h));var i=new window.RTCPeerConnection(g,h),j=new window.RTCPeerConnection(g,h);try{i.onicecandidate=c,i.createDataChannel("");var k=function(a){i&&j&&(i.setLocalDescription(a),j.setRemoteDescription(a),j.createAnswer(function(a){j.setLocalDescription(a),i.setRemoteDescription(a)},function(a){d(a)}))},l=function(a){d(a)};i.createOffer(k,l)}catch(a){r.error("Got exception when trying to get host IPs: "+a);var m=[];e(m)}},o.addCandidatesFromSdp=function(a,b){var c,d=o.getMediaFromSDP(b),e=[],f={},g=d.length,h=0,i=0;for(h=0;h<g;h++)for(e=d[h].candidates,c=e.length,i=0;i<c;i++)f=new RTCIceCandidate({sdpMLineIndex:h,candidate:e[i]}),a.addIceCandidate(f)},o.createPeerConnection=function(b,c){var d,e=null,f=n.wscUtils;try{e=f.getRTCConfiguration(b.session);var g={};g.optional=[{googIPv6:b.pkgInstance.ipv6},{googDscp:b.pkgInstance.dscp}],r.debug("Constraints used for peerConnection: "+JSON.stringify(g)),r.debug("authInfo: "+JSON.stringify(e));var h={};h.start=(new Date).getTime(),b.timeRecording.timeToNewPeerConnection=h,b.collectClientLog(p.LOGTYPE.EVENT_LOG,p.EVENTLOG.ESTABLISH_PEER_CONNECTION_START),d=new window.RTCPeerConnection(e,g),b.collectClientLog(p.LOGTYPE.EVENT_LOG,p.EVENTLOG.ESTABLISH_PEER_CONNECTION_END),b.timeRecording.timeToNewPeerConnection.end=(new Date).getTime();var i=function(a){r.info("Session connecting.")},j=function(a){r.info("Session opened.")},k=function(a){r.info("Remote stream removed."),b.collectClientLog(p.LOGTYPE.EVENT_LOG,p.EVENTLOG.ON_REMOVE_STREAM+":"+a.stream),b.fireMediaStreamEvent(p.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED,a.stream)},l=function(a){r.info("Remote stream added via onAddStream."),b.collectClientLog(p.LOGTYPE.EVENT_LOG,p.EVENTLOG.ON_ADD_STREAM+":"+a.stream),b.timeRecording.timeToGetRemoteMedia.end=(new Date).getTime(),b.fireMediaStreamEvent(p.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED,a.stream),d.___wsc_onaddstream_called=!0};d.onremovestream=k,d.onaddstream=l,d.onconnecting=i,d.onopen=j,b.peerConnection=d,c?o.addLocalStreams(b,c):o.addLocalStream(b),d.onstatechange=function(a){r.debug("iceConnectionState : "+a.currentTarget.iceConnectionState+"\niceGatheringState : "+a.currentTarget.iceGatheringState+"\n")}}catch(c){o.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c),r.error("Create peer connection: "+c)}},o.createNewPeerConnection=function(a){if(a.peerConnection){var b=o.getLocalStreams(a.peerConnection);if(a.temporarySavedStreams=b,b)for(var c=0;c<b.length;c++){var d=b[c];o.removeLocalStream(a,d)}a.peerConnection.close(),a.peerConnection=null}o.createPeerConnection(a)},o.clearPeerConnection=function(a){var b=a.peerConnection,c=0;if(b){var d=o.getLocalStreams(b),e=o.getRemoteStreams(b);if(d)for(c=0;c<d.length;c++){var f=d[c];o.removeLocalStream(a,f)}if(e)for(c=0;c<e.length;c++)q.isFirefox||b.removeStream(e[c]);b.close(),a.peerConnection=null}},o.setLocalDescription=function(b,d,e,g){var h=null,i=null;if(b&&b.peerConnection&&d){e||(e=function(){r.debug("Set localDescription succeed!")}),i=function(){b.timeRecording.timeToGetIceCandidates.start=(new Date).getTime(),e.apply(this,arguments)},h=g?function(c){g(c),o.invokeCallError(b,a.ERRORCODE.SET_LOCAL_SDP_ERROR,c)}:function(c){r.warn("Set local description failed: ",c),o.invokeCallError(b,a.ERRORCODE.SET_LOCAL_SDP_ERROR,c)};var j=b.peerConnection.localDescription;r.debug("iceConnectionState/iceGatheringState is: "+b.getIceConnectionState()+"/"+b.peerConnection.iceGatheringState),d.sdp=c(d.sdp,b),d.sdp=f(d.sdp,b),r.debug("setLocalDescription: type: "+d.type+", sdp: \n"+JSON.stringify(d,null,2)),b.peerConnection.setLocalDescription(d,i,h),b.peerConnection.__wscLastLocalSdp=j}},o.setRemoteDescription=function(c,e,g,h){var i=null;c&&c.peerConnection&&e&&(g||(g=function(){r.debug("Set remote description succeed!")}),i=h?function(b){h(b),o.invokeCallError(c,a.ERRORCODE.SET_REMOTE_SDP_ERROR,b)}:function(b){r.warn("Set remote description failed!",b),c.collectClientLog(p.LOGTYPE.ERROR_LOG,p.ERRORLOG.SET_REMOTE_SDP_ERROR+":"+e),o.invokeCallError(c,a.ERRORCODE.SET_REMOTE_SDP_ERROR,b)},e.sdp=b(e.type,e.sdp),e.sdp=d(e.sdp,c),e.sdp=f(e.sdp,c),r.debug("setRemoteDescription: type: "+e.type+", sdp: \n"+JSON.stringify(e.sdp,null,2)),c.peerConnection.setRemoteDescription(e,g,i))},o.removeLocalStream=function(a,b){b&&(b.peerConnectionNum&&b.peerConnectionNum--,r.debug("removeLocalStream, peerConnectionNum: "+b.peerConnectionNum),q.isFirefox||a.peerConnection.removeStream(b),a.fireMediaStreamEvent(p.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED,b))},o.addLocalStream=function(a,b){var c=a.peerConnection,d=0;if(b){b.peerConnectionNum?b.peerConnectionNum++:b.peerConnectionNum=1,c.addStream(b),r.debug("addLocalStream (video: "+b.getVideoTracks().length+", audio: "+b.getAudioTracks().length+"), peerConnectionNum: "+b.peerConnectionNum,b);var e=!0,f=a.localMediaStreams;for(d=0;d<f.length;d++){var g=f[d];if(g===b){e=!1;break}}e&&a.localMediaStreams.push(b),c.__wscIsAudioStreamAdded||(c.__wscIsAudioStreamAdded=o.streamHasMediaTracks([b],"audio")),c.__wscIsVideoStreamAdded||(c.__wscIsVideoStreamAdded=o.streamHasMediaTracks([b],"video")),a.fireMediaStreamEvent(p.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,b)}else{for(d=0;d<a.temporarySavedStreams.length;d++){var h=a.temporarySavedStreams[d];h.peerConnectionNum?h.peerConnectionNum++:h.peerConnectionNum=1,c.addStream(h),a.fireMediaStreamEvent(p.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,h),r.debug("addLocalStream, peerConnectionNum: "+h.peerConnectionNum)}c.__wscIsAudioStreamAdded||(c.__wscIsAudioStreamAdded=o.streamHasMediaTracks(a.localMediaStreams,"audio")),c.__wscIsVideoStreamAdded||(c.__wscIsVideoStreamAdded=o.streamHasMediaTracks(a.localMediaStreams,"video"))}r.debug("call local media streams length : "+a.localMediaStreams.length)},o.addLocalStreams=function(a,b){if(b)for(var c=0;c<b.length;c++){var d=b[c];o.addLocalStream(a,d)}},o.calculateMediaChange=function(a,b){var c=!1,d=[],e=[];if(a.forEach(function(a){"inactive"!==a.mode&&0!==a.port&&d.push(a)}),b.forEach(function(a){"inactive"!==a.mode&&0!==a.port&&e.push(a)}),d.length<e.length)c=!0;else if(d.length>e.length)c=!0;else for(var f=0;f<e.length;f++){for(var g=e[f],h=!1,i=0;i<d.length;i++)if(g.equals(d[i])){h=!0;break}if(!h){c=!0;break}}return c},o.isMediaChanged=function(a,b){var c=o.calculateMediaChange(a,b);return c},o.getMediaFromSDP=function(a){var b,c,d,e,f,g,h,i,j,k=a.split("\r\n"),l=0,m="sendrecv",n=[],p=k.length;for(b=0;b<p;b++)switch(c=k[b].split("="),c[0]){case"a":d=c[1],"sendonly"===d||"sendrecv"===d||"recvonly"===d||"inactive"===d?0===l?m=c[1]:n[l-1].mode=c[1]:0===d.indexOf("candidate:")?n[l-1].candidates.push(k[b]):0===d.indexOf("mid:")&&(n[l-1].mid=k[b]);break;case"m":e=c[1],f=e.split(" "),g=f[0],h=f[1],i=new o.Media(g,m,h),n[l++]=i;break;case"o":d=c[1],j=d.split(" ")[1],n.sessionId=j}return n},o.Media=function(a,b,c){this.type=a,this.mode=b,this.port=c,this.candidates=[],this.mid="",this.toJSON=function(){var a={type:this.type,mode:this.mode,port:this.port};return a},this.equals=function(a){return 0===this.port&&(this.mode="inactive"),0===a.port&&(a.mode="inactive"),this.type===a.type&&this.mode===a.mode}},o.getCallConfigFromRemoteSDP=function(b,c){var d=p.MEDIADIRECTION.NONE,e=p.MEDIADIRECTION.NONE,f=null,g=function(a,b){switch(a.toLowerCase()){case"sendonly":return b?p.MEDIADIRECTION.SENDONLY:p.MEDIADIRECTION.RECVONLY;case"recvonly":return b?p.MEDIADIRECTION.RECVONLY:p.MEDIADIRECTION.SENDONLY;case"sendrecv":return p.MEDIADIRECTION.SENDRECV;case"inactive":return p.MEDIADIRECTION.NONE}};if(b){for(var h=o.getMediaFromSDP(b),i=null,j=0;j<h.length;j++)"audio"===h[j].type.toLowerCase()?e=g(h[j].mode,c):"video"===h[j].type.toLowerCase()?d=g(h[j].mode,c):"application"===h[j].type.toLowerCase()&&(i=[]);f=new a.CallConfig(e,d,i)}return f},o.streamHasMediaTracks=function(a,b){var c=!1;if(null===a||"audio"!==b&&"video"!==b)return c;for(var d=0;d<a.length;d++)if("audio"===b){var e=a[d].getAudioTracks();if(null!==e&&e.length>0){c=!0;break}}else{var f=a[d].getVideoTracks();if(null!==f&&f.length>0){c=!0;break}}return c},o.changeSdpByCallConfig=function(a,b){function c(a){var b=g;switch(a){case p.MEDIADIRECTION.RECVONLY:b=n[1];break;case p.MEDIADIRECTION.SENDONLY:b=n[2];break;case p.MEDIADIRECTION.SENDRECV:b=n[0];break;case p.MEDIADIRECTION.NONE:b=n[3]}return b}function d(c,d,e){if(!(c<=-1)){var f="",g="";k=a.indexOf(j,c+d.length),k>-1?(g=a.substring(c,k),f=a.substring(k)):g=a.substring(c);for(var h=0;h<n.length;h++){var i=g.indexOf(n[h]);i>=0&&(g=g.replace(n[h],e))}var l=b.pkgInstance.trickleIceMode;"full"!==l&&"half"!==l||(g.indexOf("ice-options:google-ice")>0?g=g.replace(/ice-options:google-ice/g,"ice-options:trickle"):g.indexOf("ice-options:trickle")<0&&(g+="a=ice-options:trickle\r\n")),a=a.substring(0,c)+g+f}}var e,f,g="a=inactive",h="m=video",i="m=audio",j="m=",k=-1,l=b.callConfig.audioConfig,m=b.callConfig.videoConfig,n=[];return n[0]="a=sendrecv",n[1]="a=recvonly",n[2]="a=sendonly",n[3]=g,f=a.indexOf(i),f>-1&&d(f,i,c(l)),e=a.indexOf(h),e>-1&&d(e,h,c(m)),a},o.getLocalStreams=function(a){
return a?"function"==typeof a.getLocalStreams?a.getLocalStreams():n.browser.isFirefox?a.localStreams:void 0:[]},o.getRemoteStreams=function(a){return a?"function"==typeof a.getRemoteStreams?a.getRemoteStreams():n.browser.isFirefox?a.remoteStreams:void 0:[]},o.invokeCallError=function(b,c,d){if(b.onCallError){var e=new a.ErrorInfo(c,d);try{b.onCallError(e)}catch(a){r.error("The callback function 'Call.onCallError()' exception:"+a)}}},n.rtcHelper=o,a}(cloud||{}),cloud=function(a){function b(a){var b,c,d=a,e=this;this.start=function(){if(d.sessionState===f.SESSIONSTATE.CONNECTED){b&&window.clearTimeout(b);var a=d.lastUnACKedInboundMsg;if(a){var i=a.control.sequence;i&&i!==c&&(typeof a!==g.Message&&(a=new g.Message(a)),a.ack(d),h.debug("PeriodlyACKChecker ack the message in sequence "+i),c=i)}b=window.setTimeout(function(){e.start()},d.ackInterval)}else e.stop()},this.stop=function(){b&&(h.debug("Stop PeriodlyACKChecker"),window.clearTimeout(b))}}function c(a){var b,c,d=a,g=3e3;this.stop=function(){b&&(h.debug("Stop IceServerEnquiry Timer"),window.clearTimeout(b),b=void 0)},this.scheduleIceEnquiry=function(a){b&&window.clearTimeout(b),b=window.setTimeout(function(){h.debug("Enquiring...."),e.sendIceEnquiry(d)},a)},this.doIceEnquiry=function(a){var b=this,f=b.handleIceEnquiry;b.handleIceEnquiry=function(d,e){b.handleIceEnquiry=f,f(d,e),clearTimeout(c),a()},h.debug("Enquiring...."),e.sendIceEnquiry(d),c=setTimeout(function(){h.warn("Timeout of IceServerEnquirer is triggered..."),b.handleIceEnquiry=f,a()},g)},this.handleIceEnquiry=function(a,b){var c=b.control.type;if(c===f.TYPE.RESPONSE){h.debug("Receive Response for ICE-Enquiry "),a.iceServerListFromServer=[];var d=b.payload.iceServers,e=-1;if(d)for(var g=0;g<d.length;g++){var i="",j="",k=-1;if(d[g].username&&(i=d[g].username,a.iceServerAccessToken=i),d[g].credential&&(j=d[g].credential),d[g].lifetime&&(k=1e3*d[g].lifetime),d[g].urls)for(var l=0;l<d[g].urls.length;l++){var m={urls:d[g].urls[l],username:i,credential:j};h.debug("Retrieve an ICE Server from response: "+JSON.stringify(m)),a.iceServerListFromServer.push(m),k>0&&(k<e||e<=0)&&(e=k)}}e<=0?h.warn("The minimum lifetime retrieved from response is "+e+" ms, so stop ICE Enquiry"):(h.debug("Schedule an ICE Enquiry in "+e+" ms"),a.iceServerEnquirer.scheduleIceEnquiry(e),a.iceServerEnquiryLifetime=e)}else c===f.TYPE.ERROR&&(h.warn("Receive an error for ICE-Enquiry Request"),h.debug("Schedule an ICE Enquiry in "+a.iceServerEnquiryLifetime+" ms"),a.iceServerEnquirer.scheduleIceEnquiry(a.iceServerEnquiryLifetime));if(h.debug("About to test flags "+a.callUpdateOnIceResponse),a.callUpdateOnIceResponse){var n=a.getAllSubSessions();if(n&&n.length>0)for(var g=0;g<n.length;g++){var o=n[g],p=o.peerConnection,q=o.getStreams();if(!p||"relay"!==p.sessionType&&"relayed"!==p.sessionType){if(q)for(h.debug("Updating conversation due to Relay Failure"),g=0;g<q.length;g++){var r=q[g];"relayed"!==r.call.sessionType&&"relay"!==r.call.sessionType||r.update(r.getStreamOptions())}}else h.debug("Updating the call due to Relay Failure"),a.allowRetry=!0,o.update(o.callConfig)}a.callUpdateOnIceResponse=!1}}}var d=a._private=a._private||{},e={},f=d.wscConst,g=d.wscUtils,h=a.getLogger(),i=function(d,i,k,n,o,p,q,r){"use strict";if(p&&(this.extHeaders=p),o){var s=e.rehydrateSession(d,i,k,n,o,p,q,r);if(null==s){var t="Failed to reload session data.",u=new g.ErrorInfo(f.ERRORCODE.RESTORE_FAILED,t);h.warn(t);try{n&&n(u)}catch(a){h.error("onError callback exception: "+a)}}return h.debug("Completed session rehydration: "+o),s}this.webSocketUri=i,this.wscWebsocket=null,this.sessionId=null,this.userName=d,this.sessionState=f.SESSIONSTATE.NONE,this.timeToInitWebSocket=0;try{e.initWebSocket(this)}catch(a){if(h.error("Websocket initialization exception: "+a),n){var u=new g.ErrorInfo(f.ERRORCODE.WEBSOCKET_ERROR,a);try{n(u)}catch(a){h.error("The callback function 'Session.failureCallback()' returned the exception: "+a)}}}this.subSessionsMap=new a.Map,this.unACKedMsgQueue=new j,this.successCallback=k,this.failureCallback=n,this.lastOutboundSeq=0,this.lastInboundSeq=0,this.lastUnHandledInboundReq=null,this.lastUnACKedInboundMsg=null,this.hostIPs=[],this.onSessionStateChange=null,this.packagesMap=new a.Map,this.busyPingInterval=3e3,this.idlePingInterval=1e4,this.pingInterval=this.idlePingInterval,this.reConnectInterval=2e3,this.ackInterval=6e4,this.reConnectTime=6e4,this.retryCount=2,this.retryTimes=0,this.timeToLive=0,this.hibernateSuccessCallback=null,this.hibernateFailureCallback=null,this.onHibernationRequest=null,this.iceServerListFromServer=null,this.iceServerAccessToken=null,q&&(this.extPayloads=q,this.timeToLive=3600,this.clientCapability=new l),this.sessionTimeOut=null,this.reConnectTimeOut=null,this.pingTimeOut=null,this.periodlyACKChecker=new b(this),this.iceServerEnquirer=new c(this),this.iceServerEnquiryLifetime=0,this.connectSubSessionId=null,this.lastActiveTime=null,this.callUpdateOnIceResponse=!1,this.allowRetry=!1,this.enableVerbose=!1,new m(this),this.toJSON=function(){var a={sessionId:this.sessionId,userName:this.userName,unACKedMsgQueue:this.unACKedMsgQueue,lastOutboundSeq:this.lastOutboundSeq,lastInboundSeq:this.lastInboundSeq,lastUnHandledInboundReq:this.lastUnHandledInboundReq,subSessionsMap:this.subSessionsMap,packagesMap:this.packagesMap};return a}};i.prototype={getAllSubSessions:function(){for(var a=[],b=this.subSessionsMap.values(),c=0,d=0;d<b.length;d++)for(var e=b[d],f=e.values(),g=0;g<f.length;g++)a[c]=f[g],c++;return a},getSubSessionsByPackageType:function(a){return this.subSessionsMap.get(a)},putSubSession:function(b,c,d){var f=this.subSessionsMap.get(b);f||(f=new a.Map,this.subSessionsMap.put(b,f)),f.put(c,d),e.updateActivityMarker(this),this.pingInterval=this.busyPingInterval,e.schedulePing(this,!1),h.debug("use busyPingInterval "+this.pingInterval)},getSubSession:function(a){"use strict";for(var b=null,c=this.subSessionsMap.values(),d=0;d<c.length&&(b=c[d].get(a),null==b);d++);return b},removeSubSession:function(a){"use strict";h.debug("Removing sub-session: "+a);for(var b=this.subSessionsMap.values(),c=0;c<b.length;c++)b[c].remove(a);var d=this.getAllSubSessions();d&&0===d.length&&(e.updateActivityMarker(this),this.pingInterval=this.idlePingInterval,h.debug("use idlePingInterval "+this.pingInterval)),this.saveToStorage()},saveToStorage:function(){if(this.sessionState!==f.SESSIONSTATE.CLOSED&&this.sessionState!==f.SESSIONSTATE.FAILED&&this.sessionState!==f.SESSIONSTATE.RELOADING)if(d.browser.supportSessionStorage)if(this.sessionId)try{sessionStorage.setItem(this.sessionId,JSON.stringify(this));var b=JSON.parse(sessionStorage.getItem(this.sessionId));h.debug("saved ..."),h.debug(b)}catch(b){h.error("Failed to save. Error = "+b),e.invokeSessionError(this,a.ERRORCODE.SAVE_FAILED,b)}else h.debug("Not saving. No sessionId");else h.warn("Sorry, web storage is not supported...");else h.debug("Do not save session data with session state: "+this.sessionState)},setSessionState:function(a){"use strict";this.sessionState=a,null!=this.sessionId&&this.saveToStorage(),this.onSessionStateChange&&this.onSessionStateChange(a)},close:function(){e.clearSession(this),this.wscWebsocket&&(this.wscWebsocket.close(1e3,"Normal close"),this.wscWebsocket=null,h.info("Websocket normally closed")),this.setSessionState(f.SESSIONSTATE.CLOSED)},getPackage:function(a){var b=this.packagesMap.get(a);return b},registerPackage:function(b){var c=b.packageType;if(!c)throw"There is no packageType defined in the package.";try{var d=this.packagesMap.get(c);if(d)throw"Duplicated package type in Session.";this.packagesMap.put(c,b);var e=new a.Map;this.subSessionsMap.put(c,e)}catch(a){h.error("Package registration failed:"+a)}},getUserName:function(){return this.userName},getSessionId:function(){return this.sessionId},getLastOutboundSeq:function(){return this.lastOutboundSeq},setIdlePingInterval:function(a){a<1e3?this.idlePingInterval=1e3:this.idlePingInterval=a},setBusyPingInterval:function(a){a<1e3?this.busyPingInterval=1e3:this.busyPingInterval=a},setReconnectInterval:function(a){this.reConnectInterval=a},setReconnectTime:function(a){this.reConnectTime=a},sendMessage:function(a){"use strict";var b,c=a.control.package_type,d=this.sessionId,e=a.control.type;if(d&&(a.control.session_id=d),a.control.version=f.PROTOCOL_VERSION,a.isReconnect()||e!==f.TYPE.ACK&&(a.control.sequence=this.lastOutboundSeq+1),b=JSON.stringify(a),this.sessionState===f.SESSIONSTATE.CLOSED||this.sessionState===f.SESSIONSTATE.FAILED)throw h.debug("Cannot send message; session state: "+this.sessionState),"Cannot send message; session state: "+this.sessionState;if(this.sessionState===f.SESSIONSTATE.CONNECTED||c===f.PACKAGE.REGISTER)try{this.wscWebsocket.send(b),h.debug("Session: "+d+", Sending message: "+JSON.stringify(a,null,2))}catch(a){h.error("Received an exception when sending message: "+a)}a.isACK()||a.isReconnect()||this.lastOutboundSeq++,h.debug("Send message - lastInboundSeq = "+this.lastInboundSeq+", lastOutboundSeq = "+this.lastOutboundSeq),this.unACKedMsgQueue.addMessage(a),(a.isFinalResponse()||a.isError()||"complete"===a.header.action)&&(this.lastUnHandledInboundReq&&this.lastUnHandledInboundReq.control.sequence<=a.control.ack_sequence&&(this.lastUnHandledInboundReq=null),this.lastUnACKedInboundMsg&&this.lastUnACKedInboundMsg.control.sequence===a.control.ack_sequence&&(this.lastUnACKedInboundMsg=null)),this.saveToStorage()},reSendMessage:function(a){var b=JSON.stringify(a);try{this.wscWebsocket.send(b),h.debug("Re-send message: "+JSON.stringify(a,null,4))}catch(a){h.error("Received an exception when re-sending message: "+a)}this.unACKedMsgQueue.addMessage(a),h.debug("Re-send message - lastInboundSeq = "+this.lastInboundSeq+", lastOutboundSeq = "+this.lastOutboundSeq),this.saveToStorage()},genNewCorrelationId:function(){var a=f.CONSTCS.CLIENT+(this.getLastOutboundSeq()+1);return a},generateSubSessionId:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=window.crypto.getRandomValues(new Uint8Array(1))[0]%16|0,c="x"===a?b:3&b|8;return c.toString(16)});return a},hibernate:function(b,c,d){var f=this.getAllSubSessions();b&&b>0&&(this.timeToLive=b),this.hibernateSuccessCallback=c,this.hibernateFailureCallback=d,e.updateActivityMarker(this),f&&f.length>0?e.invokeHibernateError(this,a.ERRORCODE.BUSY_EVERYWHERE,"session on busy"):e.sendHibernate(this,b)},getNetworkStatus:function(a,b){var c={iceServers:this.iceServerListFromServer},d=4,e=function(c){var d=1;c>=0?(d=c<=25?1:c>25&&c<=150?2:c>150&&c<=300?3:c>300&&c<=1e3?4:5,"function"==typeof e&&a(d,{throughput:c})):"function"==typeof b&&b("Throughput is less than zero.")},f=function(a){h.warn("Error happens when get network status: "+a),"function"==typeof b&&b("Cannot get network status.")},i=c.iceServers;Array.isArray(i)&&(c.iceServers=i.filter(function(a){return a.urls&&(0==a.urls.toLowerCase().indexOf("turn:")||0==a.urls.toLowerCase().indexOf("turns:"))})),new g.DataChannelThroughput_CallbackBased(c,d).test(e,f)},setTimeToLive:function(a){a&&a>0&&(this.timeToLive=a)},suspend:function(){return this.wscWebsocket&&(this.wscWebsocket.close(3001,"Abnormal close"),this.wscWebsocket=null,h.info("Websocket abnormal closed")),this.setSessionState(f.SESSIONSTATE.SUSPENDED),d.browser.supportSessionStorage?sessionStorage.getItem(this.sessionId):(h.warn("The browser does not support SessionStorage, there is no stateInfo stored."),null)}},e.handleWsOpen=function(a){function b(b){h.debug("New IPs: "+JSON.stringify(b,null,2)+"\nOld IPs: "+JSON.stringify(a.hostIPs,null,2)),0!==a.hostIPs.length?f(a.hostIPs,b)?(h.debug("Host IPs have changed"),g()):(h.debug("Host IPs have NOT changed"),a.clientIpNotChangedAfterReconnect=!0,e.sendRegister(a,null)):e.sendRegister(a,null),a.hostIPs=b,h.debug("New IPs: "+JSON.stringify(a.hostIPs,null,2))}function c(){h.error("Failed to get host IPs."),g()}function f(a,b){var c=!1;if(b.length!=a.length)c=!0;else for(var d=0;d<b.length;d++){var e=b[d];if(a.indexOf(e)===-1){c=!0;break}}return c}function g(){var b=a.getAllSubSessions();if(b&&b.length>0)for(var c=0;c<b.length;c++){var f=b[c],g=f.peerConnection;if(g){h.debug("Cleanup call between caller ["+f.getCaller()+"] and callee ["+f.getCallee()+"]");var j=i.getLocalStreams(g),k=i.getRemoteStreams(g);if(f.temporarySavedStreams=j,j)for(var c=0;c<j.length;c++)i.removeLocalStream(f,j[c]);if(k)for(var c=0;c<k.length;c++)d.browser.isFirefox||g.removeStream(k[c]);"closed"!==g.iceConnectionState&&(g.close(),f.peerConnection=null)}}e.sendRegister(a,null)}h.debug("Session opened with id: "+a.sessionId+", Old IPs: "+JSON.stringify(a.hostIPs,null,2));var i=d.rtcHelper;i.collectHostIPsByPc(b,c)},e.handleWsClose=function(b){h.debug("Session closed with id: "+b.sessionId),e.clearWebSocket(b.wscWebsocket),b.wscWebsocket=null,b.sessionState===f.SESSIONSTATE.CONNECTED?(b.periodlyACKChecker.stop(),b.iceServerEnquirer.stop(),b.setSessionState(f.SESSIONSTATE.RECONNECTING),window.clearTimeout(b.pingTimeOut),b.sessionTimeOut=window.setTimeout(function(){h.warn("reconnect timeout."),e.clearSession(b),b.setSessionState(f.SESSIONSTATE.FAILED),window.clearTimeout(b.reConnectTimeOut)},b.reConnectTime),e.reInitWebSocket(b)):b.sessionState!==f.SESSIONSTATE.NONE&&b.sessionState!==f.SESSIONSTATE.RELOADING||(e.clearSession(b),e.invokeSessionError(b,a.ERRORCODE.WEBSOCKET_ERROR,"websocket onerror"))},e.reInitWebSocket=function(a){h.debug("Session reinitialised with id: "+a.sessionId);var b=a.sessionState;h.debug("reInitWebSocket with state: "+b),b!==f.SESSIONSTATE.CONNECTED&&b!==f.SESSIONSTATE.CLOSED&&(a.reConnectTimeOut&&window.clearTimeout(a.reConnectTimeOut),e.initWebSocket(a),a.reConnectTimeOut=window.setTimeout(function(){e.reInitWebSocket(a)},a.reConnectInterval))},e.schedulePing=function(a,b){a.sessionState===f.SESSIONSTATE.CONNECTED&&(a.pingTimeOut&&window.clearTimeout(a.pingTimeOut),b&&e.sendPing(a),a.pingTimeOut=window.setTimeout(function(){e.schedulePing(a,!0)},a.pingInterval))},e.sendPing=function(a){try{null!=a.wscWebsocket&&(a.wscWebsocket.send("ping"),e.isAlive(a))}catch(a){h.debug("can not send ping now: "+a)}},e.isAlive=function(a){var b=Date.now();b>a.lastActiveTime+1.2*a.pingInterval?(a.retryTimes++,h.debug("The ping-pong retryTimes/retryCount: "+a.retryTimes+"/"+a.retryCount),a.retryTimes===a.retryCount&&(a.retryTimes=0,h.warn("Client reconnecting..."),e.handleWsClose(a))):a.retryTimes=0},e.updateActivityMarker=function(a){a.lastActiveTime=Date.now()},e.clearSession=function(a,b){var c=1e3,e=[];a.packagesMap&&(e=a.packagesMap.values());for(var f=0;f<e.length;f++)e[f].clear&&e[f].clear();b&&(c=b),1e3==c&&d.browser.supportSessionStorage&&sessionStorage&&sessionStorage.removeItem(a.sessionId),a.periodlyACKChecker&&a.periodlyACKChecker.stop(),a.iceServerEnquirer&&a.iceServerEnquirer.stop(),g.setsessionid("")};var j=function(){var a=null,b=null,c=new g.Queue;this.toJSON=function(){var d={lowerSeq:a,upperSeq:b,msgQueue:c};return d},this.getLowerSeq=function(){return a},this.setLowerSeq=function(b){a=b},this.getUpperSeq=function(){return b},this.setUpperSeq=function(a){b=a},this.getMsgQueue=function(){return c},this.addMessage=function(d){if(!d.isACK()&&!d.isReconnect()){var e=d.control.sequence;null==a&&(a=e),b=e,c.enqueue(d),h.debug("addMessage - queue size = "+c.length()+", cslw: "+a+", csuw: "+b)}},this.ackMessages=function(d){if(h.debug("ackMessages - (before) ackSeq = "+d+", queue size = "+c.length()+", cslw = "+a+", csuw = "+b),0!==c.length()&&d>=a&&d<=b){for(var e=c.dequeue(),f=e.control.sequence;e&&f<d;)e=c.dequeue(),f=e.control.sequence;return h.debug("ackMessages - queued message sequence = "+f),null==c.peek()?(a=b+1,h.debug("ackMessages - Reset cslw to csuw+1 = "+a)):(e=c.peek(),a=e.control.sequence,h.debug("ackMessages - Reset cslw to incoming seq = "+a)),h.debug("ackMessages - (after) queue size = "+c.length()+", cslw = "+a+", csuw = "+b),!0}return!1},this.reSendMessage=function(d,e){for(var f=c.length(),g=0;g++<f;){var i=c.dequeue(),j=i.control.sequence;j>=e+1?(h.debug("reSend message: "+JSON.stringify(i)),d.reSendMessage(i)):h.debug("skip message: "+JSON.stringify(i))}if(null==c.peek())a=b+1,h.debug("reSendMessage - Reset cslw to csuw+1 = "+a);else{var i=c.peek();a=i.control.sequence,h.debug("reSendMessage - Reset cslw to incoming seq = "+a)}h.debug("reSendMessage - cslw: "+this.getLowerSeq()+", csuw: "+this.getUpperSeq()+", queue size = "+c.length())}};e.handleWsData=function(a,b){"use strict";if(e.updateActivityMarker(b),"pong"===a);else{e.schedulePing(b,!1);var c=null;c="string"==typeof a?JSON.parse(a):a,h.debug("Session: "+b.sessionId+", Received data from server: "+JSON.stringify(c,null,2));var d=new g.Message(c),i=null,j=null,k=null,l=null,m=null;if(d&&(i=d.control.sequence,j=d.control.ack_sequence,k=d.control.type,l=d.header.action,m=d.control.package_type),i&&(b.lastInboundSeq=i),j?(b.unACKedMsgQueue.ackMessages(j),h.debug("handleWsData: lastInboundSeq = "+b.lastInboundSeq+", lastOutboundSeq = "+b.lastOutboundSeq)):k===f.TYPE.RESPONSE&&null!=i&&(b.unACKedMsgQueue.ackMessages(i),h.debug("handleWsData: lastInboundSeq = "+b.lastInboundSeq+", lastOutboundSeq = "+b.lastOutboundSeq)),m||(m=f.PACKAGE.REGISTER),k===f.TYPE.REQUEST&&(b.lastUnHandledInboundReq=d),b.lastUnACKedInboundMsg=d,l===f.ACTION.SHUTDOWN&&null!=b.lastUnHandledInboundReq){var n=b.lastUnHandledInboundReq.control.subsession_id,o=d.control.subsession_id;n===o&&(b.lastUnHandledInboundReq=null)}var p=b.getPackage(m);p?p.onMessage(d):h.warn("package_type '"+m+"' is not defined!"),b.saveToStorage()}},e.invokeSessionError=function(b,c,d){if(b.failureCallback){var e=new a.ErrorInfo(c,d);try{b.failureCallback(e)}catch(a){h.error("The callback function 'Session.failureCallback()' returned an exception: "+a)}}},e.invokeHibernateError=function(b,c,d){if(b.hibernateFailureCallback){var e=new a.ErrorInfo(c,d);try{b.hibernateFailureCallback(e)}catch(a){h.error("The callback function 'Session.hibernateFailureCallback()' returned an exception: "+a)}}},e.initWebSocket=function(a){"use strict";if(null==a.wscWebsocket){if(h.debug("creating the websocket..."),a.timeToInitWebSocket=(new Date).getTime(),a.wscWebsocket=new WebSocket(a.webSocketUri,"webrtc.oracle.com"),null==a.wscWebsocket)throw new Error("sessionHelper.initWebSocket(): new WebSocket() returns null.");a.wscWebsocket.onopen=function(b){a.timeToInitWebSocket=(new Date).getTime()-a.timeToInitWebSocket,h.debug("websocket event handler onopen is invoked."),e.handleWsOpen(a)},a.wscWebsocket.onclose=function(b){h.debug("websocket event handler onclose is invoked."),e.handleWsClose(a)},a.wscWebsocket.onmessage=function(b){b.data&&e.handleWsData(b.data,a)},a.wscWebsocket.onerror=function(a){h.info("websocket onerror")}}},e.clearWebSocket=function(a){null!=a&&(a.onopen=null,a.onclose=null,a.onmessage=null,a.onerror=null)},e.sendRegister=function(a,b){"use strict";var c=new g.Message;if(c.control.type=f.TYPE.REQUEST,c.control.package_type=f.PACKAGE.REGISTER,a.userName&&(c.header.initiator=a.userName,c.header.target=a.userName),c.header.action=f.ACTION.CONNECT,b&&(c.header.authorization=b),a.extHeaders&&c.addExtHeaders(a.extHeaders),a.extPayloads&&c.addExtPayloads(a.extPayloads),a.clientCapability){var d={family:a.clientCapability.family,version:a.clientCapability.version};if(c.payload.capability)for(var e in d){var h=d[e];c.payload.capability[e]||(c.payload.capability[e]=h)}else c.payload.capability=d}a.sessionId?b?a.sendMessage(c):(c.header.cslr=a.lastInboundSeq,c.header.cslw=a.unACKedMsgQueue.getLowerSeq(),c.header.csuw=a.unACKedMsgQueue.getUpperSeq(),a.sendMessage(c)):a.sendMessage(c)},e.sendHibernate=function(a,b){"use strict";var c=new g.Message;c.control.type=f.TYPE.REQUEST,c.control.package_type=f.PACKAGE.REGISTER,c.control.subsession_id=a.generateSubSessionId(),c.control.correlation_id=a.genNewCorrelationId(),c.header.action=f.ACTION.HIBERNATE;var d;d=b&&b>0?{ttl:b}:{ttl:3600},c.addExtHeaders(d),a.sendMessage(c)},e.respondHibernate=function(a,b){"use strict";var c,d=new g.Message;if(a.timeToLive&&a.timeToLive>0){d.control.type=f.TYPE.RESPONSE,d.header.response_code=200,d.control.message_state=f.MESSAGESTATE.FINAL;var e={ttl:a.timeToLive};d.addExtHeaders(e),c=d.header.response_code}else d.control.type=f.TYPE.ERROR,d.header.error_code=f.ERRORCODE.FORBIDDEN,d.header.reason="Not supported",c=d.header.error_code;d.control.package_type=f.PACKAGE.REGISTER,d.control.subsession_id=b.control.subsession_id,d.control.correlation_id=b.control.correlationId,d.control.ack_sequence=a.lastInboundSeq,d.header.action=f.ACTION.HIBERNATE,a.sendMessage(d)},e.sendIceEnquiry=function(a){"use strict";var b=new g.Message;b.control.type=f.TYPE.REQUEST,b.control.package_type=f.PACKAGE.REGISTER,b.control.subsession_id=a.connectSubSessionId,b.control.correlation_id=a.genNewCorrelationId(),b.header.action=f.ACTION.ICE_ENQUIRY,a.sendMessage(b)},e.rehydrateSession=function(a,b,c,g,j,k,m,n){if(n){if(j&&j!==n.sessionId)return h.error("SessionId is inconsistent, sessionId in stateInfo is: "+n.sessionId+", but the given sessionId is: "+j),null;d.browser.supportSessionStorage?sessionStorage.setItem(n.sessionId,JSON.stringify(n)):h.warn("Sorry, web storage is not supported...")}var o=e.getStoredSession(j);if(h.debug("Get stored session: "+JSON.stringify(o)),o){var p=new i(a,b,c,g);p.userName=o.userName,p.sessionId=o.sessionId,p.lastOutboundSeq=o.lastOutboundSeq,p.lastInboundSeq=o.lastInboundSeq,p.lastUnHandledInboundReq=o.lastUnHandledInboundReq,p.extHeaders=k,m&&(p.extPayloads=m,p.timeToLive=3600,p.clientCapability=new l),p.unACKedMsgQueue.setUpperSeq(o.unACKedMsgQueue.upperSeq),p.unACKedMsgQueue.setLowerSeq(o.unACKedMsgQueue.lowerSeq);for(var q=o.unACKedMsgQueue.msgQueue.array,r=0;r<q.length;r++)p.unACKedMsgQueue.getMsgQueue().enqueue(q[r]);return p.rehydrationData={subSessionsMap:o.subSessionsMap,packagesMap:o.packagesMap},p.setSessionState(f.SESSIONSTATE.RELOADING),p}return null},e.getStoredSession=function(a){if(d.browser.supportSessionStorage){var b=sessionStorage.getItem(a);if(b)return JSON.parse(b)}return null},e.removeStoredSession=function(a){d.browser.supportSessionStorage&&sessionStorage.removeItem(a)},e.handleAuthenticateChallenge=function(a,b,c,d){var e=a.authHandler,i=null,j=!0,k=0;if(e&&e.refresh)for(;j&&k<3;)try{k++;var l=b.header.authenticate,m=e.refresh(f.AUTHTYPE.SERVICE,null);if(g.checkAuthInfo(f.AUTHTYPE.SERVICE,m)){l.ha1=g.calcHa1(m,l),l.username=m.username,c(l),j=!1;break}if(null==m||""===m){i="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",h.warn(i);break}i="No correct information was returned from the callback function 'AuthHandler.refresh()'. Please try again.",h.warn(i)}catch(a){i="Handle unauthenticated message error:"+a,h.error(i),j=!0}else i="No AuthHandler object was created for this Session or this AuthHandler did not implement the callback function 'AuthHandler.refresh()'!",h.warn(i);j&&d(i)},e.handleConnection=function(a,b){var c=b.control.type,d=b.getExtHeaders();if(c===f.TYPE.RESPONSE){a.sessionId&&a.sessionId!==b.control.session_id&&(h.warn("Local session id does not match remote session id - local: "+a.sessionId+", remote: "+b.control.session_id),e.clearSession(a),a.lastOutboundSeq=1,a.lastUnHandledInboundReq=null,a.lastUnACKedInboundMsg=null,a.sessionState=f.SESSIONSTATE.NONE),a.sessionId=b.control.session_id,h.debug("Retrieve verbose log flag from connect/response message : "+b.header.enable_verbose),b.header.enable_verbose&&(a.enableVerbose=b.header.enable_verbose),a.connectSubSessionId=b.control.subsession_id;var i=function(){var c=a.sessionState;switch(h.debug("doAfterIceEnquiry: session state = "+c),a.setSessionState(f.SESSIONSTATE.CONNECTED),c){case f.SESSIONSTATE.NONE:if(a.userName=b.header.initiator,g.setsessionid(a.sessionId),a.successCallback)try{a.successCallback(d)}catch(a){h.warn("The callback function 'session.successCallback()' exception:"+a)}break;case f.SESSIONSTATE.RECONNECTING:h.info("Session re-connected."),a.sessionTimeOut&&window.clearTimeout(a.sessionTimeOut),a.reConnectTimeOut&&window.clearTimeout(a.reConnectTimeOut);var i=b.header.sslr;a.unACKedMsgQueue.reSendMessage(a,i);var j=a.packagesMap.entry,k=a.subSessionsMap.entry;for(var l in j){var m=a.getPackage(l),n=k[l];if(m&&m.onResurrect)for(var o in n.entry)m.onResurrect(n.get(o))}break;case f.SESSIONSTATE.RELOADING:h.info("Session re-loaded.");var i=b.header.sslr;if(a.successCallback)try{a.successCallback(d)}catch(a){h.warn("The callback function 'session.successCallback()' exception:"+a)}var p=a.rehydrationData;if(p){var j=p.packagesMap.entry,k=p.subSessionsMap.entry;for(var l in j){var m=a.getPackage(l),n=k[l];m&&m.onRehydration&&m.onRehydration(n)}}var q=a.lastUnHandledInboundReq;q&&e.handleWsData(q,a)}e.updateActivityMarker(a),e.schedulePing(a,!1),a.periodlyACKChecker.start()};a.iceServerEnquirer.doIceEnquiry(i)}else if(c===f.TYPE.ERROR){var j=b.header.error_code,k=b.header.reason,l=new g.ErrorInfo(j,k),m=function(b){b&&(k=k+"("+b+")"),h.warn("Session connect failed:"+k),e.invokeSessionError(a,j,k),a.close()};if(j===f.ERRORCODE.UNAUTHORIZED||j===f.ERRORCODE.PROXYAUTH_REQUIRED){h.debug("Authentication failed: "+l.code);var n=function(b){e.sendRegister(a,b)};e.handleAuthenticateChallenge(a,b,n,m)}else m()}},e.handleHibernation=function(a){e.clearSession(a,3001),a.wscWebsocket&&(a.wscWebsocket.close(3001,"Session hibernated"),a.wscWebsocket=null,h.info("Websocket closed for hibernation")),a.lastUnHandledInboundReq=null,a.lastUnACKedInboundMsg=null,a.pingTimeOut&&window.clearTimeout(a.pingTimeOut),a.reConnectTimeOut&&window.clearTimeout(a.reConnectTimeOut),a.sessionTimeOut&&window.clearTimeout(a.sessionTimeOut),a.setSessionState(f.SESSIONSTATE.HIBERNATED)};var k=function(){};k.prototype={};var l=function(){"use strict";var a,b,c,d=navigator.userAgent,e=navigator.appName,f=""+parseFloat(navigator.appVersion);d&&((b=d.indexOf("Opera"))!=-1?(e="Opera",f=d.substring(b+6),(b=d.indexOf("Version"))!=-1&&(f=d.substring(b+8))):(b=d.indexOf("MSIE"))!=-1?(e="Microsoft Internet Explorer",f=d.substring(b+5)):(b=d.indexOf("Chrome"))!=-1?(e="Chrome",f=d.substring(b+7)):(b=d.indexOf("Safari"))!=-1?(e="Safari",f=d.substring(b+7),(b=d.indexOf("Version"))!=-1&&(f=d.substring(b+8))):(b=d.indexOf("Firefox"))!=-1?(e="Firefox",f=d.substring(b+8)):(a=d.lastIndexOf(" ")+1)<(b=d.lastIndexOf("/"))&&(e=d.substring(a,b),f=d.substring(b+1),e.toLowerCase()==e.toUpperCase()&&(e=navigator.appName)),(c=f.indexOf(";"))!=-1&&(f=f.substring(0,c)),(c=f.indexOf(" "))!=-1&&(f=f.substring(0,c))),this.family=e,this.version=f},m=function(a){"use strict";this.session=a,this.packageType=f.PACKAGE.REGISTER,a.packagesMap.put(this.packageType,this)};return m.prototype={toJSON:function(){"use strict";var a={session:""};return g.toJSON(a,this)},onMessage:function(b){"use strict";var c=b.control.type,d=b.header.action;b.getExtHeaders();if(delete a._private,d===f.ACTION.HIBERNATE)if(c===f.TYPE.REQUEST)this.session.onHibernationRequest&&this.session.onHibernationRequest(b),e.respondHibernate(this.session,b),this.session.timeToLive&&this.session.timeToLive>0&&e.handleHibernation(this.session);else{e.handleHibernation(this.session);var g,i;if(c===f.TYPE.RESPONSE?g=b.header.response_code:c===f.TYPE.ERROR&&(g=b.header.error_code),i=b.header.reason,null==g||g>=200&&g<300){if(this.session.hibernateSuccessCallback)try{this.session.hibernateSuccessCallback(g)}catch(a){h.warn("The callback function 'session.successCallback()' exception: "+a)}}else e.invokeHibernateError(this.session,g,i)}else d===f.ACTION.CONNECT?e.handleConnection(this.session,b):d===f.ACTION.ICE_ENQUIRY?this.session.iceServerEnquirer.handleIceEnquiry(this.session,b):d===f.ACTION.RELAY_FAILED?(h.warn("Received relayFailed message: "+b),this.session.callUpdateOnIceResponse=!0,e.sendIceEnquiry(this.session)):h.warn("Receive an unexpected message: "+b)}},d.sessionHelper=e,a.Session=i,a.ExtensibleSession=i,a}(cloud||{}),cloud=function(a){"use strict";var b,c=a._private=a._private||{},d={},e={},f=c.wscConst,g=c.wscUtils,h=c.rtcHelper,i=a.getLogger();return a.CallConfig=function(a,b,c){this.audioConfig=a,this.videoConfig=b,this.dataChannelConfig=c},a.CallConfig.prototype={hasAudio:function(){return this.shouldSendAudio()||this.shouldReceiveAudio()},hasVideo:function(){return this.shouldSendVideo()||this.shouldReceiveVideo()},shouldSendAudio:function(){return null!==this.audioConfig&&(this.audioConfig===f.MEDIADIRECTION.SENDRECV||this.audioConfig===f.MEDIADIRECTION.SENDONLY)},shouldSendVideo:function(){return null!==this.videoConfig&&(this.videoConfig===f.MEDIADIRECTION.SENDRECV||this.videoConfig===f.MEDIADIRECTION.SENDONLY)},shouldReceiveAudio:function(){return null!==this.audioConfig&&(this.audioConfig===f.MEDIADIRECTION.SENDRECV||this.audioConfig===f.MEDIADIRECTION.RECVONLY)},shouldReceiveVideo:function(){return null!==this.videoConfig&&(this.videoConfig===f.MEDIADIRECTION.SENDRECV||this.videoConfig===f.MEDIADIRECTION.RECVONLY)},isPaused:function(){return this.audioConfig===f.MEDIADIRECTION.NONE&&this.videoConfig===f.MEDIADIRECTION.NONE},getChannelType:function(){return this.shouldSendVideo()?"video":this.shouldSendAudio()?"audio":this.shouldReceiveVideo()?"video":"audio"},toJSON:function(){return{audioConfig:this.audioConfig,videoConfig:this.videoConfig,dataChannelConfig:this.dataChannelConfig}},asJSON:function(){return{audio:this.audioConfig,video:this.videoConfig}}},a.CallConfig.fromJSON=function(b){return new a.CallConfig(b.audio,b.video)},a.StreamOptions=function(b,c){a.StreamOptions.superclass.constructor.apply(this,[b,c])},g.extend(a.StreamOptions,a.CallConfig),a.CallState=function(a,b,c,d){this.state=a,this.status={code:b,reason:c},this.streamId=d},a.CallState.prototype={isFinalState:function(){var a=!1;return this.state!==f.CALLSTATE.ENDED&&this.state!==f.CALLSTATE.FAILED||(a=!0),a},is180Ringing:function(){return!(!this.status||this.state!==f.CALLSTATE.RESPONDED||180!==this.status.code)},hasEstablished:function(){return this.state===f.CALLSTATE.ESTABLISHED||this.state===f.CALLSTATE.UPDATE_FAILED||this.state===f.CALLSTATE.UPDATED||this.state===f.CALLSTATE.UPDATING}},a.StreamState=function(b,c,d,e){a.StreamState.superclass.constructor.apply(this,[b,c,d,e])},g.extend(a.StreamState,a.CallState),d.doRequest=function(a,b){function c(){i.debug("=== doStartCallRequest ==="),e.isValidSdp(a,q)?(a.caller=n,a.callee=o,a.setCallState(f.CALLSTATE.STARTED,null,"receive call"),a.subSessionId=p,a.startReqCorrId=m,a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_GOT,q),a._template.doStartCallRequest&&a._template.doStartCallRequest(b)):e.sendReject(a,603,"Invalid Sdp")}function d(){i.debug("=== doUpdateCallRequest ==="),a.callState.state===f.CALLSTATE.UPDATING&&(i.debug("Got update message when call state is UPDATING, that is, my offer lost the glare then."),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECTED),a._template.rollbackUpdate&&(i.debug("Roll back the update initiated by me and accept the update from the other peer."),a._template.rollbackUpdate())),e.isValidSdp(a,q)?(a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_GOT,q),a._template.doUpdateCallRequest&&a._template.doUpdateCallRequest(b)):e.sendReject(a,603,"Invalid Sdp")}function g(){i.debug("=== doUpdateCallReqInEarlyPhase ==="),d(),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_GOT)}var h=a.callState,j=h.state,k=h.status.code,l=b.header.action,m=b.control.correlation_id,n=b.header.initiator,o=b.header.target,p=b.control.subsession_id,q=b.payload.sdp;switch(m&&(a.lastServerCorrelationId=m),b.payload&&b.payload.sdp&&i.debug("The SDP in the request is :\r\n"+b.payload.sdp),j){case f.CALLSTATE.NONE:switch(l){case f.ACTION.START:c();break;default:e.doUnexpectedMsg(a,b)}break;case f.CALLSTATE.STARTED:switch(l){case f.ACTION.START:c();break;default:e.doUnexpectedMsg(a,b)}break;case f.CALLSTATE.RESPONDED:switch(l){case f.ACTION.START:switch(k){case 180:c();break;case 183:
g()}break;default:e.doUnexpectedMsg(a,b)}break;case f.CALLSTATE.ESTABLISHED:case f.CALLSTATE.UPDATED:case f.CALLSTATE.UPDATE_FAILED:case f.CALLSTATE.ERROR:case f.CALLSTATE.UPDATING:switch(l){case f.ACTION.START:d();break;default:e.doUnexpectedMsg(a,b)}break;default:e.doUnexpectedMsg(a,b)}},d.doResponse=function(a,b){function c(){v>100&&v<200?b.payload&&b.payload.sdp?b.header.reliable?d():h():b.header.reliable?g():j():v>=200&&v<300&&k()}function d(){i.debug("=== doStartReliableProvRespWithSDP ==="),a.earlyMediaState=f.OFFER_ANSWER_STATE.INITIAL,a.setCallState(f.CALLSTATE.RESPONDED,v,r(v)),a._template.doStartReliableProvRespWithSDP&&a._template.doStartReliableProvRespWithSDP(b)}function g(){i.debug("=== doStartReliableProvRespWithoutSDP ==="),a._template.doStartReliableProvRespWithoutSDP&&a._template.doStartReliableProvRespWithoutSDP(b)}function h(){i.debug("=== doStartUnReliableProvRespWithSDP ==="),a.setCallState(f.CALLSTATE.RESPONDED,v,r(v)),a.gotAnsweredInProvResp=!0,a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ANSWER_GOT,b.payload.sdp),a._template.doStartUnReliableProvRespWithSDP&&a._template.doStartUnReliableProvRespWithSDP(b)}function j(){i.debug("=== doStartUnReliableProvRespWithoutSDP ==="),a.setCallState(f.CALLSTATE.RESPONDED,v,r(v))}function k(){if(a.earlyMediaState)switch(a.earlyMediaState){case f.OFFER_ANSWER_STATE.ACK_SENT:case f.OFFER_ANSWER_STATE.ACK_GOT:l();break;case f.OFFER_ANSWER_STATE.OFFER_SENT:m()}else n()}function l(){i.debug("=== doStart200RespInEarlyPahse ==="),a._template.doStart200RespInEarlyPhase&&a._template.doStart200RespInEarlyPhase(b)}function m(){i.debug("=== doUpdate200RespInEarlyPhase ==="),a._template.doUpdate200RespInEarlyPhase&&a._template.doUpdate200RespInEarlyPhase(b)}function n(){i.debug("=== doStart2XXResponse ==="),a.extHeaders&&delete a.extHeaders,a.gotAnsweredInProvResp?a.gotAnsweredInProvResp=null:a._template.doStart2XXResponse&&(a._template.doStart2XXResponse(b),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ANSWER_GOT,b.payload.sdp)),a.setCallState(f.CALLSTATE.RESPONDED,v,"got success response"),p()}function o(){i.debug("=== doUpdate200Response ==="),a.extHeaders&&delete a.extHeaders,b.payload.sdp?(a._template.doUpdate200Response&&a._template.doUpdate200Response(b),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ANSWER_GOT,b.payload.sdp),p()):i.error("Failed to handle update response with no SDP")}function p(){b.complete(w),a.callState.state===f.CALLSTATE.UPDATING?a.setCallState(f.CALLSTATE.UPDATED,null,"sent complete"):a.setCallState(f.CALLSTATE.ESTABLISHED,null,"sent complete"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_SENT),e.checkResumeState(a)}function q(){i.debug("=== doPrack200Response ==="),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_SENT)}function r(a){var b="";return 180===a&&(b="Ringing"),181===a&&(b="Call Is Being Forwarded"),182===a&&(b="Queued"),183===a&&(b="Session Progress"),b}var s=a.callState,t=s.state,u=b.header.action,v=b.header.response_code,w=a.session;switch(b.payload&&b.payload.sdp&&i.debug("The SDP in the response is :\r\n"+b.payload.sdp),t){case f.CALLSTATE.NONE:e.doUnexpectedMsg(a,b);break;case f.CALLSTATE.STARTED:case f.CALLSTATE.RESPONDED:switch(u){case f.ACTION.START:c();break;case f.ACTION.PRACK:q();break;default:e.doUnexpectedMsg(a,b)}break;case f.CALLSTATE.ESTABLISHED:case f.CALLSTATE.UPDATING:case f.CALLSTATE.UPDATED:case f.CALLSTATE.UPDATE_FAILED:case f.CALLSTATE.ERROR:switch(u){case f.ACTION.START:200===v&&o();break;default:e.doUnexpectedMsg(a,b)}break;default:e.doUnexpectedMsg(a,b)}},d.doMessage=function(a,b){function d(){i.debug("=== doCancelCallMessage ==="),a.setCallState(f.CALLSTATE.ENDED,"","cancelled"),a.end()}function g(){i.debug("=== doShutdownMessage ==="),a.setCallState(f.CALLSTATE.ENDED,"","shutdown"),a._template.doShutdownMessage&&a._template.doShutdownMessage()}function h(){i.debug("=== doUpdateShutdownMessage ===");var c=b.header.initiator;"##re-invite_cancel@server##"===c?(a.setCallState(f.CALLSTATE.UPDATE_FAILED,null,"canceled by server"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECT)):g()}function j(){i.debug("=== doCompleteMessage ==="),a.setCallState(f.CALLSTATE.ESTABLISHED,null,"got complete"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_GOT)}function k(){i.debug("=== doUpdateComplete ==="),a.setCallState(f.CALLSTATE.UPDATED,null,"got complete"),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.ACK_GOT)}function l(){if(i.debug("=== doTrickleIce ==="),b.payload.candidates&&a.peerConnection){var c,d,e=b.payload.candidates,f=e.split("\r\n");if(f.length>0){c=f.shift();var g=c.split(":");0===c.indexOf("a=mid")&&2===g.length?(d=g[1],m(d,f)):i.warn("invalid trickle ice candidate")}}}function m(b,d){var e={};null!==a.peerConnection.remoteSDP&&"undefined"!=typeof a.peerConnection.remoteSDP||a.peerConnection.remoteDescription&&(a.peerConnection.remoteSDP=a.peerConnection.remoteDescription.sdp);for(var f=a.peerConnection.remoteSDP;d.length>0;){var g=d.shift();if(g&&0===g.indexOf("a=mid:")){var h=g.split(":");2===h.length&&(b=h[1])}else if(g&&0===g.indexOf("a=candidate:")){var j={};if(j.candidate=g,j.sdpMid=b,c.browser.isFirefox||c.browser.isIE||c.browser.isSafari){if(void 0===e[b]){var k=f.split("a=mid:"),l=-1;k.length>1&&(k.shift(),k.every(function(a,c){return 0!==a.indexOf(b+"\r\n")||(l=c,!1)})),e[b]=l}e[b]>-1&&(j.sdpMLineIndex=e[b])}var m=new RTCIceCandidate(j);a.peerConnection.addIceCandidate(m,n.bind(null,m),o.bind(null,m))}else g&&0===g.indexOf("a=end-of-candidates")?i.debug("Get end-of-candidates when handling trickle ice candidate"):""!==g.trim()&&i.debug("Get unknown line of trickle ice candidate: "+g)}}function n(a){i.debug("addIceCandidate succeed, "+JSON.stringify(a))}function o(a,b){i.warn("For candidate: "+JSON.stringify(a)+", addIceCandidate gets error: "+JSON.stringify(b))}var p=a.callState,q=p.state,r=b.header.action;switch(q){case f.CALLSTATE.NONE:e.doUnexpectedMsg(a,b);break;case f.CALLSTATE.STARTED:switch(r){case f.ACTION.SHUTDOWN:d();break;default:e.doUnexpectedMsg(a,b)}break;case f.CALLSTATE.RESPONDED:switch(r){case f.ACTION.SHUTDOWN:d();break;case f.ACTION.COMPLETE:j();break;default:e.doUnexpectedMsg(a,b)}break;case f.CALLSTATE.ESTABLISHED:case f.CALLSTATE.UPDATED:case f.CALLSTATE.UPDATE_FAILED:case f.CALLSTATE.ERROR:switch(r){case f.ACTION.SHUTDOWN:g();break;case f.ACTION.COMPLETE:j();break;case f.ACTION.TRICKLE:l();break;default:e.doUnexpectedMsg(a,b)}break;case f.CALLSTATE.UPDATING:switch(r){case f.ACTION.SHUTDOWN:h();break;case f.ACTION.COMPLETE:k();break;case f.ACTION.TRICKLE:l();break;default:e.doUnexpectedMsg(a,b)}break;default:r===f.ACTION.TRICKLE?l():e.doUnexpectedMsg(a,b)}},d.doError=function(a,b){function c(){i.debug("=== doErrorMessage ==="),b.ack(o);var c=new g.ErrorInfo(m,n);if(o.sessionState===f.SESSIONSTATE.CONNECTED)a.callState.state!==f.CALLSTATE.NONE&&(k.hasEstablished()?d():h());else try{o.failureCallback(c)}catch(a){i.error("Exception in Session failureCallback: "+a)}}function d(){if(i.debug("=== doUpdateCallError ==="),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECTED),a.callState.state===f.CALLSTATE.UPDATING&&a.setCallState(f.CALLSTATE.UPDATE_FAILED,m,n),a._template.rollbackUpdate&&a._template.rollbackUpdate(),a.session.allowRetry){i.debug("Retry update due to Relay failure");var b=Math.floor(500*Math.random());window.setTimeout(a.update(a.callConfig),b)}a.session.allowRetry=!1,e.checkResumeState(a)}function h(){i.debug("=== doStartCallError ==="),a.setCallState(f.CALLSTATE.FAILED,m,n),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECTED),a._template.doStartCallError&&a._template.doStartCallError()}function j(){i.debug("=== doAuthentication ===");var c,d=!0,e=0,h=a.session.authHandler,j=b.header.authenticate;if(h&&h.refresh)for(;d&&e<3;){e++;try{if(c=h.refresh(f.AUTHTYPE.SERVICE,null),g.checkAuthInfo(f.AUTHTYPE.SERVICE,c))j.ha1=g.calcHa1(c,j),j.username=c.username,a.authInfo=j,a._template.sendOffer(),d=!1;else{if(null===c||""===c){i.warn("No valid authentication information");break}i.warn("No valid authentication information")}}catch(a){i.error("Got exception: "+a),d=!0}}else i.warn("No AuthHandler for this Session");d===!0&&(a.setCallState(f.CALLSTATE.FAILED,m,n),a._template.clearCall())}var k=a.callState,l=b.header.action,m=b.header.error_code,n=b.header.reason,o=a.session;switch(l){case f.ACTION.START:switch(m){case 401:case 407:j();break;case 491:i.debug("Got 491, ACK and do nothing."),b.ack(o);break;default:c()}break;default:e.doUnexpectedMsg(a,b)}},d.doACK=function(a,b){i.debug("ACK")},b=function(b){var c=f.OFFER_ANSWER_STATE.INITIAL,d=f.OFFER_ANSWER_STATE.INITIAL,g=b,j="",k="",l="";this.trickledCandidatesMap=new a.Map,this.getMasterState=function(){return c},this.getSlaveState=function(){return d},this.updateCallRemoteMedias=function(a){g.remoteMedias=h.getMediaFromSDP(a)},this.updateState=function(a,b){switch(i.debug("Trying to update offer-answer state to : "+a),a){case f.OFFER_ANSWER_STATE.OFFER_SENT:k=b,c=a;break;case f.OFFER_ANSWER_STATE.OFFER_GOT:j=b,d=a;break;case f.OFFER_ANSWER_STATE.ANSWER_SENT:d=a,k=b,l=j,this.updateCallRemoteMedias(l);break;case f.OFFER_ANSWER_STATE.ANSWER_GOT:c=a,l=b,this.updateCallRemoteMedias(l);break;case f.OFFER_ANSWER_STATE.ACK_SENT:c=a,b&&(k=b),e.sendTrickledCandidates(g);break;case f.OFFER_ANSWER_STATE.ACK_GOT:d=a,e.sendTrickledCandidates(g);break;case f.OFFER_ANSWER_STATE.OFFER_REJECTED:c=a;break;case f.OFFER_ANSWER_STATE.OFFER_REJECT:d=a}g.offerAnswerManager.masterState=c,g.offerAnswerManager.slaveState=d,g.earlyMediaState&&(g.earlyMediaState=a)},this.canSendOffer=function(){var a=!1;if(g.callState){var b=g.callState.state;b!==f.CALLSTATE.END&&b!==f.CALLSTATE.FAILED||(a=!0)}var e=!(c!==f.OFFER_ANSWER_STATE.ACK_SENT&&c!==f.OFFER_ANSWER_STATE.INITIAL&&c!==f.OFFER_ANSWER_STATE.OFFER_REJECTED||d!==f.OFFER_ANSWER_STATE.ACK_GOT&&d!==f.OFFER_ANSWER_STATE.OFFER_REJECT&&d!==f.OFFER_ANSWER_STATE.INITIAL&&d!==f.OFFER_ANSWER_STATE.ANSWER_SENT||a);return i.debug((e?"Can":"Cannot")+" send offer now. The offer-answer master/slave state is: "+g.offerAnswerManager.getMasterState()+" / "+g.offerAnswerManager.getSlaveState()+", call State: "+g.callState.state+", session State: "+g.session.sessionState+", ICE connection state: "+(g.peerConnection?g.getIceConnectionState():"peerConnection is null")),e},this.reset=function(){c=f.OFFER_ANSWER_STATE.INITIAL,d=f.OFFER_ANSWER_STATE.INITIAL,j=""},this.getLatestActiveRemoteSdp=function(){return l},this.getLatestActiveLocalSdp=function(){return k}},e.isValidSdp=function(a,b){return!(void 0===b||null===b||b.indexOf("a=")<0&&b.indexOf("m=")<0)},e.getInitiator=function(a){return a.session.userName},e.getTarget=function(a){var b,c=a.session.userName;return b=c===a.caller?a.callee:a.caller},e.send180Ringing=function(a){var b=e.createResponse(a);b.control.message_state=f.MESSAGESTATE.SUBSEQUENT,b.header.action=f.ACTION.START,a.session.sendMessage(b),a.setCallState(f.CALLSTATE.RESPONDED,180,"Ringing")},e.sendReject=function(a,b,c,d){var g=e.createError(a),h=f.ERRORCODE.DECLINED;b?g.header.error_code=b:g.header.error_code=h,c&&(g.header.reason=c),g.header.action=f.ACTION.START,d&&g.addExtHeaders(d),a.session.sendMessage(g),a.offerAnswerManager.updateState(f.OFFER_ANSWER_STATE.OFFER_REJECT)},e.sendPrack=function(a){var b=e.createRequest(a);b.control.correlation_id=a.lastServerCorrelationId,b.header.action=f.ACTION.PRACK,a.session.sendMessage(b)},e.createRequest=function(a){var b=new g.Message,c=a.session.lastInboundSeq,d=e.getInitiator(a),h=e.getTarget(a);return b.control.type=f.TYPE.REQUEST,b.control.subsession_id=a.subSessionId,b.control.package_type=a.pkgInstance.packageType,b.control.ack_sequence=c,b.header.initiator=d,h&&(b.header.target=h),a.streamId&&a.streamType&&(b.header.stream_id=a.streamId,b.header.stream_type=a.streamType),b},e.createResponse=function(a){var b=new g.Message,c=a.lastServerCorrelationId,d=a.session.lastInboundSeq,e=a.caller,h=a.callee,i=a.subSessionId;return b.control.type=f.TYPE.RESPONSE,b.control.subsession_id=i,b.control.package_type=a.pkgInstance.packageType,b.control.correlation_id=c,b.control.ack_sequence=d,b.header.initiator=e,h&&(b.header.target=h),a.streamId&&a.streamType&&(b.header.stream_id=a.streamId,b.header.stream_type=a.streamType),b},e.createError=function(a){var b=e.createResponse(a);return b.control.type=f.TYPE.ERROR,b},e.createMessage=function(a){var b=new g.Message,c=a.session.lastInboundSeq,d=e.getInitiator(a),h=e.getTarget(a),i=a.subSessionId;return b.control.type=f.TYPE.MESSAGE,b.control.subsession_id=i,b.control.package_type=a.pkgInstance.packageType,b.control.ack_sequence=c,b.header.initiator=d,h&&(b.header.target=h),a.streamId&&a.streamType&&(b.header.stream_id=a.streamId,b.header.stream_type=a.streamType),b},e.sendTrickledCandidates=function(a){var b=a.offerAnswerManager.trickledCandidatesMap,c="";if(b.size()>0){for(var d=b.keys();d.length>0;){var f=d.shift();c+=f;for(var g=b.get(f);g.length>0;){var h=g.shift(),i=/^a=.*\r\n$/i;c+=h.match(i)?h:"a="+h+"\r\n"}}e.sendTrickleMessage(a,c)}},e.sendTrickleMessage=function(a,b){var c=e.createMessage(a);c.header.action=f.ACTION.TRICKLE,c.payload={candidates:b},a.session.sendMessage(c),b.indexOf("end-of-candidates")>-1&&a.offerAnswerManager.trickledCandidatesMap.clear()},e.checkResumeState=function(a){if(a.resumeState)switch(a.resumeState){case f.RESUME_STATE.waittingFinalResp:a.resumeState=null,a.resume();break;case f.RESUME_STATE.reStartingCall:a.resumeSuccessCallback&&(a.resumeSuccessCallback(),a.resumeState=null)}},e.setCallState=function(a,b,c,d){var e=a.callState,g=e.state;if(!e.isFinalState()&&(!e.hasEstablished()||b!==f.CALLSTATE.NONE&&b!==f.CALLSTATE.STARTED&&b!==f.CALLSTATE.RESPONDED)){var h=e.status.code;if(g!==b||g===b&&h!==c){a.callState.state=b,a.callState.status.code=c,a.callState.status.reason=d;try{if(a.onCallStateChange)if(a.lastServerExtHeader){var j=a.lastServerExtHeader;a.onCallStateChange(a.callState,j),delete a.lastServerExtHeader}else a.onCallStateChange(a.callState);else if(a.onStateChange)if(a.lastServerExtHeader){var k=a.lastServerExtHeader;a.onStateChange(a.callState,k),delete a.lastServerExtHeader}else a.onStateChange(a.callState)}catch(a){i.warn("The callback function 'Call.onCallStateChange()' exception: "+a)}a.session.saveToStorage()}}},e.onMessage=function(a,b){if(a.isEnquiry()){if(!b.capabilityExchange){var c="No CapabilityExchange registered with Chat";throw i.error(c),c}b.capabilityExchange.onMessage(a)}else a.isRequest()?d.doRequest(b,a):a.isResponse()?d.doResponse(b,a):a.isMessage()?d.doMessage(b,a):a.isACK()?d.doACK(b,a):a.isError()&&d.doError(b,a)},e.clearMsrpSubSession=function(a){a.session.removeSubSession(a.subSessionId),a.msrpSession&&a.msrpSession.close()},e.msrpSubSessionDecline=function(a,b,c,d){var g,h;g=b?b:f.ERRORCODE.DECLINED,h=c?c:"Decline",a.callState.state===f.CALLSTATE.UPDATING?a.setCallState(f.CALLSTATE.UPDATE_FAILED,g,h):(e.clearMsrpSubSession(a),a.setCallState(f.CALLSTATE.FAILED,g,h)),e.sendReject(a,g,h,d)},e.sendAcceptResponse=function(a,b,c,d){var g=e.createResponse(a);g.control.message_state=f.MESSAGESTATE.FINAL,g.header.action=f.ACTION.START,g.control.correlation_id=b,d&&g.addExtHeaders(d),g.payload={sdp:c},a.session.sendMessage(g)},e.addParticipants2MsrpSubSession=function(a,b){if(b.callState.state!==f.CALLSTATE.NONE)throw{name:"IllegalStateException",message:"Cannot add participants at subSession state: "+b.callState.state};if(!(a instanceof Array))throw{name:"IllegalArgumentException",message:"parameter participants is not array type"};b.participants=a},e.doUnexpectedMsg=function(a,b){i.warn("Unexpected message is received: "+JSON.stringify(b,null,4))},a._private.CallStateMachine=d,a._private.offerAnswerManager=b,a._private.CallCommonUtils=e,a}(cloud||{}),cloud=function(a){var b=a._private=a._private||{},c=b.browser,d=a.getLogger(),e=function(){this.dataChannel=null,this.origDataChannel=null,this.state="none",this.label=null,this.onOpen=null,this.onClose=null,this.onError=null,this.dataSender=null,this.dataReceiver=null;var a=this,b=function(){a.dataSender=new f(a.dataChannel),d.info("Sender of DataTransfer created.")},e=function(){a.dataReceiver=new g,d.info("Receiver of DataTransfer created.")},h=function(b){d.debug("DataTransfer: Received data:"+b.data),a.dataReceiver?a.dataReceiver.onMessage(b):d.warn("The default data receiver is still initialized to receive data.")},i=function(c){a.origDataChannel&&(a.origDataChannel=null),a.state="open",b(),e();var f=a.dataChannel.readyState;null==a.label&&(a.label=a.dataChannel.label),d.debug('Data Channel "'+a.dataChannel.label+'" is open; current readyState: '+f),a.dataChannel.disabled=!1,a.dataChannel.onmessage=h,a.onOpen&&a.onOpen(c)},j=function(b){if(a.origDataChannel&&b.target&&a.origDataChannel.id!=b.target.id)return a.dataChannel=a.origDataChannel,void(a.origDataChannel=null);a.state="closed";var c=a.dataChannel.readyState;null==a.label&&(a.label=a.dataChannel.label),d.debug('Data Channel "'+a.dataChannel.label+'" is closing; current readyState is: '+c),a.dataChannel.disabled=!0,a.onClose&&a.onClose(b)},k=function(b){d.debug("Received dataChannel error event for DataTransfer: "+a.dataChannel.label),a.onError&&a.onError(b)};this.initDataChannel=function(b,e){if(d.debug("DataTransfer object initialized by the dataChannel."),e&&(a.origDataChannel=a.dataChannel),a.dataChannel=b,a.state="starting",a.label=b.label,a.dataChannel)try{a.dataChannel.onopen=i,(c.isIE||c.isSafari)&&"open"==a.dataChannel.readyState&&setTimeout(function(){var b=null;try{b=new Event("open")}catch(a){b=document.createEvent("Event"),b.initEvent("open",!1,!1)}i.call(a.dataChannel,b)},0),a.dataChannel.onerror=k,a.dataChannel.onclose=j}catch(a){d.error("Exception occured when initializing the callback functions of the data channel: "+a)}else d.error("Could not initialize the data channel with null.")},this.clear=function(){try{null!=a.dataChannel&&(a.dataChannel.close(),a.dataChannel.disabled=!0,d.info("DataTransfer closed its data channel; current readyState is: "+a.dataChannel.readyState)),d.info("DataTransfer object cleared")}catch(a){d.error("Recieved an exception when cleaning the DataTransfer object: "+a)}},this.toJSON=function(){var a={},b={session:"",pkgInstance:""};for(var c in this)c in b||(a[c]=this[c]);return a}};e.prototype={getState:function(){return this.state},getSender:function(){return this.dataSender},getReceiver:function(){return this.dataReceiver}};var f=function(a){this.dataChannel=a};f.prototype={send:function(a){if(null!=this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(a)}catch(a){throw d.debug("Exception when sending data by dataChannel: "+a),a}else d.error("Error when sending data. The dataChannel is not in a valid state.")}};var g=function(){this.onMessage=function(a){d.info("onMessage function is not overridden by the application. New received data is handle by the default DataReceiver object."+a.data)}};return g.prototype={},b.DataTransfer=e,b.DataSender=f,b.DataReceiver=g,a}(cloud||{});window.console||(console={log:function(){},info:function(){},debug:function(){},warn:function(){},error:function(){}}),"function"!=typeof Date.prototype.now&&(Date.now=function(){return+new Date}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"==typeof Error.prototype.stack&&(Error.prototype.stack="Error:\n\n\n\n\n"),Array.prototype.some||(Array.prototype.some=function(a){"use strict";if(null==this)throw new TypeError("Array.prototype.some called on null or undefined");if("function"!=typeof a)throw new TypeError;for(var b=Object(this),c=b.length>>>0,d=arguments.length>=2?arguments[1]:void 0,e=0;e<c;e++)if(e in b&&a.call(d,b[e],e,b))return!0;return!1});var browserIsIE=!1,IEversion=null;if(navigator.userAgent.indexOf("MSIE")!=-1)var ie_regexp=/MSIE (\d+\.\d+);/;else var ie_regexp=/Trident.*rv[ :]*(\d+\.\d+)/;ie_regexp.test(navigator.userAgent)&&(browserIsIE=!0,IEversion=new Number(RegExp.$1),console.log("Browser is IE, version "+IEversion)),browserIsIE&&IEversion<=9&&(baseconsole=console,9==IEversion&&(console={log:function(a){baseconsole.log(a)},info:function(a){baseconsole.info(a)},debug:function(a){baseconsole.log(a)},warn:function(a){baseconsole.warn(a)},error:function(a){baseconsole.error(a)},clear:function(a){baseconsole.clear(a)},assert:function(a){baseconsole.assert(a)},dir:function(a){baseconsole.dir(a)},profile:function(a){baseconsole.profile(a)},profileEnd:function(a){baseconsole.profileEnd(a)}}),IEversion<=8&&(console={log:function(a){baseconsole.log(a)},info:function(a){baseconsole.info(a)},debug:function(a){baseconsole.log(a)},warn:function(a){baseconsole.warn(a)},error:function(a){baseconsole.error(a)},clear:function(a){baseconsole.clear(a)},assert:function(a){baseconsole.assert(a)}}));var cloud=function(a){function b(a){function b(b){void 0!==window.__disable_mos_notification__&&window.__disable_mos_notification__===!0||a.conversation.relayDataTo(a.streamId,b,r,p)}function c(a,b,d){if(void 0!==a&&void 0!==b){var e,f,g=c[d]=c[d]||{lastPacketsLost:void 0,lastPacketsTransmitted:void 0,lastEffectivePacketsTransmitted:void 0,keepCount:999};return e=d.indexOf("audio.")>-1?t.__audioPacketsLostKeepLimit:t.__videoPacketsLostKeepLimit,void 0!==g.lastPacketsLost?a<=g.lastPacketsLost?(g.keepCount=g.keepCount+1,f=g.keepCount<=e?-1:0):(f=g.keepCount<=e?(a-g.lastPacketsLost)/(a-g.lastPacketsLost+(b-g.lastEffectivePacketsTransmitted)):-1,g.lastEffectivePacketsTransmitted=b,g.keepCount=0):f=-1,g.lastPacketsLost=a,g.lastPacketsTransmitted=b,f}}function e(b,d){if("audio"==b.mediaType){if(b.id.indexOf("_recv")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesReceived-n[b.id].bytesReceived)),E.audio.inbound.bitRate.put(e),E.audio.inbound.jitter.put(b.googJitterReceived);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,h=b.packetsReceived-n[b.id].packetsReceived;f=c(b.packetsLost,b.packetsReceived,"audio.inbound")}if(E.audio.inbound.packetsLost=g,E.audio.inbound.packetsReceived=h,E.audio.inbound.packetLossRate.put(f),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}else if(b.id.indexOf("_send")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesSent-n[b.id].bytesSent)),E.audio.outbound.bitRate.put(e),E.audio.outbound.rtt.put(b.googRtt),E.audio.outbound.jitter.put(b.googJitterReceived);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,l=b.packetsSent-n[b.id].packetsSent;f=c(b.packetsLost,b.packetsSent,"audio.outbound")}if(E.audio.outbound.packetsLost=g,E.audio.outbound.packetsSent=l,E.audio.outbound.packetLossRate.put(f),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}}else if("video"==b.mediaType)if(b.id.indexOf("_recv")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesReceived-n[b.id].bytesReceived)),E.video.inbound.bitRate.put(e),E.video.inbound.jitter.put(b.googJitterReceived);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,h=b.packetsReceived-n[b.id].packetsReceived;f=c(b.packetsLost,b.packetsReceived,"video.inbound")}if(E.video.inbound.packetsLost=g,E.video.inbound.packetsReceived=h,E.video.inbound.packetLossRate.put(f),E.video.inbound.frameRate.triggerPut(b.googFrameRateReceived,"onNewInboundFrameRate"),E.video.inbound.resolutionWidth.triggerPut(b.googFrameWidthReceived,"onNewInboundResolution",[b.googFrameWidthReceived,b.googFrameHeightReceived]),E.video.inbound.resolutionHeight.put(b.googFrameHeightReceived),E.video.outbound.firsSent.put(1*b.googFirsSent),E.video.outbound.nacksSent.put(1*b.googNacksSent),E.video.outbound.plisSent.put(1*b.googPlisSent),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}else if(b.id.indexOf("_send")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesSent-n[b.id].bytesSent)),E.video.outbound.bitRate.put(e),E.video.outbound.rtt.put(b.googRtt);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,l=b.packetsSent-n[b.id].packetsSent;f=c(b.packetsLost,b.packetsSent,"video.outbound")}if(E.video.outbound.packetsLost=g,E.video.outbound.packetsSent=l,E.video.outbound.packetLossRate.put(f),E.video.outbound.frameRate.triggerPut(b.googFrameRateSent,"onNewOutboundFrameRate"),E.video.outbound.resolutionWidth.triggerPut(b.googFrameWidthSent,"onNewOutboundResolution",[b.googFrameWidthSent,b.googFrameHeightSent]),E.video.outbound.resolutionHeight.put(b.googFrameHeightSent),E.video.inbound.firsReceived.put(1*b.googFirsReceived),E.video.inbound.nacksReceived.put(1*b.googNacksReceived),E.video.inbound.plisReceived.put(1*b.googPlisReceived),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}}function f(b,d){if(b.id.indexOf("inbound_rtp_audio")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesReceived-n[b.id].bytesReceived)),E.audio.inbound.bitRate.put(e),E.audio.inbound.jitter.put(1e3*b.jitter);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,h=b.packetsReceived-n[b.id].packetsReceived;f=c(b.packetsLost,b.packetsReceived,"audio.inbound")}if(E.audio.inbound.packetsLost=g,E.audio.inbound.packetsReceived=h,E.audio.inbound.packetLossRate.put(f),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}else if(b.id.indexOf("outbound_rtp_audio")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesSent-n[b.id].bytesSent)),E.audio.outbound.bitRate.put(e),rtt=void 0,d[b.remoteId]&&(rtt=1e3*d[b.remoteId].mozRtt,rtt=0),E.audio.outbound.rtt.put(rtt),jitter=void 0,d[b.remoteId]&&(jitter=1e3*d[b.remoteId].jitter),E.audio.outbound.jitter.put(jitter);var f=void 0;if(n&&n[b.id]&&d[b.remoteId]&&n[b.remoteId]){var g=d[b.remoteId].packetsLost-n[b.remoteId].packetsLost,l=d[b.remoteId].packetsReceived-n[b.remoteId].packetsReceived;f=c(d[b.remoteId].packetsLost,d[b.remoteId].packetsReceived,"audio.outbound")}if(E.audio.outbound.packetsLost=g,E.audio.outbound.packetsSent=l,E.audio.outbound.packetLossRate.put(f),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}else if(b.id.indexOf("inbound_rtp_video")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesReceived-n[b.id].bytesReceived)),E.video.inbound.bitRate.put(e),E.video.inbound.jitter.put(1e3*b.jitter);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,h=b.packetsReceived-n[b.id].packetsReceived;f=c(b.packetsLost,b.packetsReceived,"video.inbound")}if(E.video.inbound.packetsLost=g,E.video.inbound.packetsReceived=h,E.video.inbound.packetLossRate.put(f),E.video.inbound.frameRate.triggerPut(b.framerateMean,"onNewInboundFrameRate"),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}else if(b.id.indexOf("outbound_rtp_video")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesSent-n[b.id].bytesSent)),E.video.outbound.bitRate.put(e),rtt=void 0,d[b.remoteId]&&(rtt=1e3*d[b.remoteId].mozRtt,rtt=0),E.video.outbound.rtt.put(rtt),jitter=void 0,d[b.remoteId]&&(jitter=1e3*d[b.remoteId].jitter),E.video.outbound.jitter.put(jitter);var f=void 0;if(n&&n[b.id]&&d[b.remoteId]&&n[b.remoteId]){var g=d[b.remoteId].packetsLost-n[b.remoteId].packetsLost,l=d[b.remoteId].packetsReceived-n[b.remoteId].packetsReceived;f=c(d[b.remoteId].packetsLost,d[b.remoteId].packetsReceived,"video.outbound")}if(E.video.outbound.packetsLost=g,E.video.outbound.packetsSent=l,E.video.outbound.packetLossRate.put(f),E.video.outbound.frameRate.triggerPut(b.framerateMean,"onNewOutboundFrameRate"),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId,j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}else if("candidatepair"===b.type&&"succeeded"===b.state&&b.selected){var m=b.localCandidateId,k=d[m].candidateType;a.userIp=d[m].ipAddress,a.url=d[m].ipAddress+":"+d[m].portNumber,a.sessionType=k,a.protocol=F(k)}}function g(b,d){if(b.googFrameRateReceived||b.googFrameRateSent){if(b.googFrameRateReceived||b.googFrameRateSent)if(b.id.indexOf("_recv")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesReceived-n[b.id].bytesReceived)),E.video.inbound.bitRate.put(e),E.video.inbound.jitter.put(b.googJitterReceived);var f=void 0;if(n&&n[b.id]){var g=1*b.packetsLost-1*n[b.id].packetsLost,h=1*b.packetsReceived-1*n[b.id].packetsReceived;f=c(1*b.packetsLost,1*b.packetsReceived,"video.inbound")}if(E.video.inbound.packetsLost=g,E.video.inbound.packetsReceived=h,E.video.inbound.packetLossRate.put(f),b.googFrameRateInput?E.video.inbound.frameRate.triggerPut(b.googFrameRateInput,"onNewInboundFrameRate"):b.googFrameRateReceived&&E.video.inbound.frameRate.triggerPut(b.googFrameRateReceived,"onNewInboundFrameRate"),b.googFrameWidthInput&&b.googFrameHeightInput?(E.video.inbound.resolutionWidth.triggerPut(b.googFrameWidthInput,"onNewInboundResolution",[b.googFrameWidthInput,b.googFrameHeightInput]),E.video.inbound.resolutionHeight.put(b.googFrameHeightInput)):b.googFrameWidthReceived&&b.googFrameHeightReceived&&(E.video.inbound.resolutionWidth.triggerPut(b.googFrameWidthReceived,"onNewInboundResolution",[b.googFrameWidthReceived,b.googFrameHeightReceived]),E.video.inbound.resolutionHeight.put(b.googFrameHeightReceived)),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId;if(void 0!==i){var j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}}else if(b.id.indexOf("_send")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesSent-n[b.id].bytesSent)),E.video.outbound.bitRate.put(e),E.video.outbound.rtt.put(b.googRtt);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,l=b.packetsSent-n[b.id].packetsSent;f=c(b.packetsLost,b.packetsSent,"video.outbound")}if(E.video.outbound.packetsLost=g,E.video.outbound.packetsSent=l,E.video.outbound.packetLossRate.put(f),E.video.outbound.frameRate.triggerPut(b.googFrameRateSent,"onNewOutboundFrameRate"),E.video.outbound.resolutionWidth.triggerPut(b.googFrameWidthSent,"onNewOutboundResolution",[b.googFrameWidthSent,b.googFrameHeightSent]),E.video.outbound.resolutionHeight.put(b.googFrameHeightSent),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId;if(void 0!==i){var j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}}}else if(b.id.indexOf("_recv")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesReceived-n[b.id].bytesReceived)),E.audio.inbound.bitRate.put(e),E.audio.inbound.jitter.put(b.googJitterReceived);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,h=b.packetsReceived-n[b.id].packetsReceived;f=c(b.packetsLost,b.packetsReceived,"audio.inbound")}if(E.audio.inbound.packetsLost=g,E.audio.inbound.packetsReceived=h,
E.audio.inbound.packetLossRate.put(f),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId;if(void 0!==i){var j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}}else if(b.id.indexOf("_send")>-1){var e=void 0;n&&n[b.id]&&(e=8*(b.bytesSent-n[b.id].bytesSent)),E.audio.outbound.bitRate.put(e),E.audio.outbound.rtt.put(b.googRtt),E.audio.outbound.jitter.put(b.googJitterReceived);var f=void 0;if(n&&n[b.id]){var g=b.packetsLost-n[b.id].packetsLost,l=b.packetsSent-n[b.id].packetsSent;f=c(b.packetsLost,b.packetsSent,"audio.outbound")}if(E.audio.outbound.packetsLost=g,E.audio.outbound.packetsSent=l,E.audio.outbound.packetLossRate.put(f),b.transportId&&b.transportId.indexOf("Channel-")>-1){var i=d[b.transportId].selectedCandidatePairId;if(void 0!==i){var j=d[i].googLocalAddress.split(":");a.userIp=j[0],a.url=d[i].googRemoteAddress;var k=d[i].googLocalCandidateType;a.sessionType=k,a.protocol=F(k)}}}}function h(a){h.__headerPrinted||(h.__headerPrinted=!0,l.debug("==audio==inbound.bitRate,inbound.rtt,inbound.packetsReceived,inbound.packetsLost,inbound.jitter,inbound.packetLossRate,outbound.bitRate,outbound.rtt,outbound.packetsSent,outbound.packetsLost,outbound.jitter,outbound.packetLossRate,inbound.mos,outbound.mos,inbound.publishedMos,outbound.publishedMos"),l.debug("==video==inbound.bitRate,inbound.rtt,inbound.packetsReceived,inbound.packetsLost,inbound.jitter,inbound.packetLossRate,inbound.frameRate,inbound.resolutionWidth*inbound.resolutionHeight,outbound.bitRate,outbound.rtt,outbound.packetsSent,outbound.packetsLost,outbound.jitter,outbound.packetLossRate,outbound.frameRate,outbound.resolutionWidth*outbound.resolutionHeight,inbound.mos,outbound.mos,inbound.publishedMos,outbound.publishedMos")),l.debug("==audio=="+E.audio.inbound.bitRate.value+","+E.audio.inbound.rtt.value+","+E.audio.inbound.packetsReceived+","+E.audio.inbound.packetsLost+","+E.audio.inbound.jitter.value+","+E.audio.inbound.packetLossRate.value+","+E.audio.outbound.bitRate.value+","+E.audio.outbound.rtt.value+","+E.audio.outbound.packetsSent+","+E.audio.outbound.packetsLost+","+E.audio.outbound.jitter.value+","+E.audio.outbound.packetLossRate.value+","+E.mos.inbound.audio.lastValue+","+E.mos.outbound.audio.lastValue+","+E.mos.inbound.audio.publishedValue+","+E.mos.outbound.audio.publishedValue),l.debug("==video=="+E.video.inbound.bitRate.value+","+E.video.inbound.rtt.value+","+E.video.inbound.packetsReceived+","+E.video.inbound.packetsLost+","+E.video.inbound.jitter.value+","+E.video.inbound.packetLossRate.value+","+E.video.inbound.frameRate.value+","+E.video.inbound.resolutionWidth.value+"*"+E.video.inbound.resolutionHeight.value+","+E.video.outbound.bitRate.value+","+E.video.outbound.rtt.value+","+E.video.outbound.packetsSent+","+E.video.outbound.packetsLost+","+E.video.outbound.jitter.value+","+E.video.outbound.packetLossRate.value+","+E.video.outbound.frameRate.value+","+E.video.outbound.resolutionWidth.value+"*"+E.video.outbound.resolutionHeight.value+","+E.mos.inbound.video.lastValue+","+E.mos.outbound.video.lastValue+","+E.mos.inbound.video.publishedValue+","+E.mos.outbound.video.publishedValue),l.debug("==stats==",a)}var j="initial",k=null,m=1e3,n=null,o=a.conversation.getParticipants(),p={},q={},r="__wsc_internal_quality_monitor_new_status__",s=a.conversation.getLocalParticipant().getStreamInfo(a.avStream.getId()),t=s.getQualityMonitor(),u=t.factorMonitors,v=a.callConfig,w=null,x=function(a,b){this.value,this.isVideo=a,this.isInbound=b,this.statistics={peak:0,bottom:0,count:0,sdv:0,mean:0,oldMean:0,S:0,oldS:0}};x.prototype={put:function(a){return void 0===a||isNaN(a)?void(this.value=void 0):a<0?void(this.value=a):(a=1*a,this.value=a,this.statistics.count++,1===this.statistics.count?(this.statistics.peak=a,this.statistics.bottom=a):(this.statistics.peak<a&&(this.statistics.peak=a),this.statistics.bottom>a&&(this.statistics.bottom=a)),void(1==this.statistics.count?this.statistics.oldMean=this.statistics.mean=a:(this.statistics.mean=this.statistics.oldMean+(a-this.statistics.oldMean)/this.statistics.count,this.statistics.S=this.statistics.oldS+(a-this.statistics.oldMean)*(a-this.statistics.mean),this.statistics.oldMean=this.statistics.mean,this.statistics.oldS=this.statistics.S,this.statistics.sdv=this.statistics.count>1?Math.sqrt(this.statistics.S/(this.statistics.count-1)):0)))},alarmPut:function(b,c,d,e){void 0===this.publishedValue&&(this.publishedValue=i.ExperienceStatus.NOT_AVAILABLE,this.lastValue=i.ExperienceStatus.NOT_AVAILABLE,this.keepCount=0);var f=this.publishedValue;if(z(this))b!=this.publishedValue&&(b===this.lastValue?(this.keepCount=this.keepCount+1,this.keepCount===t.__keepCount&&(this.publishedValue=b)):this.keepCount=1,e===!0&&(this.publishedValue=b));else{var g=a.callState.state===i.CALLSTATE.UPDATING?a.lastCallConfig:a.callConfig;if(g.audioConfig===v.audioConfig&&g.videoConfig===v.videoConfig)return;this.publishedValue=i.ExperienceStatus.NOT_AVAILABLE,d={},b=i.ExperienceStatus.NOT_AVAILABLE}var h=u[c];f!==this.publishedValue?("function"==typeof h&&h.call(t,this.publishedValue,d),p[c]={value:this.publishedValue,hints:d}):"function"==typeof h&&"function"!=typeof q[c]&&h.call(t,this.publishedValue,d),q[c]=h,this.lastValue=b,this.put(b)},triggerPut:function(a,b,c){var d=a&&Math.floor(a),e=this.value&&Math.floor(this.value),f=t[b];c||(c=[d]),e!==d?"function"==typeof f&&(f.apply(t,c),q[b]=f):"function"==typeof f&&"function"!=typeof q[b]&&(f.call(t,c),q[b]=f),this.put(a)},toJSON:function(){return{peak:void 0===this.statistics.peak?void 0:this.statistics.peak%1===0?this.statistics.peak:1*this.statistics.peak.toFixed(2),bottom:void 0===this.statistics.bottom?void 0:this.statistics.bottom%1===0?this.statistics.bottom:1*this.statistics.bottom.toFixed(2),count:this.statistics.count,sdv:void 0===this.statistics.sdv?void 0:this.statistics.sdv%1===0?this.statistics.sdv:1*this.statistics.sdv.toFixed(2),mean:void 0===this.statistics.mean?void 0:this.statistics.sdv%1===0?this.statistics.sdv:1*this.statistics.mean.toFixed(2)}}};var y=function(a,b){this.value,this.isVideo=a,this.isInbound=b};y.prototype={put:function(a){this.value=a},toJSON:function(){return this.value}};var z=function(b){var c=a.callConfig;return a.callState.state===i.CALLSTATE.UPDATING&&(c=a.lastCallConfig),b.isInbound&&b.isVideo&&c.shouldReceiveVideo()||b.isInbound&&!b.isVideo&&c.shouldReceiveAudio()||!b.isInbound&&b.isVideo&&c.shouldSendVideo()||!b.isInbound&&!b.isVideo&&c.shouldSendAudio()},A=!0,B=!1,C=!0,D=!1,E={audio:{inbound:{bitRate:new x(B,C),rtt:new x(B,C),jitter:new x(B,C),packetLossRate:new x(B,C)},outbound:{bitRate:new x(B,D),rtt:new x(B,D),jitter:new x(B,D),packetLossRate:new x(B,D)}},video:{inbound:{bitRate:new x(A,C),rtt:new x(A,C),jitter:new x(A,C),packetLossRate:new x(A,C),frameRate:new x(A,C),resolutionWidth:new x(A,C),resolutionHeight:new x(A,C),firsReceived:new y(A,C),nacksReceived:new y(A,C),plisReceived:new y(A,C)},outbound:{bitRate:new x(A,D),rtt:new x(A,D),jitter:new x(A,D),packetLossRate:new x(A,D),frameRate:new x(A,D),resolutionWidth:new x(A,D),resolutionHeight:new x(A,D),firsSent:new y(A,D),nacksSent:new y(A,D),plisSent:new y(A,D)}},mos:{inbound:{transmission:new x,video:new x(A,C),audio:new x(B,C)},outbound:{transmission:new x,video:new x(A,D),audio:new x(B,D)},environment:new x}};E.calculateInboundVideoMOS=function(){var a,b=this.video.inbound.packetLossRate.value,c=this.video.inbound.frameRate.value;if(void 0!==b&&void 0!==c)if(c<=t.__frameRateThreshold)a=i.ExperienceStatus.BAD;else{if(b<0)return;a=b>=t.__videoPacketLossRateThreshold?i.ExperienceStatus.BAD:i.ExperienceStatus.GOOD}else a=i.ExperienceStatus.NOT_AVAILABLE;this.mos.inbound.video.alarmPut(a,i.ExperienceFactor.VIDEO_INBOUND,{packetLossRate:this.video.inbound.packetLossRate.value,frameRate:this.video.inbound.frameRate.value})},E.calculateOutboundVideoMOS=function(){var a,b=this.video.outbound.packetLossRate.value,c=this.video.outbound.frameRate.value,d=this.video.outbound.rtt.value;if(void 0!==b&&void 0!==c&&void 0!==d)if(c<=t.__frameRateThreshold)a=i.ExperienceStatus.BAD;else if(d>=t.__videoOutboundRttThreshold)a=i.ExperienceStatus.BAD;else{if(b<0)return;a=b>=t.__videoPacketLossRateThreshold?i.ExperienceStatus.BAD:i.ExperienceStatus.GOOD}else a=i.ExperienceStatus.NOT_AVAILABLE;this.mos.outbound.video.alarmPut(a,i.ExperienceFactor.VIDEO_OUTBOUND,{packetLossRate:b,frameRate:c,rtt:d})},E.calculateInboundAudioMOS=function(){if(!d.browser.isFirefox){var a,b=this.audio.inbound.jitter.value,c=this.audio.inbound.packetLossRate.value;if(void 0!==b&&void 0!==c)if(b>=t.__jitterThreshold)a=i.ExperienceStatus.BAD;else{if(c<0)return;a=c>=t.__audioPacketLossRateThreshold?i.ExperienceStatus.BAD:i.ExperienceStatus.GOOD}else a=i.ExperienceStatus.NOT_AVAILABLE;this.mos.inbound.audio.alarmPut(a,i.ExperienceFactor.AUDIO_INBOUND,{packetLossRate:c,jitter:b})}},E.calculateOutboundAudioMOS=function(){if(!d.browser.isFirefox){var a,b=this.audio.outbound.jitter.value,c=this.audio.outbound.packetLossRate.value,e=this.audio.outbound.rtt.value;if(void 0!==b&&void 0!==c&&void 0!==e)if(b>=t.__jitterThreshold)a=i.ExperienceStatus.BAD;else if(e>=t.__audioOutboundRttThreshold)a=i.ExperienceStatus.BAD;else{if(c<0)return;a=c>=t.__audioPacketLossRateThreshold?i.ExperienceStatus.BAD:i.ExperienceStatus.GOOD}else a=i.ExperienceStatus.NOT_AVAILABLE;this.mos.outbound.audio.alarmPut(a,i.ExperienceFactor.AUDIO_OUTBOUND,{packetLossRate:c,jitter:b,rtt:e})}},E.calculateMOS=function(){if(this.calculateInboundVideoMOS(),this.calculateOutboundVideoMOS(),this.calculateInboundAudioMOS(),this.calculateOutboundAudioMOS(),Object.keys(p).length>0)b("*");else{var c=a.conversation.getParticipants(),d=[];c.forEach(function(a){o.indexOf(a)===-1&&d.push.apply(d,a.getStreamInfos())}),d.length>0&&(p={},void 0!==this.mos.inbound.audio.publishedValue&&(p[i.ExperienceFactor.AUDIO_INBOUND]={value:this.mos.inbound.audio.publishedValue,hints:{packetLossRate:this.audio.inbound.packetLossRate.value,jitter:this.audio.inbound.jitter.value}}),void 0!==this.mos.inbound.video.publishedValue&&(p[i.ExperienceFactor.VIDEO_INBOUND]={value:this.mos.inbound.video.publishedValue,hints:{packetLossRate:this.video.inbound.packetLossRate.value,frameRate:this.video.inbound.frameRate.value}}),void 0!==this.mos.outbound.audio.publishedValue&&(p[i.ExperienceFactor.AUDIO_OUTBOUND]={value:this.mos.outbound.audio.publishedValue,hints:{packetLossRate:this.audio.outbound.packetLossRate.value,jitter:this.audio.outbound.jitter.value,rtt:this.audio.outbound.rtt.value}}),void 0!==this.mos.outbound.video.publishedValue&&(p[i.ExperienceFactor.VIDEO_OUTBOUND]={value:this.mos.outbound.video.publishedValue,hints:{packetLossRate:this.video.outbound.packetLossRate.value,frameRate:this.video.outbound.frameRate.value,rtt:this.video.outbound.rtt.value}}),b(d))}o=a.conversation.getParticipants(),p={}},E.cleanProperties=function(){delete this.audio.inbound.packetsReceived,delete this.audio.inbound.packetsLost,delete this.audio.outbound.packetsSent,delete this.audio.outbound.packetsLost,delete this.video.inbound.packetsReceived,delete this.video.inbound.packetsLost,delete this.video.outbound.packetsSent,delete this.video.outbound.packetsLost};var F=function(a){var b=void 0;return"local"===a||"host"===a?b=i.PROTOCOL.HOST:"srflx"===a?b=i.PROTOCOL.STUN:"relay"!==a&&"relayed"!==a||(b=i.PROTOCOL.TURN),b},G=function(b){if(null!=n)try{for(var c in b){var j=b[c];d.browser.isChrome?e(j,b):d.browser.isFirefox?f(j,b):(d.browser.isIE||d.browser.isSafari)&&g(j,b)}E.calculateMOS(),void 0!==window.__debug_monitor_data_detail__&&window.__debug_monitor_data_detail__===!0&&h(b)}catch(a){l.debug("Error happens when extractDataFromStats: ",a)}v=a.callState.state===i.CALLSTATE.UPDATING?a.lastCallConfig:a.callConfig,n=b},H=function(){var a=i.ExperienceStatus.NOT_AVAILABLE;E.mos.inbound.audio.alarmPut(a,i.ExperienceFactor.AUDIO_INBOUND,{},!0),E.mos.inbound.video.alarmPut(a,i.ExperienceFactor.VIDEO_INBOUND,{},!0),E.mos.outbound.audio.alarmPut(a,i.ExperienceFactor.AUDIO_OUTBOUND,{},!0),E.mos.outbound.video.alarmPut(a,i.ExperienceFactor.VIDEO_OUTBOUND,{},!0),b("*")},I=function(){var b=a.getPeerConnection();null==b||"connected"!==b.iceConnectionState&&"completed"!==b.iceConnectionState||(w=b.iceConnectionState,b.getStats(null,function(a){G(a)},function(a){l.warn("Error when get statistics.",a)})),null!=b&&"disconnected"===b.iceConnectionState&&"disconnected"!==w&&(w="disconnected",H()),k=setTimeout(I,m)};this.getReports=function(){return E.cleanProperties(),E},this.start=function(){"running"!==j&&(j="running",I())},this.stop=function(){j="stopped",clearTimeout(k)}}function c(a){var b=3,c=0,e=function(e){if(e&&(null===a.peerConnection||void 0===a.peerConnection))return l.debug("call.peerConnection: "+a.peerConnection+", the call may need to be updated."),!0;var f=a.getIceConnectionState();return"connected"===f&&c>0&&(l.debug("ICE connection state gets to 'connected', reset the counter to 0."),c=0),c>=b?(l.debug("No more updating. Have updated call to restore ICE failure for "+c+" times."),!1):d.browser.isFirefox?"closed"===f:"failed"===f||e&&"closed"===f},f=function(){var b=a.callState;return b.state===i.CALLSTATE.ESTABLISHED||b.state===i.CALLSTATE.UPDATE_FAILED||b.state===i.CALLSTATE.UPDATED},g=function(){var b="Call state: "+a.callState.state+", ICE connection state: "+(a.peerConnection?a.getIceConnectionState():"peerConnection is null")+", Retry number: "+(c+1);f()&&e(!0)?(c+=1,l.debug("Do call update to fix the ICE failure. "+b),a.update(a.callConfig)):l.debug("No update is needed to fix the ICE failure. "+b)},h=function(b){var c=a.session.lastActiveTime,d=function(){c!=a.session.lastActiveTime?(l.debug("Waiting for receiving any message from session web socket... Done"),b()):setTimeout(function(){d()},50)};d()};this.updateIceConnectionState=function(b){b.target===a.peerConnection&&e()&&f()&&(l.debug("Waiting for receiving any message from session web socket... "),h(function(){var b=a.session.sessionState;if(b===i.SESSIONSTATE.CONNECTED)g();else{l.debug("Session state: "+b+", waiting for session state CONNECTED.");var c=a.session.setSessionState.bind(a.session);a.session.setSessionState=function(b){return b===i.SESSIONSTATE.CONNECTED&&(a.session.setSessionState=c,g()),c(b)}}}))}}var d=a._private=a._private||{},e={},f=d.CallStateMachine,g=d.CallCommonUtils,h=d.rtcHelper,i=d.wscConst,j=d.wscUtils,k=d.DataTransfer,l=a.getLogger(),m=(a.getLogLevel(),new WeakMap),n=function(a,b){"use strict";if(!a){var c="The parameter 'session' cannot be null!";throw l.error(c),c}b?this.packageType=b:this.packageType=i.PACKAGE.CALL,a.registerPackage(this),this.session=a,this.trickleIceMode="off",this.ipv6=!1,this.dscp=!1,this.videoSendBitrate=!1,this.videoRecvBitrate=!1,this.removeVideoFec=!1,this.onIncomingCall=null,this.onResurrect=null};n.prototype={getCalls:function(){"use strict";var a=[],b=this.session.getSubSessionsByPackageType(this.packageType),c=null;if(b){c=b.values();for(var d=0;d<c.length;d++)a[d]=c[d]}return a},createCall:function(a,b,c){"use strict";var d,e,f=this.session,g=this.session.userName;if(null==a||""===a)throw e="The callee cannot be empty!",l.warn(e),"CallPackage.createCall(): Empty callee exception.";return d=this.prepareCall(f,b,g,a),d.subSessionId=f.generateSubSessionId(),d.onCallError=c,d.pkgInstance=this,this.putCall(d.subSessionId,d),d},close:function(){"use strict";for(var a=this.getCalls(),b=0;b<a.length;b++){var c=a[b];c.end(),c=null}},clear:function(){for(var a=this.getCalls(),b=0;b<a.length;b++){var c=a[b];e.clearCall(c),c=null}},onMessage:function(a){"use strict";var b=this.session,c=a.control.subsession_id,d=this.session.getSubSession(c),e=a.getExtHeaders();null==d&&(d=this.prepareCall(b),d.pkgInstance=this),e&&(d.lastServerExtHeader=e),d.onMessage(a)},onRehydration:function(b){"use strict";for(var c in b.entry){var d=b.entry[c],e=d.caller,f=d.callee,g=d.callConfig,i=new a.CallConfig(g.audioConfig,g.videoConfig,g.dataChannelConfig),j=this.prepareCall(this.session,i,e,f);j.pkgInstance=this,j.callState=new a.CallState(d.callState.state,d.callState.status.code,d.callState.status.reason),j.earlyMediaState=d.earlyMediaState,j.subSessionId=d.subSessionId;var k;if(d.remoteMedias&&d.remoteMedias.length){k=[];for(var l=0;l<d.remoteMedias.length;l++){var m=d.remoteMedias[l],n=new h.Media(m.mode,m.port,m.type);k[l]=n}}j.remoteMedias=k,j.offerAnswerManager.updateState(d.offerAnswerManager.masterState),j.offerAnswerManager.updateState(d.offerAnswerManager.slaveState),j.iceTimeout=d.iceTimeout,j.streamId=d.streamId,j.streamType=d.streamType,j.shortCircuitMode=d.shortCircuitMode,this.putCall(c,j),this.onResurrect(j)}},prepareCall:function(a,b,c,d){"use strict";return new o(a,b,c,d)},putCall:function(a,b){this.session.putSubSession(this.packageType,a,b)},setTrickleIceMode:function(a){this.trickleIceMode=a},setIPv6:function(a){this.ipv6=a},setDSCP:function(a){this.dscp=a},setVideoSendBitrate:function(a){this.videoSendBitrate=a},setVideoRecvBitrate:function(a){this.videoRecvBitrate=a},setRemoveVideoFec:function(a){this.removeVideoFec=a},toJSON:function(){var a={},b={session:""};for(var c in this)c in b||(a[c]=this[c]);return a}};var o=function(b,f,j,k){this.session=b,this.caller=j,this.callee=k,this.callConfig=f,this.dataTransfers=new a.Map,this.lastCallConfig=null,this.callState=new a.CallState(i.CALLSTATE.NONE,null,""),this.earlyMediaState=null,this.resumeState=null,this.peerConnection=null,this.onMediaStreamEvent=null,this.onCallStateChange=null,this.onIceConnectionStateChange=null,this.onDataTransfer=null,this.errorLog=[],this.eventLog=[],this.onUpdate=null,this.onCallError=null,this.streamAddTimes=0,this.hungupCallback=null,this.subSessionId=null,this.conversation=null,this.avStream=null,this.streamId="default",this.streamType="audiovideo",this.shortCircuitMode=!1,this.startReqCorrId=null,this.newRemoteSDP=null,this.newRemoteMedias=null,this.remoteMedias=null,this.localMediaStreams=[],this.temporarySavedStreams=[],this.offerAnswerManager=new d.offerAnswerManager(this),this.userIp=null,this.sessionType=null,this.protocol=null,this.url=null,this.callStartOnIceResponse=!1,this.timeRecording={timeToNewPeerConnection:{},timeToGetUserMedia:{},timeToMakeCall:{},timeToGetIceConnection:{},timeToGetIceCandidates:{},timeToGetRemoteMedia:{}};var l=2e3;this.setIceCheckInterval=function(a){if(a<=0)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};l=a},this.getIceCheckInterval=function(){return l},this.setCapabilityExchange=function(a){this.capabilityExchange=a},this._template={doStartCallRequest:function(a){var b=a.payload.sdp,c=this.parent,d=h.getCallConfigFromRemoteSDP(b,!1),e=h.getCallConfigFromRemoteSDP(b,!0),f=this.parent.callState,i=a.control.subsession_id,j=a.getExtHeaders();c.callConfig=d,c.newRemoteSDP=a.payload,c.newRemoteMedias=h.getMediaFromSDP(b),c.conversation?c.pkgInstance.putCall(i,c.conversation):c.pkgInstance.putCall(i,c),f.is180Ringing()||g.send180Ringing(c);var k=c.pkgInstance.onIncomingCall;k&&(c.conversation?k(c.conversation,c.avStream,e,j):k(c,e,j))},doUpdateCallRequest:function(a){var b=a.payload.sdp,c=this.parent,d=h.getCallConfigFromRemoteSDP(b),f=a.getExtHeaders();c.lastCallConfig=c.callConfig,c.callConfig=d,c.newRemoteMedias=h.getMediaFromSDP(b),c.newRemoteSDP=a.payload,e.handleUpdateCallRequest(c,f)},doStartUnReliableProvRespWithSDP:function(a){e.handleAnswer(this.parent,a.payload)},doStart2XXResponse:function(a){e.handleAnswer(this.parent,a.payload)},doUpdate200Response:function(a){e.handleAnswer(this.parent,a.payload)},doShutdownMessage:function(){e.clearCall(this.parent)},clearCall:function(){e.clearCall(this.parent)},rollbackUpdate:function(){e.rollbackUpdate(this.parent)},doStartCallError:function(){e.clearCall(this.parent)},doStartReliableProvRespWithSDP:function(a){var b=a.payload,c=this.parent;b.type="answer";var d=c.offerAnswerManager.getMasterState();if(d===i.OFFER_ANSWER_STATE.OFFER_SENT){var f=function(){c.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.ANSWER_GOT,b.sdp),c.lastServerCorrelationId=a.control.correlation_id,g.sendPrack(c),c.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.ACK_SENT)};h.setRemoteDescription(c,new RTCSessionDescription(b),f,e.srdError(c))}},doStartReliableProvRespWithoutSDP:function(a){var b=(a.payload,this.parent);b.lastServerCorrelationId=a.control.correlation_id,g.sendPrack(b)},doStart200RespInEarlyPhase:function(a){var c=this.parent;c.earlyMediaState=null,c.setCallState(i.CALLSTATE.RESPONDED,200,"got success response"),a.complete(b),c.setCallState(i.CALLSTATE.ESTABLISHED,null,"sent complete"),g.checkResumeState(c)},doUpdate200RespInEarlyPhase:function(a){var b=this.parent;e.handleAnswer(b,a.payload),b.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.ANSWER_GOT,a.payload.sdp),a.complete(b.session),b.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.ACK_SENT),g.checkResumeState(b)},sendOffer:function(){e.sendOfferImpl(this.parent)}},this._template.parent=this;var n={iceFailureHandler:new c(this),statsCollector:null};m.set(this,n)};return o.prototype={start:function(b,c){function d(a){f([a])}function f(b){try{j.callConfig.dataChannelConfig&&e.initDataTransfers(j),e.initOfferCtx(j,b,c)}catch(b){j.onCallError?h.invokeCallError(j,a.ERRORCODE.PEERCONNECTION_ERROR,b):l.error("Start exception: "+b)}}function g(a){l.error("Cannot get local stream... ",a),j.fireMediaStreamEvent(i.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null)}var j=this;if(j.callState.state!==i.CALLSTATE.NONE&&j.resumeState!==i.RESUME_STATE.reStartingCall)throw"The call has already been started";if(c&&(j.extHeaders=c),b&&(j.localMediaStreams=b),this.callStartOnIceResponse||0!==this.session.iceServerListFromServer.length){this.callStartOnIceResponse=!1,this.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.CALL_START);var k=j.callConfig.shouldSendAudio(),m=j.callConfig.shouldSendVideo();k||m?b&&b.length>0?f(b):e.initUserMedia(j,d,g):f(b)}else l("There are no TURN candidates available when starting call"),this.callStartOnIceResponse=!0,this.session.iceServerEnquirer.doIceEnquiry(function(){j.start(j.localMediaStreams,j.extHeaders)})},getDataTransfer:function(a){return this.dataTransfers.get(a)},getCaller:function(){return this.caller},getCallee:function(){return this.callee},getCallState:function(){return this.callState},getCallConfig:function(){return this.callConfig?new a.CallConfig(this.callConfig.audioConfig,this.callConfig.videoConfig,this.callConfig.dataChannelConfig):null},getPeerConnection:function(){return this.peerConnection},getIceConnectionState:function(){return this.peerConnection?""+this.peerConnection.iceConnectionState:"closed"},canUpdate:function(){return l.debug("canUpdate() - ICE connection state is: "+this.getIceConnectionState()+", call state is: "+this.callState.state),this.callState.state===i.CALLSTATE.ESTABLISHED||this.callState.state===i.CALLSTATE.UPDATE_FAILED||this.callState.state===i.CALLSTATE.UPDATED?"checking"===this.getIceConnectionState()?(l.debug("canUpdate() - Update denied, invalid ICE state: "+this.getIceConnectionState()),!1):(l.debug("canUpdate() - Update allowed"),!0):(l.debug("canUpdate() - Update denied, invalid call state: "+this.callState.state),!1)},toJSON:function(){var a={caller:this.caller,callee:this.callee,callConfig:this.callConfig,callState:this.callState,earlyMediaState:this.earlyMediaState,subSessionId:this.subSessionId,remoteMedias:this.remoteMedias,offerAnswerManager:this.offerAnswerManager,iceTimeout:this.iceTimeout,onDataTransfer:this.onDataTransfer,onCallError:this.onCallError,onUpdate:this.onUpdate,onCallStateChange:this.onCallStateChange,onMediaStreamEvent:this.onMediaStreamEvent,streamId:this.streamId,streamType:this.streamType};return a},setCallState:function(a,c,d){var e=this.callState;if(!e.isFinalState()){try{if(null!=this.conversation&&a===i.CALLSTATE.ESTABLISHED){var f=m.get(this).statsCollector;null==f&&(f=m.get(this).statsCollector=new b(this),f.start())}else if(null!=this.conversation&&(a===i.CALLSTATE.ENDED||a===i.CALLSTATE.FAILED||a===i.CALLSTATE.ERROR)){var f=m.get(this).statsCollector;if(null!=f&&f.stop(),l.debug("verbose logging is enabled? "+this.session.enableVerbose),this.session.enableVerbose){var h=this.generateAuditData(),k=new j.Message;k.control.type=i.TYPE.MESSAGE,k.control.package_type=i.PACKAGE.REGISTER,k.control.subsession_id=this.session.connectSubSessionId,k.control.session_id=this.session.sessionId,k.control.ack_sequence=this.session.lastInboundSeq,k.header.initiator=this.session.userName,k.header.action=i.ACTION.AUDIT,k.header.module="WEB",k.header.conversation_key=this.conversation.conversationKey,k.header.access_token=this.session.iceServerAccessToken,k.payload={audit_data:h},this.session.sendMessage(k)}}}catch(a){l.warn("Error happens when doing peer connection stats collector start/stop: "+a)}g.setCallState(this,a,c,d)}},fireMediaStreamEvent:function(a,b){"use strict";if(this.onMediaStreamEvent)try{if(this.lastServerExtHeader){var c=this.lastServerExtHeader;this.onMediaStreamEvent(a,b,c),delete this.lastServerExtHeader}else this.onMediaStreamEvent(a,b)}catch(a){l.warn("The callback function 'Call.onMediaStreamEvent()' exception:"+a)}},mute:function(a){return null===this.peerConnection?(l.error("Cannot get the audio track. failed to mute audio!"),!1):(this.peerConnection.getLocalStreams().map(function(b){b.getAudioTracks().map(function(b){b.enabled=!a})}),!0)},isMuted:function(){return null===this.peerConnection?(l.debug("Cannot get the audio track, assuming not muted"),!1):this.peerConnection.getLocalStreams().some(function(a){return a.getAudioTracks().some(function(a){return a.enabled===!1})})},getRemoteStreams:function(){return h.getRemoteStreams(this.peerConnection)},decline:function(a,b){"use strict";try{null==a&&(a=i.ERRORCODE.DECLINED),this.callState.state===i.CALLSTATE.UPDATING?(l.debug("Update declined"),this.callConfig=this.lastCallConfig,this.setCallState(i.CALLSTATE.UPDATE_FAILED,a,"Decline")):(l.debug("Call declined"),h.clearPeerConnection(this),this.peerConnection=null,this.session.removeSubSession(this.subSessionId),this.setCallState(i.CALLSTATE.FAILED,a,"Decline")),g.sendReject(this,a,null,b),l.info("decline call.")}catch(a){l.error("answer error: "+a)}},accept:function(b,c,d){"use strict";function f(a){j([a])}function g(a){l.error("Cannot get local stream... ",a),k.fireMediaStreamEvent(i.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),k.decline()}function j(b){try{e.initAnswerCtx(k,b,d)}catch(b){k.onCallError&&h.invokeCallError(k,a.ERRORCODE.PEERCONNECTION_ERROR,b),l.error("Got exception when accept the call: "+b)}}var k=this;b||(b=this.callConfig);try{this.setCallState(i.CALLSTATE.STARTED,null,"receive call");var m=e.isValidAnswerCallConfig(this.callConfig,b);if(!m)throw{name:"InvalidCallConfig",message:"The parameter 'callConfig' is invalid."};if(this.callState.state===i.CALLSTATE.UPDATING&&null!=this.peerConnection)e.onUpdateCall(this,b,c,d);else{b&&(this.callConfig=b);var n=b.shouldSendAudio(),o=b.shouldSendVideo();n||o?c?j(c):e.initUserMedia(k,f,g):j()}l.debug("accept call")}catch(a){throw l.error("answer error: "+a),a}},end:function(a){this.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.CALL_END);var b=g.createMessage(this),c="cancelled";b.header.action=i.ACTION.SHUTDOWN,b.addExtHeaders(a),this.callState.state===i.CALLSTATE.NONE||this.callState.isFinalState()||(this.callState.hasEstablished()?(b.control.correlation_id=this.session.genNewCorrelationId(),c="shutdown"):(b.control.correlation_id=this.startReqCorrId,c="cancelled"),this.session.sendMessage(b)),e.clearCall(this),this.setCallState(i.CALLSTATE.ENDED,"",c)},update:function(a,b,c){this.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.CALL_UPDATE),this.setCallState(i.CALLSTATE.UPDATING,"","update"),e.updateCall(this,a,b,c)},resume:function(a,b){l.info("Begin to resume call");var c=this,d=c.temporarySavedStreams;if(c.resumeSuccessCallback=a,c.resumeFailureCallback=b,c.session.clientIpNotChangedAfterReconnect)return c.session.clientIpNotChangedAfterReconnect=!1,l.debug("Client network was not changed, no further action needed."),void(c.resumeSuccessCallback&&c.resumeSuccessCallback());c.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.NETWORK_SWITCHED);var e=c.offerAnswerManager.getMasterState(),f=c.offerAnswerManager.getSlaveState(),g=i.OFFER_ANSWER_STATE;switch(l.debug("The m/s offer-answer states are: "+e+"/"+f),e){case g.INITIAL:switch(f){case g.OFFER_REJECT:case g.INITIAL:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.ANSWER_SENT:c.resumeState=i.RESUME_STATE.reStartingCall,c.start(d);break;case g.ACK_GOT:c.resumeState=i.RESUME_STATE.reStartingCall,c.start(d)}break;case g.OFFER_SENT:switch(f){case g.OFFER_REJECT:case g.INITIAL:case g.OFFER_GOT:case g.ACK_GOT:c.resumeState=i.RESUME_STATE.waittingFinalResp,c.resumeSuccessCallback&&c.resumeSuccessCallback()}break;case g.ANSWER_GOT:switch(f){case g.OFFER_REJECT:case g.INITIAL:case g.OFFER_GOT:case g.GLARE:case g.ACK_GOT:case g.ANSWER_SENT:c.resumeState=i.RESUME_STATE.reStartingCall,c.start(d)}break;case g.ACK_SENT:switch(f){case g.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.ANSWER_SENT:c.resumeState=i.RESUME_STATE.reStartingCall,c.start(d);break;case g.INITIAL:case g.OFFER_REJECT:case g.ACK_GOT:c.resumeState=i.RESUME_STATE.reStartingCall,c.start(d)}break;case g.OFFER_REJECTED:switch(f){case g.OFFER_REJECT:case g.INITIAL:case g.ACK_GOT:c.resumeState=i.RESUME_STATE.reStartingCall,c.start(d);break;case g.OFFER_GOT:c.resumeSuccessCallback&&c.resumeSuccessCallback();break;case g.ANSWER_SENT:c.resumeState=i.RESUME_STATE.reStartingCall,c.start(d)}}},onMessage:function(a){var b=this,c=[];if(this.session.iceServerListFromServer&&(c=this.session.iceServerListFromServer),l.debug("iceServers="+JSON.stringify(c,null,2)),this.callStartOnIceResponse||0!==c.length)if(a.isEnquiry()){if(!this.capabilityExchange){var d="No CapabilityExchange registered with this call";throw l.error(d),d}this.capabilityExchange.onMessage(a)}else a.isRequest()?f.doRequest(this,a):a.isResponse()?f.doResponse(this,a):a.isMessage()?f.doMessage(this,a):a.isError()?f.doError(this,a):g.doUnexpectedMsg(this,a);else l.info("There are no TURN candidates available on receiving start"),this.callStartOnIceResponse=!0,this.session.iceServerEnquirer.doIceEnquiry(function(){b.onMessage(a)})},collectClientLog:function(a,b){var c=new Date,d=("0"+(c.getMonth()+1)).slice(-2)+"/"+("0"+c.getDate()).slice(-2)+"/"+c.getFullYear()+" "+("0"+c.getHours()).slice(-2)+":"+("0"+c.getMinutes()).slice(-2)+":"+("0"+c.getSeconds()).slice(-2)+"."+("00"+c.getMilliseconds()).slice(-3);b="["+d+"]"+b,"error"===a?this.errorLog.push(b):"event"===a&&this.eventLog.push(b)},generateAuditData:function(){var a={};a.stream_id=this.avStream.getId();var b=m.get(this).statsCollector,c=null==b?{}:b.getReports();a.data={};for(var e in c)a.data[e]=c[e];a.data.timeToNewPeerConnection=this.timeRecording.timeToNewPeerConnection.end-this.timeRecording.timeToNewPeerConnection.start,a.data.timeToGetUserMedia=this.timeRecording.timeToGetUserMedia.end-this.timeRecording.timeToGetUserMedia.start,a.data.timeToSetupSignalingChannel=this.session.timeToInitWebSocket,void 0!==this.timeRecording.timeToMakeCall.end&&void 0!==this.timeRecording.timeToMakeCall.start&&(a.data.timeToMakeCall=this.timeRecording.timeToMakeCall.end-this.timeRecording.timeToMakeCall.start),a.data.timeToGetIceCandidates=this.timeRecording.timeToGetIceCandidates.end-this.timeRecording.timeToGetIceCandidates.start,a.data.timeToGetIceConnection=this.timeRecording.timeToGetIceConnection.end-this.timeRecording.timeToGetIceCandidates.start;var f=this.timeRecording.timeToGetRemoteMedia.end-this.timeRecording.timeToGetIceCandidates.start;f>=0&&(a.data.timeToGetRemoteMedia=f),a.data.errorLog=this.errorLog,
a.data.eventLog=this.eventLog,a.data.userId=this.session.userName,a.data.userIp=this.userIp,a.data.sessionId=this.session.sessionId,a.data.sessionType=this.sessionType,a.data.protocol=this.protocol,a.data.url=this.url;var g={};d.browser.isFirefox?g.clientType="firefox":d.browser.isChrome?g.clientType="chrome":d.browser.isEdge?g.clientType="edge":d.browser.isIE?g.clientType="ie":d.browser.isSafari&&(g.clientType="safari"),g.version=d.browser.version,a.data.deviceInformation=g,a.data.participants=this.conversation.__participantsHistory;var h={};return h["conversation-id"]=this.conversation.getLocalId(),h.streams=[],h.streams.push(a),h}},e.sendOffer=function(a,b){a.offerAnswerManager.canSendOffer()?a.peerConnection&&a.peerConnection.localDescription&&a.peerConnection.localDescription.sdp&&e.sendOfferImpl(a,b):l.debug("Cannot send offer")},e.sendOfferImpl=function(a,b){if(a.callState.state===i.CALLSTATE.ENDED||a.callState.state===i.CALLSTATE.FAILED)l.warn("Call has ended while sending offer, clear the call."),e.clearCall(a);else{var c,d=g.createRequest(a),f=a.session.genNewCorrelationId();if(!a.peerConnection)return void l.warn("The peerConnection of the call is null");c=a.peerConnection.localDescription.sdp,d.header.action=i.ACTION.START,d.control.correlation_id=f,d.payload={sdp:c},b?d.addExtHeaders(b):a.extHeaders&&(d.addExtHeaders(a.extHeaders),a.extHeaders=null);var h=!1;a.authInfo&&(d.header.authorization=a.authInfo,h=!0,a.authInfo=null);try{a.session.sendMessage(d),a.startReqCorrId=d.control.correlation_id,a.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.OFFER_SENT,c),a.callState.state===i.CALLSTATE.NONE&&a.setCallState(i.CALLSTATE.STARTED,null,"start call")}catch(a){}}},e.sendAnswer=function(a,b){if(a.callState.state===i.CALLSTATE.ENDED||a.callState.state===i.CALLSTATE.FAILED)l.warn("Call has ended while sending answer, clear the call."),e.clearCall(a);else if(a&&a.peerConnection&&a.peerConnection.localDescription&&a.peerConnection.localDescription.sdp){var c=g.createResponse(a),d=a.peerConnection.localDescription.sdp,f=a.lastServerCorrelationId;c.control.message_state=i.MESSAGESTATE.FINAL,c.header.action=i.ACTION.START,c.control.correlation_id=f,b&&c.addExtHeaders(b),c.payload={sdp:d},a.session.sendMessage(c),l.debug("Answer is sent...\r\n"+d),a.setCallState(i.CALLSTATE.RESPONDED,200,"sent success response"),a.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.ANSWER_SENT,d)}},e.sendAnswerInComplete=function(a,b){var c=a.peerConnection.localDescription.sdp,d=g.createMessage(a);d.header.action=i.ACTION.COMPLETE,d.control.correlation_id=a.startReqCorrId,d.payload={sdp:c},b&&d.addExtHeaders(b),a.session.sendMessage(d),a.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.ACK_SENT,c),a.setCallState(i.CALLSTATE.ESTABLISHED,null,"sent complete")},e.initOfferCtx=function(b,c,d){"use strict";var f=b.peerConnection,g=function(){e.sendOffer(b,d),b.timeRecording.timeToMakeCall.end=(new Date).getTime()};null==b.peerConnection&&(h.createPeerConnection(b,c),f=b.peerConnection),b.callConfig.dataChannelConfig&&e.initDataChannel(b);var j=function(c){l.error("Offer error:"+c),h.invokeCallError(b,a.ERRORCODE.GENERATE_SDP_ERROR,c)},k=function(a){var c=h.changeSdpByCallConfig(a.sdp,b),d=function(){e.bindIceHandler(b,g,!0)};h.setLocalDescription(b,new RTCSessionDescription({type:"offer",sdp:c}),d)},m={offerToReceiveAudio:b.callConfig.shouldReceiveAudio()?1:0,offerToReceiveVideo:b.callConfig.shouldReceiveVideo()?1:0};l.debug("createOffer with media constraints: "+JSON.stringify(m,null,2)),b.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.PEER_CONNECTION_CREATE_OFFER+":"+JSON.stringify(m,null,2)),b.timeRecording.timeToMakeCall.start=(new Date).getTime(),f.createOffer(k,j,m),b.peerConnection=f},e.initAnswerCtx=function(b,c,d){"use strict";var f=b.peerConnection;null==b.peerConnection&&(h.createPeerConnection(b,c),f=b.peerConnection),b.callConfig.dataChannelConfig&&e.initReceivedDataChannel(b);var g=function(){var c=function(){e.sendAnswer(b,d)},g=function(d){var f=h.changeSdpByCallConfig(d.sdp,b),g=function(){e.bindIceHandler(b,c,!1)},i=function(c){l.warn("Set localDescription failed!"),h.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)};h.setLocalDescription(b,new RTCSessionDescription({type:"answer",sdp:f}),g,i)},j=function(c){l.error("Answer error:"+c),h.invokeCallError(b,a.ERRORCODE.GENERATE_SDP_ERROR,c)};b.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.PEER_CONNECTION_CREATE_ANSWER),f.createAnswer(g,j)},j=b.newRemoteSDP;j.type="offer";var k=new RTCSessionDescription(j);h.setRemoteDescription(b,k,g,e.srdError(b))},e.clearCall=function(a){"use strict";a&&e.clearDataTransfers(a.dataTransfers);try{h.clearPeerConnection(a),a.peerConnection=null}catch(a){l.error("clear call error: "+a)}var b=a.localMediaStreams;if(b)for(var c=0;c<b.length;c++){var d=b[c];l.debug("Media stream "+c+": used by "+d.peerConnectionNum+" peer connections."),d&&(null==d.peerConnectionNum||d.peerConnectionNum<=0)&&(l.debug("Stop this media stream: [video tracks: "+d.getVideoTracks().length+", audio tracks: "+d.getAudioTracks().length+"]"),d.getAudioTracks().forEach(function(a){a.enabled=!1,a.stop()}),d.getVideoTracks().forEach(function(a){a.enabled=!1,a.stop()}))}a.conversation||a.session.removeSubSession(a.subSessionId)},e.clearDataTransfers=function(a){"use strict";if(a&&0!==a.size())for(var b=a.values(),c=null,d=0;d<b.length;d++)c=b[d],c.clear()},e.rollbackUpdate=function(a){"use strict";if(a&&a.peerConnection){var b=a.peerConnection.remoteDescription;b&&(b.type="answer",h.setRemoteDescription(a,b)),a.lastCallConfig&&(a.callConfig=a.lastCallConfig)}},e.updateCall=function(a,b,c,d){a.lastCallConfig=a.callConfig,a.callConfig=b;var f=function(b,c,d){l.debug("createOffer with media constraints: "+JSON.stringify(d,null,2)),a.peerConnection.createOffer(b,c,d)},g=function(){var b=function(){e.sendOffer(a,d)};e.bindIceHandler(a,b,!0)},h=function(){};e.doUpdate(a,b,c,f,h,g,!0)},e.closePcForUpdate=function(a,b){for(var c=h.getLocalStreams(a),d=0;d<c.length;d++){var e=c[d];e.peerConnectionNum&&e.peerConnectionNum--}"closed"!==a.signalingState&&a.close()},e.handleMediaStreamForUpdate=function(a,b,c,d){var e=!1,f=!1,g=(a.peerConnection,a.localMediaStreams),i=!1,j=function(b,c,d){for(var e=!1,f=0;f<b.length;f++){l.debug("round the loop: "+f+" s is "+g);var g=b[f];if(g){var i=g.getAudioTracks(),j=g.getVideoTracks(),k=i&&i.length>0;l.debug("hasAudio: "+k);var m=j&&j.length>0;l.debug("hasVideo: "+m),l.debug("handleMediaStreamForUpdate: needAudio="+c+", hasAudio="+k+", needVideo="+d+", hasVideo="+m),c===k&&d===m&&(h.addLocalStream(a,g),e=!0)}}return e};return b&&(i=j(b,c,d)),!i&&g&&(i=j(g,c,d)),c&&!d?e=!i:!c&&d?f=!i:c&&d&&(i||(e=f=!0,b&&(e=!j(b,!0,!1),f=!j(b,!1,!0)),(e||f)&&g&&(e&&(e=!j(g,!0,!1)),f&&(f=!j(g,!1,!0))))),l.debug("handleMediaStreamForUpdate: needNewAudioStream="+e+", needNewVideoStream="+f),{needNewAudioStream:e,needNewVideoStream:f}},e.initUserMedia=function(b,c,d,e){"use strict";var f=function(a){if(b.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.GET_USER_MEDIA),b.timeRecording.timeToGetUserMedia.end=(new Date).getTime(),b.callState){var d=b.callState.state;if(d===i.CALLSTATE.END||d===i.CALLSTATE.FAILED)return void l.debug("Got media stream, but the call state is failed or end. So do nothing then.")}c(a)},g=function(c){if(l.error("Failed to get access to local media. Error name was "+c.name),b.collectClientLog(i.LOGTYPE.ERROR_LOG,i.ERRORLOG.GET_USER_MEDIA_ERROR+":"+c.name+(""===c.message?"":":"+c.message)),b.callState){var e=b.callState.state;if(e===i.CALLSTATE.END||e===i.CALLSTATE.FAILED)return void l.debug("Failed to get access to local media, but the call state is failed or end. So do nothing then.")}h.invokeCallError(b,a.ERRORCODE.GET_USER_MEDIA_ERROR,c.name+": "+c.message),d&&d(c)};e||(e={audio:b.callConfig.shouldSendAudio(),video:b.callConfig.shouldSendVideo()}),l.debug("getUserMedia with media options: "+JSON.stringify(e,null,2));try{var j={};j.start=(new Date).getTime(),b.timeRecording.timeToGetUserMedia=j,navigator.getUserMedia(e,f,g)}catch(a){throw l.error("The callConfig is invalid, cause initialize user media exception:"+a),a}},e.handleUpdateCallRequest=function(a,b){"use strict";var c=a.offerAnswerManager.getLatestActiveRemoteSdp();l.debug("The latest active remote SDP is: "+c),l.debug("The latest active remote medias is: "+a.remoteMedias);var d=h.isMediaChanged(a.newRemoteMedias,a.remoteMedias);d?(a.setCallState(i.CALLSTATE.UPDATING,null,"onUpdate"),a.onUpdate?a.onUpdate(a.callConfig,b):l.warn("No callback for update call request")):null==a.peerConnection||null==a.peerConnection.localDescription?(l.info("Client is not ready. Reject incoming call."),g.sendReject(a)):(h.createNewPeerConnection(a),a.offerAnswerManager.reset(),a.offerAnswerManager.updateState(i.OFFER_ANSWER_STATE.OFFER_GOT,a.newRemoteSDP.sdp),e.initAnswerCtx(a))},e.handleAnswer=function(a,b){"use strict";if(b.type="answer",a.peerConnection&&b.sdp){var c=function(){a&&a.peerConnection&&a.peerConnection.remoteDescription};h.setRemoteDescription(a,new RTCSessionDescription(b),c)}},e.onUpdateCall=function(a,b,c,d){var f=function(){a.decline()},g=function(b,c,d){var f=new RTCSessionDescription({type:"offer",sdp:a.newRemoteSDP.sdp}),g=function(){l.debug("[UPDATE] offer is set as remote description...\r\n"+a.newRemoteSDP.sdp);var d=function(b){c(b),a.decline()};a.peerConnection.createAnswer(b,d)};h.setRemoteDescription(a,f,g,e.srdError(a))},i=function(){var b=function(){e.sendAnswer(a,d)};e.bindIceHandler(a,b,!1)};e.doUpdate(a,b,c,g,f,i,!1)},e.doUpdate=function(b,c,d,f,g,j,k){"use strict";var m=c,n=!1,o=!1,p=!1,q=!1,r=b.peerConnection;e.rollbackUpdate=function(a){var b=a.peerConnection;a.peerConnection=r,e.closePcForUpdate(b,a),a.lastCallConfig&&(a.callConfig=a.lastCallConfig)};var s=b.temporarySavedStreams;b.temporarySavedStreams=[],h.createPeerConnection(b),b.callConfig.dataChannelConfig&&(k?(e.initDataTransfers(b),e.initDataChannel(b)):e.initReceivedDataChannel(b)),b.temporarySavedStreams=s,m.audioConfig!==i.MEDIADIRECTION.NONE&&(n=!0),m.videoConfig!==i.MEDIADIRECTION.NONE&&(o=!0),m.audioConfig!==i.MEDIADIRECTION.RECVONLY&&m.audioConfig!==i.MEDIADIRECTION.SENDRECV||(p=!0),m.videoConfig!==i.MEDIADIRECTION.RECVONLY&&m.videoConfig!==i.MEDIADIRECTION.SENDRECV||(q=!0),l.debug("doUpdate: needAudioStream="+n+", needVideoStream="+o),l.debug("doUpdate: receiveAudio="+p+", receiveVideo="+q);var t=b.peerConnection,u=t.signalingHandlerForUpdate;t.signalingHandlerForUpdate=function(a){l.debug("signalingState : ",t.signalingState),"stable"===t.signalingState&&(e.closePcForUpdate(r,b),l.debug("Upgrade: the old peer connection is closed.",r),t.signalingHandlerForUpdate=u)};var v=e.handleMediaStreamForUpdate(b,d,n,o),w=function(){if(!b.peerConnection)throw l.error("Peer connection of the call is null."),{name:"Error",message:"Peer connection of the call is null."};var c={OfferToReceiveAudio:p?1:0,OfferToReceiveVideo:q?1:0},d=function(a){b.callConfig=m;var c=h.changeSdpByCallConfig(a.sdp,b);a=new RTCSessionDescription({type:a.type,sdp:c}),l.debug("Updating call: "+a.type+" created... "+a.sdp),h.setLocalDescription(b,a,j)},g=function(c){l.error("Browser failed to create sdp! The error is: ",c),b.collectClientLog(i.LOGTYPE.ERROR_LOG,i.ERRORLOG.GENERATE_SDP_ERROR),b.setCallState(i.CALLSTATE.UPDATE_FAILED,a.ERRORCODE.PEERCONNECTION_ERROR,c),h.invokeCallError(b,a.ERRORCODE.GENERATE_SDP_ERROR,c),e.rollbackUpdate(b)};f(d,g,c)},x=function(c){var d=a.getLogLevel();d===i.LOGLEVEL.DEBUG?l.debug("[UPDATE] got local stream..."+c):d<=i.LOGLEVEL.INFO&&l.info("[UPDATE] got local stream..."),h.addLocalStream(b,c),w()},y=function(a){l.error("[Update] Cannot get local stream... ",a),b.fireMediaStreamEvent(i.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),g&&g(),e.rollbackUpdate(b)};if(v.needNewAudioStream||v.needNewVideoStream){var z={audio:v.needNewAudioStream,video:v.needNewVideoStream};e.initUserMedia(b,x,y,z)}else w()},e.initDataTransfers=function(a){var b,c=a.callConfig.dataChannelConfig,d=c.length;if(0!==d)for(b=0;b<d;b++){var e=c[b],f=a.dataTransfers.get(e.label);f||(f=new k,a.dataTransfers.put(e.label,f));try{a.onDataTransfer?a.onDataTransfer(f):l.warn("The onDataTransfer() callback function is not set when starting.")}catch(a){l.warn("The callback function 'Call.onDataTransfer()' encountered an exception: "+a)}}},e.initDataChannel=function(a){var b,c=a.peerConnection,d=a.callConfig.dataChannelConfig,e=d.length;if(0!==e)for(b=0;b<e;b++){var f=d[b],g=JSON.parse(JSON.stringify(f));delete g.label;for(var h in g)g.hasOwnProperty(h)&&g[h]===-1&&delete g[h];var j=c.createDataChannel(f.label,g),k=a.dataTransfers.get(f.label);k.initDataChannel(j,a.callState.state==i.CALLSTATE.UPDATING)}l.debug("DataChannel is initiated")},e.initReceivedDataChannel=function(a){a.peerConnection.ondatachannel=function(b){l.debug("Data channel is received"),a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_DATA_CHANNEL+":"+b.channel.label);for(var c=b.channel.label,d=!1,e=0;e<a.callConfig.dataChannelConfig.length;e++)c===a.callConfig.dataChannelConfig[e]&&(d=!0);d||a.callConfig.dataChannelConfig.push({label:c,ordered:b.channel.ordered,maxPacketLifeTime:b.channel.maxPacketLifeTime,maxRetransmits:b.channel.maxRetransmits,protocol:b.channel.protocol,negotiated:b.channel.negotiated,id:b.channel.id});var f=a.getDataTransfer(c);f?l.debug("Data channel is updating."):(f=new k,l.debug("The dataTransfer object with label "+c+" is created"),a.dataTransfers.put(c,f));var g=b.channel;f.initDataChannel(g,!1);try{a.onDataTransfer?a.onDataTransfer(f):l.warn("The onDataTransfer() callback function is not set.")}catch(a){l.warn("The callback function 'Call.onDataTransfer()' exception: "+a)}a.session.saveToStorage()}},e.bindIceHandler=function(a,b,c){function d(){t.onicecandidate=k}function e(){a.peerConnection.onicecandidate=f,b()}function f(b){a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(b.candidate));var c=b.candidate;c?(l.debug("handleNewIceCandidate: candidate- "+JSON.stringify(c)),q(c)):(a.timeRecording.timeToGetIceCandidates.end=(new Date).getTime(),l.debug("handleNewIceCandidate: got 'end of candidates' event."),r())}function k(c){a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(c.candidate));var d=c.candidate;l.debug("ICE gathering state: "+t.iceGatheringState),d?l.debug("handleEndOfCandidate: candidate- "+JSON.stringify(d)):(a.timeRecording.timeToGetIceCandidates.end=(new Date).getTime(),l.debug("handleEndOfCandidate: got 'end of candidates' event."),b(),t&&(t.onicecandidate=p))}function n(b){l.debug("ICE connection state: "+b.target.iceConnectionState),a.onIceConnectionStateChange&&a.onIceConnectionStateChange(b.target.iceConnectionState)}function o(a){l.debug("ICE gathering state: "+a.target.iceGatheringState)}function p(b){a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(b.candidate));var c=b.candidate;c?l.debug("logIceCandidates : candidate- "+JSON.stringify(b.candidate)):l.debug("logIceCandidates : end of candidates.")}function q(b){function c(){var a=f.get(d);a?a.push(e):(a=[],a.push(e),f.put(d,a))}var d,e,f=a.offerAnswerManager.trickledCandidatesMap;if(b.sdpMid)d="a=mid:"+b.sdpMid+"\r\n";else{if(null==b.sdpMLineIndex)return void l.warn("ICE Candidate is invalid, ignore it!");var i=a.offerAnswerManager.getLatestActiveLocalSdp();if(i){var j=h.getMediaFromSDP(i);if(j.length>0){var k=j[b.sdpMLineIndex];d=k.mid+"\r\n"}}}b.candidate&&(e=b.candidate),c(),a.offerAnswerManager.canSendOffer()&&g.sendTrickledCandidates(a)}function r(){for(var b=a.offerAnswerManager.trickledCandidatesMap,c=b.keys();c.length>0;){var d=c.shift(),e=b.get(d);e.push("end-of-candidates")}a.offerAnswerManager.canSendOffer()&&g.sendTrickledCandidates(a)}function s(a){return a.search("a=ice-options:.*trickle")>-1?(l.debug("SDP supports trickle ICE"),!0):(l.debug("SDP does NOT support trickle ICE"),!1)}var t=(a.offerAnswerManager,a.peerConnection);if(!t)throw{name:"IllegalStateError",message:"There is no peerConnection in the call, cannot bind."};switch(l.debug("Bind ICE handler with trickle ICE mode: "+a.pkgInstance.trickleIceMode),a.pkgInstance.trickleIceMode){case"off":d();break;case"half":c?d():s(a.newRemoteSDP.sdp)?e():d();break;case"full":c||s(a.newRemoteSDP.sdp)?e():d();break;default:d()}t.oniceconnectionstatechange=function(b){if(a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_ICE_CONNECTION_STATE_CHANGE+":"+b.target.iceConnectionState),"failed"===b.target.iceConnectionState){a.collectClientLog(i.LOGTYPE.ERROR_LOG,i.ERRORLOG.ICE_CONNECTION_ERROR+": To "+a.callee);var c=a.onCallError;if(c){var d=new j.ErrorInfo(i.ERRORCODE.ICE_CONNECTION_ERROR,"ICE connection state gets failed");c(d)}}else"new"===b.target.iceConnectionState||"checking"===b.target.iceConnectionState||("connected"===b.target.iceConnectionState?a.timeRecording.timeToGetIceConnection.end=(new Date).getTime():"completed"===b.target.iceConnectionState);n(b),a.getCallState().isFinalState()||m.get(a).iceFailureHandler.updateIceConnectionState(b)},t.onsignalingstatechange=function(b){var c=t.signalingHandlerForUpdate;"function"==typeof c&&c(b),a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_SIGNALING_STATE_CHANGE+":"+b.target.signalingState)},t.onnegotiationneeded=function(b){a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_NEGOTIATION_NEEDED+":"+b.target.signalingState)},t.onicegatheringstatechange=function(b){a.collectClientLog(i.LOGTYPE.EVENT_LOG,i.EVENTLOG.ON_ICE_GATHERING_STATE_CHANGE+":"+b.target.iceGatheringState),o(b)}},e.isValidAnswerCallConfig=function(a,b){var c={sendrecv:6,sendonly:4,recvonly:2,inactive:1,none:1},d=b.audioConfig,e=b.videoConfig,f=a.audioConfig,g=a.videoConfig,h=!1,j=!1;return l.debug("Old audio = "+f+", video = "+g),l.debug("New audio = "+d+", video = "+e),l.debug("Audio direction values: newAudio="+c[d]+", oldAudio="+c[f]+", newAudio <= oldAudio: "+(c[d]<=c[f])),l.debug("Video direction values: newVideo="+c[e]+", oldVideo="+c[g]+", newVideo <= oldVideo: "+(c[e]<=c[g])),f===i.MEDIADIRECTION.SENDONLY||f===i.MEDIADIRECTION.RECVONLY||f===i.MEDIADIRECTION.NONE?f!==d&&d!==i.MEDIADIRECTION.NONE||(h=!0):c[d]<=c[f]&&(h=!0),g===i.MEDIADIRECTION.SENDONLY||g===i.MEDIADIRECTION.RECVONLY||g===i.MEDIADIRECTION.NONE?g!==e&&e!==i.MEDIADIRECTION.NONE||(j=!0):c[e]<=c[g]&&(j=!0),l.debug("isValidAudio="+h+", isValidVideo="+j),!0},e.srdError=function(b){return function(c){l.warn("Error when set remote description: "+c),b.collectClientLog(i.LOGTYPE.ERROR_LOG,i.ERRORLOG.SET_REMOTE_SDP_ERROR+":"+c),h.invokeCallError(b,a.ERRORCODE.PEERCONNECTION_ERROR,c)}},d.CallPackageHelper=e,a.Call=o,a.CallPackage=n,console.log("wsc-call initialized."),a}(cloud||{}),cloud=function(a){"use strict";var b=a._private=a._private||{},c=b.CallPackageHelper,d=b.wscConst,e=b.wscUtils,f=b.rtcHelper,g=a.getLogger(),h={};a.timeoutIfEocNotHappen=1e3;var i=function(b,c,d,e){g.debug("Creating connection for user: '"+b+"' with uri: "+c),this.localParticipantUri=b,this.webSocketUri=c,this.onConnectionSuccess=d,this.onConnectionError=e,this.connectionId=null,this.refresh=!1,this.extHeaders=null,this.extPayloads=null,this.stateInfo=null,this.withConnectionId=function(a){return this.connectionId=a,this.refresh=!!a,this},this.withEarlyCallbacks=function(a,b){return this.onConnectionStateChange=a,this.onAuthRefresh=b,this},this.withExtHeaders=function(a){return this.extHeaders=a,this},this.withExtPayloads=function(a){return this.extPayloads=a,this},this.withStateInfo=function(a){return this.stateInfo=a,this},this.start=function(){return g.debug("Starting connection to URI = "+this.webSocketUri+", ID = "+this.connectionId),this.connectionId&&null===sessionStorage.getItem(this.connectionId)&&(g.info("Warning: No stored session found for id: "+this.connectionId),this.connectionId=null,this.refresh=!1),this.session=new a.Session(this.localParticipantUri,this.webSocketUri,this.onConnectionSuccess,this.onConnectionError,this.connectionId,this.extHeaders,this.extPayloads,this.stateInfo),g.debug("Session created with id: "+this.session.sessionId),this.session.onSessionStateChange=this.onConnectionStateChange,this.package=new a.ConversationPackage(this.session,null),this.authHandler=new a.AuthHandler(this.session),this.authHandler.refresh=this.onAuthRefresh,this}};i.prototype={getLocalParticipantUri:function(){return this.session.userName},getConnectionId:function(){return this.session.sessionId},close:function(){this.session.close()},setTrickleIceMode:function(a){this.package.setTrickleIceMode(a)},setIPv6:function(a){this.package.setIPv6(a)},setShortCircuit:function(a){this.package.setShortCircuit(a)},setDSCP:function(a){this.package.setDSCP(a)},setVideoSendBitrate:function(a){this.package.setVideoSendBitrate(a)},setVideoRecvBitrate:function(a){this.package.setVideoRecvBitrate(a)},setRemoveVideoFec:function(a){this.package.setRemoveVideoFec(a)},setIntervals:function(a,b,c,d){this.session.setBusyPingInterval(a),this.session.setIdlePingInterval(b),this.session.setReconnectInterval(c),this.session.retryCount=d},isRefresh:function(){return this.refresh},initCallbacks:function(a,b,c){this.package.initCallbacks(a,b),c&&(this.onConnectionStateChange=c,this.session.onSessionStateChange=this.onConnectionStateChange)},makeConversation:function(){return this.package.createConversation(null,null,null,null)},getConversations:function(){return this.package.getConversations()},hibernate:function(a,b,c){this.session.hibernate(a,b,c)},getNetworkStatus:function(a,b){this.session.getNetworkStatus(a,b)}};var j=function(a,b){if(!a){var c="The parameter 'session' cannot be null!";throw g.error(c),c}b?this.packageType=b:this.packageType=d.PACKAGE.CONVERSATION,a.registerPackage(this),this.session=a,this.trickleIceMode="off",this.ipv6=!1,this.dscp=!1,this.videoSendBitrate=!1,this.videoRecvBitrate=!1,this.removeVideoFec=!1,this.shortCircuitMode=!1,this.onIncoming=null,this.onResurrect=null,this.getConversations=function(){var a=[],b=this.session.getSubSessionsByPackageType(this.packageType),c=null;if(b){c=b.values();for(var d=0;d<c.length;d++)a[d]=c[d]}return a},this.encodeConversationTopic=function(a){return a?(a=a.replace(/[\W]+/g,"_"),a.indexOf("@")<0&&(a+="@conversation.topic"),a):null}};j.prototype={initCallbacks:function(a,b){this.onIncoming=a,this.onResurrect=b},createConversation:function(a,b,c,d){c||(c="video");var e=this.prepareConversation(a,this.encodeConversationTopic(b),this.session,this.session.userName,c),f=e.localAddParticipant(this.session.userName);return d&&f.localAddStreamInfo(null,null,d,null),e.subSessionId=this.session.generateSubSessionId(),this.putConversation(e.subSessionId,e),a&&(g.debug("Conversation Key provided ("+a+") - joining existing conversation"),e.joiningConversation=!0),this.shortCircuitMode&&(g.debug("Enabling short-circuit communication in conversation"),e.withShortCircuit()),e},clear:function(){var a,b=this.session.getSubSessionsByPackageType(this.packageType).values();for(a=0;a<b.length;a++){for(var d=b[a],e=d.streams.values(),f=0;f<e.length;f++)c.clearCall(e[f].call);d=null}},remove:function(a){var b=this,c=a.subSessionId;a.removed||(a.removed=!0,setTimeout(function(){g.debug("Removing conversation: "+c),b.session.removeSubSession(c)},1e3))},onMessage:function(a){var b=this.session,c=a.control.subsession_id,e=a.header.stream_id,h=a.header.stream_type,i=this.session.getSubSession(c);if(a.isRequest()&&"start"===a.header.action){var j=a.payload.sdp,k=f.getCallConfigFromRemoteSDP(j,!1);if(null===i){var l="video";k&&(l=k.getChannelType()),i=this.prepareConversation(a.header.conversation_key,a.header.conversation_topic,b,a.header.initiator,l),i.subSessionId=c,i.joiningConversation=!0,i.localAddParticipant(b.userName),this.putConversation(i.subSessionId,i),g.debug("Have incoming conversation from: "+a.header.initiator,i)}else g.debug("Have incoming start request from: "+a.header.initiator,i);i&&!i.getStreamForId(e)&&(g.debug("No existing stream for the stream id: "+e+", type: "+h),h===d.STREAMTYPE.SCREENSHARE?i.createScreenShareStream(e):i.createAudioVideoStream(k,e))}i?i.onMessage(a):g.info("Ignoring "+a.control.type+" with action: '"+a.header.action+"' for unknown conversation: "+c)},onRehydration:function(b){function c(b,c){var d=b.call,e=c.call;d.callState=new a.CallState(e.callState.state,e.callState.status.code,e.callState.status.reason,e.callState.streamId),d.earlyMediaState=e.earlyMediaState;var g;if(e.remoteMedias&&e.remoteMedias.length){g=[];for(var h=0;h<e.remoteMedias.length;h++){var i=e.remoteMedias[h];g[h]=new f.Media(i.mode,i.port,i.type)}}d.remoteMedias=g,d.offerAnswerManager.updateState(e.offerAnswerManager.masterState),d.offerAnswerManager.updateState(e.offerAnswerManager.slaveState),d.iceTimeout=e.iceTimeout,d.onCallError=e.onCallError,d.onUpdate=e.onUpdate,d.onCallStateChange=e.onCallStateChange,d.onMediaStreamEvent=e.onMediaStreamEvent,d.onIceConnectionStateChange=e.onIceConnectionStateChange}for(var e in b.entry)if(b.entry.hasOwnProperty(e)){var h=b.entry[e];g.debug("onRehydration invoked for conversation: "+h.subSessionId);var i=this.prepareConversation(h.conversationKey,h.conversationTopic,this.session,h.initiator,h.conversationChannel);if(i.joiningConversation=h.joiningConversation,i.shortCircuitMode=h.shortCircuitMode,i.onRecordingStatusChange=h.onRecordingStatusChange,i.onParticipantChange=h.onParticipantChange,i.onError=h.onError,i.onEnquiryResponse=h.onEnquiryResponse,i.subSessionId=h.subSessionId,i.recording=h.recording,i.recordingRules=h.recordingRules,i.alwaysRecordOnCreation=h.alwaysRecordOnCreation,i.neverRecordOnCreation=h.neverRecordOnCreation,i.sentAutomaticRecordingRequest=h.sentAutomaticRecordingRequest,i.recordingStyle=h.recordingStyle,i.lastRemovedParticipant=h.lastRemovedParticipant,i.pendingTargetURI=h.pendingTargetURI,i.pendingTargetStreamId=h.pendingTargetStreamId,i.pendingTargetStreamOptions=h.pendingTargetStreamOptions,i.pendingTargetStreamProfile=h.pendingTargetStreamProfile,i.webContext=h.webContext,i.pendingAVStreams=h.pendingAVStreams,i.iceCheckInterval=h.iceCheckInterval,i.pendingAddStreamRelay=h.pendingAddStreamRelay,i.sidebarId=h.sidebarId,i.participants=new a.Map,h.participants){var j=[];for(var k in h.participants.entry)h.participants.entry.hasOwnProperty(k)&&j.push(h.participants.entry[k]);for(var l=0;l<j.length;l++){var m=j[l],o=new a.Participant(i,m.uri);if(o.onParticipantStateChange=m.onParticipantStateChange,o.onAddStream=m.onAddStream,o.onAddRemoteStream=m.onAddRemoteStream,m.uri!==this.session.userName){var p=[];for(var q in m.streams.entry)m.streams.entry.hasOwnProperty(q)&&p.push(m.streams.entry[q]);for(var r=0;r<p.length;r++){var s=n.createStreamOptions(p[r].streamOptions.audioConfig,p[r].streamOptions.videoConfig),t=o.localAddStreamInfo(p[r].streamId,p[r].streamType,s,p[r].streamProfile);t.recording=p[r].recording,t.streamLayout=p[r].streamLayout,t.active=p[r].active}}i.participants.put(m.uri,o)}}if(i.streams=new a.Map,h.streams){var u=[];for(var v in h.streams.entry)h.streams.entry.hasOwnProperty(v)&&u.push(h.streams.entry[v]);for(var w=0;w<u.length;w++){var x,y=u[w];if(y.call.streamType===d.STREAMTYPE.AUDIOVIDEO){var z=n.createStreamOptions(y.call.callConfig.audioConfig,y.call.callConfig.videoConfig);x=i.createAudioVideoStream(z,y.streamId,y.streamInfo.streamProfile)}else{var A=n.createStreamOptions(y.call.callConfig.audioConfig,y.call.callConfig.videoConfig);x=i.createScreenShareStream(y.streamId,A,y.streamInfo.streamProfile)}c(x,y),x.localMediaStreams=y.localMediaStreams,x.extHeaders=y.extHeaders,x.onPauseResumeStream=y.onPauseResumeStream,x.onUpdateStreamOptions=y.onUpdateStreamOptions,x.streamInfo.recording=y.streamInfo.recording,x.streamInfo.streamLayout=y.streamInfo.streamLayout,x.streamInfo.active=y.streamInfo.active,g.debug("Rehydrated stream: "+JSON.stringify(x,null,2))}}if(i.relays=new a.Map,h.relays){var B=[];for(var C in h.relays.entry)h.relays.entry.hasOwnProperty(C)&&B.push(h.relays.entry[C]);for(var D=0;D<B.length;D++){var E=B[D],F=new a.Relay(i,E.streamId,E.relayDest,E.relayId);F.responseHandler=E.responseHandler,F.retryHandler=E.retryHandler,F.timeoutHandler=E.timeoutHandler,F.errorHandler=E.errorHandler,F.retries=E.retries,F.timeout=E.timeout,F.timer=E.timer,F.startTime=E.startTime;var G=[];for(var H in E.relayMessages.entry)E.relayMessages.entry.hasOwnProperty(H)&&G.push(E.relayMessages.entry[H]);for(var I=0;I<G.length;I++){var J=new a.RelayMessage(F,G[I].messageType,G[I].messageId);J.responseHandler=G[I].responseHandler,J.retryHandler=G[I].retryHandler,J.timeoutHandler=G[I].timeoutHandler,J.errorHandler=G[I].errorHandler,J.retries=G[I].retries,J.retryCount=G[I].retryCount,J.timeout=G[I].timeout,J.final=G[I].final,J.relayDestinations=G[I].relayDestinations,J.gotRelayResponses=G[I].gotRelayResponses,J.gotAllResponses=G[I].gotAllResponses,J.timestamp=G[I].timestamp,J.message=G[I].message,J.text=G[I].text,J.data=G[I].data,J.commands=G[I].commands,F.relayMessages.put(J.messageId,J)}i.relays.put(F.relayId,F)}}this.putConversation(e,i),g.debug("Completed rehydration of conversation: "+e),this.onResurrect?(g.debug("Conversation has been rehydrated - calling onResurrect"),this.onResurrect(i)):g.debug("onResurrect is not set")}},prepareConversation:function(b,c,e,f,g){var h=new k(b,c,e,f,g),i=new Date;return h.startTime=""+i.getHours()+i.getMinutes()+i.getSeconds()+i.getMilliseconds(),h.callPackage=e.getPackage(d.PACKAGE.CALL),h.callPackage||(h.callPackage=new a.CallPackage(e)),h.callPackage.packageType=this.packageType,h.callPackage.setTrickleIceMode(this.trickleIceMode),h.callPackage.setIPv6(this.ipv6),h.callPackage.setDSCP(this.dscp),h.callPackage.setVideoSendBitrate(this.videoSendBitrate),h.callPackage.setVideoRecvBitrate(this.videoRecvBitrate),h.callPackage.setRemoveVideoFec(this.removeVideoFec),h.callPackage.onIncomingCall=this.onIncoming,h.callPackage.onResurrect=this.onResurrect,h.pkgInstance=this,h},putConversation:function(a,b){this.session.putSubSession(this.packageType,a,b)},setTrickleIceMode:function(a){this.trickleIceMode=a},setIPv6:function(a){this.ipv6=a},setDSCP:function(a){this.dscp=a},setVideoSendBitrate:function(a){this.videoSendBitrate=a},setVideoRecvBitrate:function(a){this.videoRecvBitrate=a},setRemoveVideoFec:function(a){this.removeVideoFec=a},setShortCircuit:function(a){this.shortCircuitMode=a},toJSON:function(){var a={},b={session:""};for(var c in this)this.hasOwnProperty(c)&&(c in b||(a[c]=this[c]));return a}};var k=function(b,c,e,f,i){this.conversationKey=b,this.conversationTopic=c,this.session=e,this.initiator=f,this.conversationChannel=i,this.joiningConversation=!1,this.pkgInstance=null,this.callPackage=null,this.streams=new a.Map,this.relays=new a.Map,this.startTime="",this.__participantsHistory=[],this.onRecordingStatusChange=null,this.onParticipantChange=null,this.onError=null,this.onEnquiryResponse=null,this.onRelayCommand=null,this.onRelayText=null,this.onRelayData=null,this.subSessionId=null,this.participants=new a.Map,this.recording=!1,this.recordingRules=null,this.alwaysRecordOnCreation=!1,this.neverRecordOnCreation=!1,this.sentAutomaticRecordingRequest=!1,this.shortCircuitMode=!1,this.recordingStyle="single",this.lastRemovedParticipant=null,this.pendingTargetURI=null,this.pendingTargetStreamId=null,this.pendingTargetStreamOptions=null,this.pendingTargetStreamProfile=null,this.webContext=null,this.pendingAVStreams=[],this.removed=!1,this.pendingAddStreamRelay=null,this.sidebarId=null;var j=2e3;this.setIceCheckInterval=function(a){if(a<=0)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};j=a},this.getIceCheckInterval=function(){return j},this.getLocalId=function(){return this.subSessionId},this.generateStreamId=function(a){var b=this.streams.values().filter(function(b){return b.getType()===a}).length;g.debug("Found "+b+" streams with type: "+a);var c="av";return a===d.STREAMTYPE.SCREENSHARE&&(c="ss"),c+(b+1)+"-"+this.startTime;
},this.generateRelayId=function(){var a=this.relays.size();g.debug("Found "+a+" relays");var b="r";return b+(a+1)+"-"+this.startTime},this.withParticipant=function(a,b,c){this.pendingTargetURI=a;var e=this.localAddParticipant(a);return b||(b=this.getDefaultStreamOptions()),this.pendingTargetStreamId=e.localAddStreamInfo(null,null,b,c).getId(),this.pendingTargetStreamOptions=b,this.pendingTargetStreamProfile=c,this.onParticipantChange&&this.onParticipantChange(this,d.CONVERSATIONSTATE.STREAM_ADDED,e),this},this.withChannel=function(a){return this.conversationChannel=a,this},this.withKey=function(a){return a&&(g.debug("Joining conversation with key="+a),this.conversationKey=a,this.joiningConversation=!0),this},this.withTopic=function(a){return this.conversationTopic=this.pkgInstance.encodeConversationTopic(a),this},this.withContext=function(a){return this.webContext=a,this},this.withCallbacks=function(a,b,c,e,f,g,h){if(this.onRecordingStatusChange=a,this.onParticipantChange=b,this.onError=c,this.onRelayCommand=e,this.onRelayText=f,this.onRelayData=g,this.onEnquiryResponse=h,this.onParticipantChange)for(var i=this.participants.values(),j=0;j<i.length;j++)this.onParticipantChange(this,d.CONVERSATIONSTATE.STREAM_ADDED,i[j]);return this},this.withShortCircuit=function(){return this.shortCircuitMode=!0,this},this.isShortCircuit=function(){return this.shortCircuitMode},this.getSidebar=function(){return this.sidebarId},this.withRecording=function(){return this.alwaysRecordOnCreation=!0,this},this.withoutRecording=function(){return this.neverRecordOnCreation=!0,this},this.localSetRecording=function(a){this.recording=a,this.recording?g.debug("Conversation is being recorded"):g.debug("Conversation is not being recorded")},this.localAddParticipant=function(a){var b=new o(this,a);return this.participants.put(a,b),b},this.localRemoveParticipant=function(a){return this.lastRemovedParticipant=this.getParticipant(a),this.participants.remove(a)&&g.debug("Removed Participant with uri="+a),this.lastRemovedParticipant},this.decodeConversationTopic=function(){if(!this.conversationTopic)return null;var a=this.conversationTopic,b=a.indexOf("@");return b&&(a=a.substring(0,b)),a=a.replace(/_/g," ")},this.setRecordingStyle=function(a){this.recordingStyle=a},this.getRecordingStyle=function(){return this.recordingStyle},this.setRecordingRules=function(a){this.recordingRules=a},this.getRecordingRules=function(){return this.recordingRules},this.getPendingTarget=function(){return{uri:this.pendingTargetURI,streamId:this.pendingTargetStreamId,streamOptions:this.pendingTargetStreamOptions,streamProfile:this.pendingTargetStreamProfile}},this.clearPendingTarget=function(){this.pendingTargetURI=null,this.pendingTargetStreamId=null,this.pendingTargetStreamOptions=null,this.pendingTargetStreamProfile=null},this.replacePendingTarget=function(a){var b=this.getPendingTarget();g.debug("Replacing pending destination: '"+b.uri+"' with actual destination: '"+a+"'");var c=this.getParticipant(b.uri);c&&this.localRemoveParticipant(b.uri);var e=this.localAddParticipant(a);e.localAddStreamInfo(b.streamId,d.STREAMTYPE.AUDIOVIDEO,b.streamOptions,b.streamProfile),g.debug("Replaced pending destination with actual destination: '"+a+"'"),this.clearPendingTarget(),this.onParticipantChange&&this.onParticipantChange(this,d.CONVERSATIONSTATE.STREAM_ADDED,e)},this.defaultEnquiryResponse=function(a){var b=null;if(a){b=JSON.parse("{}"),g.debug("Processing recording rules for conversation: "+JSON.stringify(a,null,2));var c=a.destination_uri;c&&this.replacePendingTarget(c);var d=a.recording_style;d&&(g.debug("Will record using style: "+d),this.setRecordingStyle(d));var e=a.exclude_conversation,f=a.include_conversation,h=a.include_associations,i=a.exclude_associations,j=a.include_participants;e?g.debug("Not recording conversation"):f?(g.debug("Recording conversation"),b.participants=["*"],this.withRecording()):(h&&(g.debug("Including associations: "+JSON.stringify(h,null,2)),b.include_associations=[].concat(h),this.withRecording()),i&&(g.debug("Excluding associations: "+JSON.stringify(i,null,2)),b.exclude_associations=[].concat(i),this.withRecording()),j&&(g.debug("Including participants: "+JSON.stringify(j,null,2)),b.participants=[].concat(j),this.withRecording()))}this.setRecordingRules(b)},this.onIceConnectionStateChange=function(a,b){g.debug("onIceConnectionStateChange: "+b,a);var c=this.getLocalParticipant();if(c){var e=c.getStreamInfo(a.streamId);if(e)if("connected"===b||"completed"===b){if(!e.isActive()){e.localSetActive(!0);var f=[{uri:c.getUri(),streams:[{stream_id:a.getId(),stream_type:a.getType(),stream_options:a.getStreamOptions()}]}];h.relayStreamEvent(a,d.CONVERSATIONSTATE.STREAM_ACTIVE,f),h.handleParticipantChange(this,d.CONVERSATIONSTATE.STREAM_ACTIVE,f[0].uri,f[0].streams)}}else e.isActive()&&e.localSetActive(!1)}},this.createStreamOfType=function(b,c,e,f){var h=this.callPackage.prepareCall(this.session,e,this.initiator,null);h.subSessionId=this.subSessionId,h.pkgInstance=this.callPackage,h.conversation=this,h.streamId=b,h.streamType=c,h.callState.streamId=b,h.shortCircuitMode=this.shortCircuitMode;var i,j=this.getLocalParticipant().localAddStreamInfo(b,c,e,f);switch(c){case d.STREAMTYPE.AUDIOVIDEO:i=new a.AudioVideoStream(this,h,b,j);break;case d.STREAMTYPE.SCREENSHARE:i=new a.ScreenShareStream(this,h,b,j);break;default:return g.error("Unknown stream type: "+c),null}return this.streams.put(b,i),i.call.onIceConnectionStateChange=this.onIceConnectionStateChange.bind(this,i),i},this.createAudioVideoStream=function(a,b,c){return a||(a=this.getDefaultStreamOptions()),b||(b=this.generateStreamId(d.STREAMTYPE.AUDIOVIDEO)),this.createStreamOfType(b,d.STREAMTYPE.AUDIOVIDEO,a,c)},this.createScreenShareStream=function(b,c,e){return c||(c=new a.StreamOptions(d.MEDIADIRECTION.NONE,d.MEDIADIRECTION.SENDRECV)),b||(b=this.generateStreamId(d.STREAMTYPE.SCREENSHARE)),this.createStreamOfType(b,d.STREAMTYPE.SCREENSHARE,c,e)},this.getDefaultStreamOptions=function(){var b;return b="audio"===this.conversationChannel?new a.StreamOptions(d.MEDIADIRECTION.SENDRECV,d.MEDIADIRECTION.NONE):new a.StreamOptions(d.MEDIADIRECTION.SENDRECV,d.MEDIADIRECTION.SENDRECV)},this.getStreamForId=function(a){var b=this.streams.get(a);return b||"default"!==a||(b=this.streams.get("av1-"+this.startTime)),b},this.remove=function(){this.pkgInstance.remove(this)},this.createRelay=function(b,c,d){d||(d=this.generateRelayId());var e=new a.Relay(this,b,c,d);return this.relays.put(d,e),g.debug("Created relay for stream: "+b+" with id: "+d+" and destination: "+JSON.stringify(c,null,2)),e},this.getRelayForId=function(a){var b=this.relays.get(a);return b||"default"!==a||(b=this.getRelay()),b},this.getRelayForStream=function(a){var b=this.relays.values(),c=b.filter(function(b){return a.getId&&b.getStreamId()===a.getId()},this);return c.length>0?c[0]:null},this.getSpecificRelayForStream=function(a){var b=this.relays.values(),c=b.filter(function(b){return a.getId&&b.getStreamId()===a.getId()&&"*"!==b.getDestination()},this);return c.length>0?c[0]:null},this.getRelayForDestUrl=function(a){var b=function(b){return!(!b.getParticipant||b.getParticipant().getUri()!==a)||b===a},c=this.relays.values(),d=c.filter(function(a){var c=!1,d=a.getDestination();return c=Array.isArray(d)?d.filter(b).length>0:b(d)},this);return d.length>0?d[0]:null},this.getRelay=function(){return this.relays.get("r1-"+this.startTime)}};k.prototype={end:function(a){this.session.sessionState!==cloud.SESSIONSTATE.CLOSED&&this.session.sessionState!==cloud.SESSIONSTATE.FAILED&&this.streams.size()>0&&(g.info("Begin to remove all participants",this),h.sendRemoveAllParticipants(this),this.streams.values().forEach(function(b){b.end(a)})),this.participants.clear(),this.remove()},getInitiator:function(){return this.initiator},getTopic:function(){return this.decodeConversationTopic()},getKey:function(){return this.conversationKey},getChannel:function(){return this.conversationChannel},getContext:function(){return this.webContext},addParticipant:function(a,b,c){var d=this.localAddParticipant(a);return b||(b=this.getDefaultStreamOptions()),d.localAddStreamInfo(null,null,b,c),this.streams.size()>0&&(g.info("Begin to add participant: "+a,this),h.sendAddParticipant(this,d)),d},getParticipants:function(){return this.participants.values()},getParticipant:function(a){return this.participants.values().find(function(b){return b.uri===a},this)},getLocalParticipant:function(){return this.getParticipant(this.getLocalParticipantUri())},getRemoteParticipant:function(){for(var a=this.getParticipants(),b=0;b<a.length;b++)if(this.getLocalParticipantUri()!==a[b].getUri())return a[b];return null},getLocalParticipantUri:function(){return this.session.userName},getAudioVideoStream:function(a){if(!a){var b=this.streams.values().filter(function(a){return a.getType()===d.STREAMTYPE.AUDIOVIDEO&&!a.getStreamState().isFinalState()});b.length>0&&(a=b[0].streamId)}return this.getStreamForId(a)},getScreenShareStream:function(a){if(!a){var b=this.streams.values().filter(function(a){return a.getType()===d.STREAMTYPE.SCREENSHARE&&!a.getStreamState().isFinalState()});b.length>0&&(a=b[0].streamId)}return this.getStreamForId(a)},offerOutboundScreenShare:function(a,b){var c=this.getRemoteParticipant();if(c){var e=c.getStreamInfos()[0],f=c.getUri();g.debug("offerOutboundScreenShare to remote participant: "+f);var h=this.getRelayForStream(e);null===h?h=this.createRelay(e.getId(),e):g.debug("Found relay with id: "+h.getId());var i={stream_type:d.STREAMTYPE.SCREENSHARE,stream_options:{audio:d.MEDIADIRECTION.NONE,video:d.MEDIADIRECTION.SENDONLY}};h.createCommand(d.CONVERSATION.REMOTE_ADD_STREAM,i).withCallbacks(a,b).send()}else g.info("offerOutboundScreenShare: no remote participant")},getStreams:function(){return this.streams.values()},updateStreamId:function(a,b){this.streams.remove(b),this.streams.put(a.streamId,a)},toJSON:function(){return{conversationKey:this.conversationKey,conversationTopic:this.conversationTopic,initiator:this.initiator,conversationChannel:this.conversationChannel,joiningConversation:this.joiningConversation,shortCircuitMode:this.shortCircuitMode,streams:this.streams,relays:this.relays,startTime:this.startTime,onRecordingStatusChange:this.onRecordingStatusChange,onParticipantChange:this.onParticipantChange,onError:this.onError,onEnquiryResponse:this.onEnquiryResponse,subSessionId:this.subSessionId,participants:this.participants,recording:this.recording,recordingRules:this.recordingRules,alwaysRecordOnCreation:this.alwaysRecordOnCreation,neverRecordOnCreation:this.neverRecordOnCreation,sentAutomaticRecordingRequest:this.sentAutomaticRecordingRequest,recordingStyle:this.recordingStyle,lastRemovedParticipant:this.lastRemovedParticipant,pendingTargetURI:this.pendingTargetURI,pendingTargetStreamId:this.pendingTargetStreamId,pendingTargetStreamOptions:this.pendingTargetStreamOptions,pendingTargetStreamProfile:this.pendingTargetStreamProfile,webContext:this.webContext,pendingAVStreams:this.pendingAVStreams,iceCheckInterval:this.iceCheckInterval,pendingAddStreamRelay:this.pendingAddStreamRelay,sidebarId:this.sidebarId}},onMessage:function(a){if(g.debug("Received "+a.control.type+" with action: "+a.header.action,this),a.isReliableRelay())h.doReliableRelay(this,a);else if(a.isRequest())h.doRequest(this,a);else if(a.isResponse())h.doResponse(this,a);else if(a.isMessage())h.doMessage(this,a);else if(a.isError())h.doError(this,a);else{var b=this.getAudioVideoStream().call;b&&b.onMessage(a)}},startRecording:function(){g.info("Begin to start recording",this),this.streams.size()>0?h.sendBeginRecording(this):(g.debug("Will start recording conversation on creation"),this.alwaysRecordOnCreation=!0)},stopRecording:function(){g.info("Begin to stop recording",this),this.streams.size()>0?h.sendEndRecording(this):(g.debug("Will NOT start recording conversation on creation"),this.neverRecordOnCreation=!0)},isRecording:function(){return this.recording},switchToSidebar:function(){h.sendCreateSidebar(this)},addRemainingStreams:function(){h.sendDelayedAddStreamRequest(this)},relayCommandTo:function(a,b,c,d){return a||(a=this.getAudioVideoStream().getId()),this.createRelay(a,b).createRelayMessage().withCommand(c,d).send()},relayTextTo:function(a,b,c,d){return a||(a=this.getAudioVideoStream().getId()),this.createRelay(a,b).createRelayMessage().withText(c,d).send()},relayDataTo:function(a,b,c,d){return a||(a=this.getAudioVideoStream().getId()),this.createRelay(a,b).createRelayMessage().withData(c,d).send()}};var l=function(a,b,c){this.audio=a,this.video=b,this.reason=c,this.pausedBy=null};l.prototype={toJSON:function(){return{audio:this.audio,video:this.video,reason:this.reason?this.reason:""}}};var m=function(a,b,c,d){this.upgraded=a&&"true"===a.toString(),this.paused=b&&"true"===b.toString(),c?this.paused_by=c:this.paused_by="",this.pauseResume=d};m.create=function(b){var c=new a.PauseResume(d.PAUSERESUME.RESUME,d.PAUSERESUME.RESUME,null);if(b){var e=b.paused_by?b.paused_by:"";return b.pause_resume_audio&&b.pause_resume_video?c=new a.PauseResume(b.pause_resume_audio,b.pause_resume_video,b.pause_resume_reason):b.pauseResume&&b.pauseResume.audio&&b.pauseResume.video?c=new a.PauseResume(b.pauseResume.audio,b.pauseResume.video,b.pauseResume.reason):(b.upgraded=!0,b.paused=!1),new a.StreamProfile(b.upgraded,b.paused,e,c)}return new a.StreamProfile((!0),(!1),"",c)},m.prototype={toJSON:function(){return{upgraded:this.upgraded,paused:this.paused,paused_by:this.paused_by,pause_resume_audio:this.pauseResume.audio,pause_resume_video:this.pauseResume.video,pause_resume_reason:this.pauseResume.reason?this.pauseResume.reason:""}},updateForPauseResume:function(b,c){var e=b.audio===d.PAUSERESUME.PAUSE&&b.video===d.PAUSERESUME.PAUSE;this.pauseResume=new a.PauseResume(b.audio,b.video,b.reason),b.reason===d.PAUSERESUMEREASON.UPGRADE_DOWNGRADE?this.upgraded=b.video===d.PAUSERESUME.RESUME:(this.paused=e,c&&e?this.paused_by=c:this.paused_by="")}};var n=function(b,c,e,f,h){this.participant=b,this.streamId=c,this.streamType=e,this.streamLayout=d.STREAMSIZE.MIN,this.recording=!1,this.PAUSED=new a.StreamOptions(d.MEDIADIRECTION.NONE,d.MEDIADIRECTION.NONE),this.streamProfile=m.create(h),this.streamOptions=this.PAUSED,this.qualityMonitor=null,this.active=!1,this.localSetStreamOptions=function(a){if(a){var b=a.audio,c=a.video,d=a.audioConfig,e=a.videoConfig;a=b&&c?n.createStreamOptions(b,c):d&&e?n.createStreamOptions(d,e):this.participant.conversation.getDefaultStreamOptions()}else a=this.participant.conversation.getDefaultStreamOptions();g.debug("Changing options for stream: "+this.streamId+", options="+JSON.stringify(a,null,2)),this.streamOptions=a},this.localSetStreamOptions(f),this.localSetStreamLayout=function(a){null!==a&&g.debug("Changing layout '"+a+"' for stream: "+this.streamId),this.streamLayout=a},this.localSetStreamProfile=function(b){g.debug("Changing profile '"+JSON.stringify(b,null,2)+"' for stream: "+this.streamId),this.streamProfile=a.StreamProfile.create(b)},this.localSetRecording=function(a){this.recording=a,this.recording?g.debug("Participant "+this.participant.uri+" is being recorded"):g.debug("Participant "+this.participant.uri+" is not being recorded")},this.localSetActive=function(a){this.active=a,g.debug("Participant "+this.participant.uri+" stream: "+this.streamId+(a?" is active":" is not active"))},this.asJSON=function(){return{stream_id:this.streamId,stream_type:this.streamType,stream_options:this.streamOptions.asJSON(),stream_profile:this.streamProfile}}};n.prototype={toJSON:function(){return{streamId:this.streamId,streamType:this.streamType,streamLayout:this.streamLayout,recording:this.recording,streamOptions:this.streamOptions,active:this.active,streamProfile:this.streamProfile}},getParticipant:function(){return this.participant},getId:function(){return this.streamId},getType:function(){return this.streamType},getStreamOptions:function(){return this.streamOptions},getStreamProfile:function(){return this.streamProfile},pauseResumeStream:function(a,b,c){g.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(a,null,2));var d=this.participant.conversation.getLocalParticipantUri();return this.participant.getUri()!==d?h.sendPauseResume(this.participant.conversation,this,a,b,c):(g.debug("Pausing/Resuming audio/video tracks in stream: "+this.streamId,a),void this.participant.conversation.getAudioVideoStream(this.streamId).pauseResumeStream(a,b,c))},cancelPauseResumeStream:function(a,b){return g.debug("cancelPauseResumeStream"),h.sendCancelRequest(this.participant.conversation,this,d.CONVERSATION.PAUSE_RESUME_STREAM,a,b)},cancelAddStream:function(a,b){return g.debug("cancelAddStream"),h.sendCancelRequest(this.participant.conversation,this,d.CONVERSATION.ADD_STREAM,a,b)},setStreamOptions:function(a,b,c){var e=this;if(a||(g.debug("Pausing media for stream: "+this.streamId),a=this.PAUSED),h.isPauseResume(this.streamOptions,a))return this.pauseResumeStream(h.getPauseResumeTargets(a),b,c);var f,i=this.participant.getStreamInfos().some(function(a){return a.getStreamOptions().videoConfig===d.MEDIADIRECTION.SENDONLY||a.getStreamOptions().videoConfig===d.MEDIADIRECTION.RECVONLY}),j=a.videoConfig===d.MEDIADIRECTION.SENDONLY;return this.participant.getUri()!==this.participant.conversation.getLocalParticipantUri()?this.participant.conversation.isShortCircuit()?(g.debug("Short-circuit, checking video options: "+a.videoConfig),f=n.createStreamOptions(a.audioConfig,a.videoConfig),i&&j?f.videoConfig=d.MEDIADIRECTION.SENDRECV:i&&!j&&(g.debug("Single video downgrade, do not swap directions"),f.videoConfig=d.MEDIADIRECTION.NONE),h.sendStreamOptions(this.participant.conversation,this,f,b,c)):h.sendStreamOptions(this.participant.conversation,this,a,b,c):(g.debug("Updating local AV stream with new stream options: "+JSON.stringify(a,null,2)),f=n.createStreamOptions(a.audioConfig,a.videoConfig),this.participant.conversation.isShortCircuit()&&(i&&j?f.videoConfig=d.MEDIADIRECTION.SENDRECV:i&&!j&&(f.videoConfig=d.MEDIADIRECTION.NONE)),e.participant.conversation.getAudioVideoStream(e.streamId).update(f,b,c),void 0)},getLayout:function(){return this.streamLayout},setLayout:function(a,b){this.localSetStreamLayout(a),h.sendStreamLayout(this.participant.conversation,this,a,b)},isRecording:function(){return this.recording},isActive:function(){return this.active},startRecording:function(){g.info("Begin to start recording stream: "+this.streamId,this),h.sendBeginRecording(this.participant.conversation,this)},stopRecording:function(){g.info("Begin to stop recording stream: "+this.streamId,this),h.sendEndRecording(this.participant.conversation,this)},remove:function(){this.participant.streams.size()>1?(g.info("Begin to remove stream: "+this.streamId,this),h.sendRemoveParticipant(this.participant.conversation,this.participant,this)):this.participant.remove()},isAudioPaused:function(){return this.streamProfile&&this.streamProfile.pauseResume&&this.streamProfile.pauseResume.audio===d.PAUSERESUME.PAUSE},isVideoPaused:function(){return this.streamProfile&&this.streamProfile.pauseResume&&this.streamProfile.pauseResume.video===d.PAUSERESUME.PAUSE},getQualityMonitor:function(){return this.qualityMonitor||(this.qualityMonitor=new a.QualityMonitor(this))}},n.createStreamOptions=function(b,c){var e=function(a){var b=d.MEDIADIRECTION.NONE;switch(a.toLowerCase()){case"inactive":case"none":b=d.MEDIADIRECTION.NONE;break;case"sendonly":b=d.MEDIADIRECTION.SENDONLY;break;case"recvonly":b=d.MEDIADIRECTION.RECVONLY;break;case"sendrecv":b=d.MEDIADIRECTION.SENDRECV}return b},f=e(b),g=e(c);return new a.StreamOptions(f,g)};var o=function(b,c){this.streams=new a.Map,this.removedStreams=[],this.conversation=b,this.uri=c,g.debug("Participant with URI: "+this.uri),this.onParticipantStateChange=null,this.onAddStream=null,this.onAddRemoteStream=null,this.localAddStreamInfo=function(b,c,e,f){b||(b=this.conversation.generateStreamId(c)),c||(c=d.STREAMTYPE.AUDIOVIDEO),e||(e=this.conversation.getDefaultStreamOptions()),f?f=a.StreamProfile.create(f):(f=a.StreamProfile.create(),f.upgraded=e.shouldSendVideo()),g.debug("Creating StreamInfo: id="+b+", URI="+this.uri+", type="+c+", options="+JSON.stringify(e,null,2)+", profile="+JSON.stringify(f,null,2));var h=new a.StreamInfo(this,b,c,e,f);return this.streams.put(b,h),g.debug("Found stream length after adding "+this.streams.values().length),h},this.notRemovedStream=function(a){return this.removedStreams.indexOf(a)===-1},this.localRemoveStreamInfo=function(a){return this.streams.remove(a)&&(this.removedStreams.push(a),g.debug("Removed StreamInfo with ="+this.uri+"/"+a)),this.streams.size()}};o.prototype={initCallbacks:function(a,b,c){g.debug("Initialise callbacks for participant: "+this.uri),this.onParticipantStateChange=a,this.onAddStream=b,this.onAddRemoteStream=c},remove:function(a){this.conversation.localRemoveParticipant(this.uri),this.conversation.streams.size()>0&&(this.uri===this.conversation.getLocalParticipantUri()?(this.conversation.streams.values().forEach(function(b){b.end(a)}),this.conversation.remove()):(g.info("Begin to remove participant: "+this.uri,this),h.sendRemoveParticipant(this.conversation,this)))},asJSONArray:function(a){for(var b=this.streams.values(),c=[],d=0;d<b.length;d++){var e={uri:this.uri,stream_id:b[d].getId(),stream_type:a?a:b[d].getType(),stream_options:b[d].getStreamOptions().asJSON(),stream_profile:b[d].getStreamProfile()},f=b[d].getLayout();f&&(e.size=f),c.push(e)}return c},toJSON:function(){return{streams:this.streams,uri:this.uri,onParticipantStateChange:this.onParticipantStateChange,onAddStream:this.onAddStream,onAddRemoteStream:this.onAddRemoteStream}},getUri:function(){return this.uri},getStreamInfos:function(){return this.streams.values()},getStreamInfo:function(a){var b=this.streams.get(a);return b||"default"!==a||(b=this.streams.get("av1")),b},isRecording:function(){var a=!1;return this.streams.values().forEach(function(b){b.isRecording()&&(a=!0)}),a},addScreenShareStream:function(a,b,c,e,f){if(this.uri===this.conversation.getLocalParticipantUri())return this.conversation.createScreenShareStream(a,e,f);var g=n.createStreamOptions(d.MEDIADIRECTION.INACTIVE,d.MEDIADIRECTION.SENDONLY);return h.sendAddStream(this.conversation,this,d.STREAMTYPE.SCREENSHARE,g,b,c),!0},addAudioVideoStream:function(a,b,c,e,f){return this.uri===this.conversation.getLocalParticipantUri()?this.conversation.createAudioVideoStream(a,b,f):(h.sendAddStream(this.conversation,this,d.STREAMTYPE.AUDIOVIDEO,a,c,e),!0)}};var p=function(a,b,c,d){this.conversation=a,this.call=b,this.call.avStream=this,this.streamId=c,this.extHeaders=null,this.localMediaStreams=null,this.streamInfo=d,this.onPauseResumeStream=null,this.onUpdateStreamOptions=null};p.prototype={toJSON:function(){return{call:this.call,streamId:this.streamId,extHeaders:this.extHeaders,localMediaStreams:this.localMediaStreams,streamInfo:this.streamInfo,onPauseResumeStream:this.onPauseResumeStream,onUpdateStreamOptions:this.onUpdateStreamOptions}},withCallbacks:function(a,b,c,d,e,f){return this.call.onCallStateChange=a,this.call.onMediaStreamEvent=b,this.call.onUpdate=c,this.call.onCallError=d,this.onPauseResumeStream=e,this.onUpdateStreamOptions=f,this},getConversation:function(){return this.conversation},getId:function(){return this.streamId},getType:function(){return d.STREAMTYPE.AUDIOVIDEO},getStreamOptions:function(){return this.call.callConfig},getStreamState:function(){return this.call.callState},getStreamInfo:function(){return this.streamInfo},isAudioPaused:function(){return this.streamInfo&&this.streamInfo.isAudioPaused()},isVideoPaused:function(){return this.streamInfo&&this.streamInfo.isVideoPaused()},mute:function(a){return g.debug("Muting stream? "+a),this.call.mute(a)},isMuted:function(){return this.call.isMuted()},getRemoteStreams:function(){return f.getRemoteStreams(this.call.peerConnection)},getLocalStreams:function(){return f.getLocalStreams(this.call.peerConnection)},start:function(a,b){return this.localMediaStreams=a,this.extHeaders=b,!this.conversation.recordingRules&&h.retrieveRecordingRules(this.conversation)?this.conversation.pendingAVStreams.push(this):h.sendStartRequest(this),this},end:function(a){h.sendEndRequest(this,a)},decline:function(a,b){h.sendDeclineResponse(this,a,b)},accept:function(a,b,c){h.sendAcceptResponse(this,a,b,c)},update:function(a,b,c,d,e){return g.debug("Attempting to update AV stream"),this.call.canUpdate()?(h.isPauseResume(this.getStreamOptions(),a)?this.pauseResumeStream(h.getPauseResumeTargets(a),d,e):(h.sendUpdateRequest(this,a,b,c),"function"==typeof d&&d(!0)),!0):(g.info("Cannot update call - not in correct ICE state: "+this.call.getIceConnectionState()+", call state: "+this.call.getCallState().state,this.call),"function"==typeof e&&e(!1),!1)},pauseResumeStream:function(a,b,c){var e=a.audio===d.PAUSERESUME.PAUSE,f=a.video===d.PAUSERESUME.PAUSE;return g.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamInfo.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(a,null,2)),g.debug((e?"Pausing":"Resuming")+" audio tracks in AV stream"),g.debug((f?"Pausing":"Resuming")+" video tracks in AV stream"),h.pauseResumeLocalAVStream(this,a),"function"==typeof b&&b(!0),!0},resume:function(a,b){g.info("Begin to resume stream",this),this.call.resume(a,b)}};var q=function(a,b,c,d){this.conversation=a,this.call=b,this.call.avStream=this,this.streamId=c,this.extHeaders=null,this.localMediaStreams=null,this.streamInfo=d,this.onPauseResumeStream=null,this.onUpdateStreamOptions=null};q.prototype={toJSON:function(){return{call:this.call,streamId:this.streamId,extHeaders:this.extHeaders,localMediaStreams:this.localMediaStreams,streamInfo:this.streamInfo,onPauseResumeStream:this.onPauseResumeStream,onUpdateStreamOptions:this.onUpdateStreamOptions}},withCallbacks:function(a,b,c,d,e,f){return this.call.onCallStateChange=a,this.call.onMediaStreamEvent=b,this.call.onUpdate=c,this.call.onCallError=d,this.onPauseResumeStream=e,this.onUpdateStreamOptions=f,this},getConversation:function(){return this.conversation},getId:function(){return this.streamId},getType:function(){return d.STREAMTYPE.SCREENSHARE},getStreamOptions:function(){return this.call.callConfig},getStreamState:function(){return this.call.callState},getStreamInfo:function(){return this.streamInfo},isAudioPaused:function(){return this.streamInfo&&this.streamInfo.isAudioPaused()},isVideoPaused:function(){return this.streamInfo&&this.streamInfo.isVideoPaused()},mute:function(a){return g.debug("Muting stream? "+a),this.call.mute(a)},isMuted:function(){return this.call.isMuted()},getRemoteStreams:function(){return f.getRemoteStreams(this.call.peerConnection)},getLocalStreams:function(){return f.getLocalStreams(this.call.peerConnection)},start:function(a,b){return this.localMediaStreams=a,b||(b=JSON.parse("{}")),this.extHeaders=b,this.conversation.joiningConversation||this.conversation.recordingRules?h.sendStartRequest(this):h.retrieveRecordingRules(this.conversation)&&this.conversation.pendingAVStreams.push(this),this},end:function(a){h.sendEndRequest(this,a)},accept:function(a,b,c){h.sendAcceptResponse(this,a,b,c)},decline:function(a,b){h.sendDeclineResponse(this,a,b)},update:function(a,b,c,d,e){return g.debug("Attempting to update SS stream"),this.call.canUpdate()?(h.isPauseResume(this.getStreamOptions(),a)?this.pauseResumeStream(h.getPauseResumeTargets(a),d,e):(h.sendUpdateRequest(this,a,b,c),"function"==typeof d&&d(!0)),!0):(g.info("Cannot update call - not in correct ICE state: "+this.call.getIceConnectionState()+", call state: "+this.call.getCallState().state,this.call),"function"==typeof e&&e(!1),!1)},pauseResumeStream:function(a,b,c){var e=a.audio===d.PAUSERESUME.PAUSE,f=a.video===d.PAUSERESUME.PAUSE;return g.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamInfo.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(a,null,2)),this.streamInfo&&this.streamInfo.streamProfile&&this.streamInfo.streamProfile.pauseResume&&a.audio===this.streamInfo.streamProfile.pauseResume.audio&&a.video===this.streamInfo.streamProfile.pauseResume.video?(a.audio===this.streamInfo.streamProfile.pauseResume.audio&&g.debug("AV stream audio tracks already "+(e?"paused":"resumed")),a.video===this.streamInfo.streamProfile.pauseResume.video&&g.debug("AV stream video tracks already "+(f?"paused":"resumed")),h.enableDisableTracks(this,a)):(g.debug((e?"Pausing":"Resuming")+" audio tracks in AV stream"),g.debug((f?"Pausing":"Resuming")+" video tracks in AV stream"),h.pauseResumeLocalAVStream(this,a)),"function"==typeof b&&b(!0),!0},resume:function(a,b){g.info("Begin to resume stream",this),this.call.resume(a,b)}};var r=function(b,c,d,e){this.conversation=b,this.responseHandler=null,this.retryHandler=null,this.timeoutHandler=null,this.errorHandler=null,this.relayId=e,this.retries=1,this.timeout=10,this.streamId=c,this.relayDest=d,this.relayMessages=new a.Map,this.timer=null;var f=new Date;this.startTime=""+f.getHours()+f.getMinutes()+f.getSeconds()+f.getMilliseconds()};r.prototype={toJSON:function(){return{responseHandler:this.responseHandler,retryHandler:this.retryHandler,timeoutHandler:this.timeoutHandler,errorHandler:this.errorHandler,relayId:this.relayId,retries:this.retries,timeout:this.timeout,streamId:this.streamId,relayDest:this.relayDest,relayMessages:this.relayMessages,timer:this.timer,startTime:this.startTime}},withCallbacks:function(a,b){return this.responseHandler=a,this.errorHandler=b,this},withTimeout:function(a,b){return b&&(this.timeoutHandler=b),this.timeout=a,this},withRetries:function(a,b){b&&(this.retryHandler=b),this.retries=a},getConversation:function(){return this.conversation},getId:function(){return this.relayId},getDestination:function(){return this.relayDest},getStreamId:function(){return this.streamId},createRelayRequest:function(b){b||(g.debug("Calling generateRelayMessageId with type: "+d.TYPE.REQUEST),b=this.generateRelayMessageId(d.TYPE.REQUEST));var c=new a.RelayMessage(this,d.TYPE.REQUEST,b);return this.relayMessages.put(b,c),c},createRelayMessage:function(b){return b||(g.debug("Calling generateRelayMessageId with type: "+d.TYPE.MESSAGE),b=this.generateRelayMessageId(d.TYPE.MESSAGE)),new a.RelayMessage(this,d.TYPE.MESSAGE,b)},createSubsequentRelayResponse:function(b){return new a.RelayMessage(this,d.TYPE.RESPONSE,b.header.relay.msgId)},createFinalRelayResponse:function(b){return new a.RelayMessage(this,d.TYPE.RESPONSE,b).asFinalMessage()},createRelayError:function(b){return new a.RelayMessage(this,d.TYPE.ERROR,b)},generateRelayMessageId:function(a){var b=this.relayMessages.values().filter(function(b){return b.getMessageType()===a}).length;g.debug("Found "+b+" messages with type: "+a);var c="rly-";return a===d.TYPE.REQUEST?c+="req":a===d.TYPE.RESPONSE?c+="res":a===d.TYPE.ERROR?c+="err":a===d.TYPE.MESSAGE&&(c+="msg"),c+(b+1)+"-"+this.startTime},getRelayMessageForId:function(a){return this.relayMessages.get(a)},end:function(){clearInterval(this.timer),this.conversation.relays.remove(this.relayId)},send:function(a){if(a.isRequest()&&(a.updateTimestamp(),void 0===a.retryCount||null===a.retryCount?(a.retryCount=0,g.debug("Relay sending message: id="+a.getId())):(a.retryCount++,g.debug("Relay sending message: id="+a.getId()+", retry="+a.retryCount))),this.conversation.session.sendMessage(a.getMessage(!1)),a.isRequest()){var b=this;this.timer||(g.debug("Relay "+this.relayId+" starting interval timer for tracking timeouts"),this.timer=setInterval(function(){b.handleIntervalTimeout()},1e3))}return a},handleIntervalTimeout:function(){g.debug("handleIntervalTimeout...");var a=Date.now();if(0===this.relayMessages.size())g.debug("Relay.handleIntervalTimeout no messages being tracked. Stopping interval timer"),clearInterval(this.timer),this.timer=null;else{var b,c,d=this.relayMessages.keys(),e=d.length;g.debug("Relay.handleIntervalTimeout tracking "+e+" relay messages"),
d.forEach(function(d){g.debug("Found key="+d+" in relayMessages cache");var f=this.relayMessages.get(d);if(f.gotAllResponses)return g.debug("Got all responses"),void(e-=1);var h=!1,i=1,j=[];if(f&&f.gotRelayResponses)for(j=Object.keys(f.gotRelayResponses),i=j.length,g.debug("Message sent to "+i+" destinations"),b=0;b<j.length;b++)c=j[b],g.debug("relayMessage.gotRelayResponses["+c+"] is set to '"+f.gotRelayResponses[c]+"'"),f.gotRelayResponses[c]===!0&&(h=!0);if(f){var k=a-f.getTimestamp(),l=k/1e3,m=f.timeout;null===m&&(m=this.timeout);var n=f.retries;if(null===n&&(n=this.retries),g.debug("elapsedSeconds="+l),g.debug("       timeout="+m),h){if(l>=m){for(g.debug("Only some relay destinations have responded. Creating separate relays for re-sends"),b=0;b<j.length;b++)if(c=j[b],f.gotRelayResponses[c]===!1){var o=this.getConversation().createRelay(this.streamId,c),p=this.createRelayRequest().withMessage(f);o.send(p)}g.debug("Removing Relay Message "+d+" from cache"),this.relayMessages.remove(d)}}else j.length>1&&g.debug("All relay destinations have not responded"),g.debug("Found cached relay with msgId="+f.getId()+" key="+d),l>=m&&(g.debug("relayMessage.retryCount="+f.retryCount),g.debug("                retries="+n),f.retryCount>=n?(g.debug("Relay: relay message has timed out after "+f.retryCount+" reattempt(s): id="+f.getId()),f.timeoutHandler&&f.timeoutHandler(k,f.retryCount,f),this.timeoutHandler&&this.timeoutHandler(k,f.retryCount,f),f.resetCount(),g.debug("Removing Relay Message "+d+" from cache"),this.relayMessages.remove(d)):(g.debug("Relay: About to retry sending timed out message. Calling retry handlers..."),f.retryHandler&&f.retryHandler(k,f.retryCount,f),this.retryHandler&&this.retryHandler(k,f.retryCount,f),g.debug("relay: re-sending timed out relay message: id="+f.getId()+", reattempts="+f.retryCount),this.send(f)))}},this),e<=0&&(g.debug("Relay.handleIntervalTimeout no messages being tracked. Stopping interval timer"),clearInterval(this.timer),this.timer=null)}},createCommand:function(a,b){return this.createRelayRequest().withCommand(a,b)},createText:function(a,b){return this.createRelayRequest().withText(a,b)},createData:function(a,b){return this.createRelayRequest().withData(a,b)},close:function(){var a=this.createRelayRequest().asFinalMessage();this.send(a)},respond:function(a){var b=this.createSubsequentRelayResponse(a);this.send(b)},processSubsequentResponse:function(a){g.debug("Relay "+this.getId()+" processing subsequent response...");var b=a.header.relay.msgId,c=a.header.relay.from;g.debug("  msgId = "+b);var d=this.getRelayMessageForId(b),e=[],f=1;if(d){d.gotRelayResponses&&(e=Object.keys(d.gotRelayResponses),f=e.length,g.debug("Message was sent to "+f+" destinations")),d.receivedResponseFrom(c);var h=0;if(f>1)for(var i=0;i<e.length;i++){var j=e[i];g.debug("processSubsequentResponse: gotRelayResponses["+j+"] is set to '"+d.gotRelayResponses[j]+"'"),d.gotRelayResponses[j]&&h++}1===f||h===f?(g.debug("Got all expected responses"),d.gotAllResponses=!0):g.debug("Number of destinations="+f+", number of responses received="+h)}},processFinalResponse:function(a){g.debug("Relay "+this.getId()+" processing final response...");var b=a.header.relay.msgId,c=a.header.relay.from,d=a.header.relay.messages[0].commands[0];null===d&&(d=a.header.relay.messages[0].text[0]),null===d&&(d=a.header.relay.messages[0].data[0]),g.debug("  msgId = "+b);var e=this.getRelayMessageForId(b),f=[],h=1;if(e){e.gotRelayResponses&&(f=Object.keys(e.gotRelayResponses),h=f.length,g.debug("Message was sent to "+h+" destinations")),e.receivedResponseFrom(c),e.responseHandler&&(g.debug("  Calling user defined RelayMessage.responseHandler"),e.responseHandler(d)),this.responseHandler&&(g.debug("  Calling user defined Relay.responseHandler"),this.responseHandler(d));var i=0;if(h>1)for(var j=0;j<f.length;j++){var k=f[j];g.debug("processFinalResponse: gotRelayResponses["+k+"] is set to '"+e.gotRelayResponses[k]+"'"),e.gotRelayResponses[k]&&i++}g.debug("Number of destinations="+h+", number of responses received="+i),1!==h&&i!==h||(g.debug("  Removing msgId entry from relayMessages request cache"),this.relayMessages.remove(b))}},processError:function(a){g.debug("Relay "+this.getId()+" processing error...");var b=a.header.relay.msgId,c=a.header.relay.from,d=a.header.relay.messages[0].commands[0];null===d&&(d=a.header.relay.messages[0].text[0]),null===d&&(d=a.header.relay.messages[0].data[0]),!d.reason&&a.header.reason&&(d.reason=a.header.reason),a.header.error_code&&(d.error_code=a.header.error_code),g.debug("  msgId = "+b);var e=this.getRelayMessageForId(b),f=[],h=1;if(e){e.gotRelayResponses&&(f=Object.keys(e.gotRelayResponses),h=f.length,g.debug("Message was sent to "+h+" destinations")),e.receivedResponseFrom(c),e.errorHandler&&(g.debug("  Calling user defined RelayMessage.errorHandler with: "+JSON.stringify(d,null,2)),e.errorHandler(d)),this.errorHandler&&(g.debug("  Calling user defined Relay.errorHandler with: "+JSON.stringify(d,null,2)),this.errorHandler(d));var i=0;if(h>1)for(var j=0;j<f.length;j++){var k=f[j];g.debug("processError: gotRelayResponses["+k+"] is set to '"+e.gotRelayResponses[k]+"'"),e.gotRelayResponses[k]&&i++}g.debug("Number of destinations="+h+", number of responses received="+i),1!==h&&i!==h||(g.debug("  Removing msgId entry from relayMessages request cache"),this.relayMessages.remove(b))}}};var s=function(a,b,c){this.relay=a,this.messageId=c,this.responseHandler=null,this.retryHandler=null,this.timeoutHandler=null,this.errorHandler=null,this.retries=null,this.retryCount=null,this.timeout=null,this.final=!1,this.relayDestinations=[],this.gotRelayResponses=null,this.gotAllResponses=!1,this.timestamp=Date.now(),void 0!==b?this.messageType=b:this.messageType=d.TYPE.REQUEST,this.message=null,this.text=null,this.data=null,this.commands=null};s.prototype={toJSON:function(){return{messageId:this.messageId,responseHandler:this.responseHandler,retryHandler:this.retryHandler,timeoutHandler:this.timeoutHandler,errorHandler:this.errorHandler,retries:this.retries,retryCount:this.retryCount,timeout:this.timeout,final:this.final,relayDestinations:this.relayDestinations,gotRelayResponses:this.gotRelayResponses,gotAllResponses:this.gotAllResponses,timestamp:this.timestamp,messageType:this.messageType,message:this.message,text:this.text,data:this.data,commands:this.commands}},withCallbacks:function(a,b){return g.debug("RelayMessage.withCallbacks: responseHandler="+a),this.responseHandler=a,this.errorHandler=b,this},withTimeout:function(a,b){return b&&(this.timeoutHandler=b),this.timeout=a,this},withRetries:function(a,b){return b&&(this.retryHandler=b),this.retries=a,this},buildMessage:function(a){if(null===this.gotRelayResponses&&(this.relayDestinations=h.determineRelayDestinations(this.getRelay().getConversation(),this.getRelay().getDestination()),this.isRequest())){this.gotRelayResponses={};for(var b=0;b<this.relayDestinations.length;b++){var c=this.relayDestinations[b].uri;this.gotRelayResponses[c]=!1}}null===this.message&&(this.message=h.buildReliableRelayMsg(this,a))},receivedResponseFrom:function(a){g.debug("receivedResponseFrom "+a),a in this.gotRelayResponses&&(g.debug("Marking tracked destination "+a+" as responded"),this.gotRelayResponses[a]=!0)},getConversation:function(){return this.relay.getConversation()},getRelay:function(){return this.relay},getId:function(){return this.messageId},getMessageType:function(){return this.messageType},isRequest:function(){return this.messageType===d.TYPE.REQUEST},isResponse:function(){return this.messageType===d.TYPE.RESPONSE},isError:function(){return this.messageType===d.TYPE.ERROR},isMessage:function(){return this.messageType===d.TYPE.MESSAGE},asFinalMessage:function(){return this.final=!0,this},isFinalMessage:function(){return this.final},getMessage:function(a){return this.buildMessage(a),this.message},resetCount:function(){this.retryCount=null},withText:function(a,b){return g.debug("text relay on thread: "+a+" with content: "+b),this.text||(this.text=[]),this.text.push({thread:a,content:b}),g.debug("total text messages = "+this.text.length),this},withData:function(a,b){return g.debug("data relay for tag: "+a),this.data||(this.data=[]),this.data.push({tag:a,content:b}),g.debug("total data messages = "+this.data.length),this},withCommand:function(a,b){return g.debug("command relay with directive: "+a),this.commands||(this.commands=[]),this.commands.push({directive:a,arguments:[].concat(b)}),g.debug("total command messages = "+this.commands.length),this},withMessage:function(a){return this.message=a.getMessage(!0),this},updateTimestamp:function(){this.timestamp=Date.now()},getTimestamp:function(){return this.timestamp},send:function(){this.relay.send(this)},end:function(){g.debug("Removing message id "+this.messageId+" from relay"),this.relay.relayMessages.remove(this.messageId)}};var t=function(a,b,c,d,e){this.relay=a,this.command=b,this.isRequest=c,this.relayMsgId=d,this.relayFrom=e};t.prototype={from:function(){return this.relayFrom},accept:function(a){this.isRequest&&this.relay&&(g.debug("Accepting relay request from: "+this.relayFrom+", for: "+this.command),this.relay.createFinalRelayResponse(this.relayMsgId).withCommand(this.command,[{status:d.RELAYSTATUS.ACCEPTED,info:a}]).send())},decline:function(a){if(this.isRequest&&this.relay){var b=a;b||(b=d.RELAYSTATUS.DECLINED),g.debug("Declining relay request from: "+this.relayFrom+", for: "+this.command),this.relay.createRelayError(this.relayMsgId).withCommand(this.command,[{status:d.RELAYSTATUS.DECLINED,reason:b}]).send()}}};var u=function(a){this.factorMonitors={},this.streamInfo=a,this.onNewInboundFrameRate=null,this.onNewOutboundFrameRate=null,this.onNewInboundResolution=null,this.onNewOutboundResolution=null,this.__audioOutboundRttThreshold=500,this.__videoOutboundRttThreshold=500,this.__videoPacketLossRateThreshold=.3,this.__audioPacketLossRateThreshold=.3,this.__frameRateThreshold=5,this.__jitterThreshold=500,this.__keepCount=3,this.__audioPacketsLostKeepLimit=7,this.__videoPacketsLostKeepLimit=3};return u.prototype={onNewStatus:function(a,b){var c=!1;for(var e in d.ExperienceFactor)if(d.ExperienceFactor.hasOwnProperty(e)&&d.ExperienceFactor[e]===a){this.factorMonitors[a]=b,c=!0;break}c||g.warn("The given factor: "+a+" is not valid.")},withCallbacks:function(a,b,c,d){return this.onNewInboundFrameRate=a,this.onNewOutboundFrameRate=b,this.onNewInboundResolution=c,this.onNewOutboundResolution=d,this},getStreamInfo:function(){return this.streamInfo}},h.isPauseResume=function(a,b){var c=a.shouldSendVideo(),d=b.shouldSendVideo(),e=a.shouldReceiveVideo(),f=b.shouldReceiveVideo(),h=a.shouldSendAudio(),i=b.shouldSendAudio(),j=b.isPaused();return g.debug("isPauseResume: isPaused="+j+", oldAudio="+h+", oldVideo="+c+", oldVideoRecv="+e+", newAudio="+i+", newVideo="+d+", newVideoRecv="+f),!!j||h===i&&c===d&&e===f},h.enableDisableTracks=function(a,b){var c=b.audio===d.PAUSERESUME.PAUSE,e=b.video===d.PAUSERESUME.PAUSE;g.debug((c?"Disable":"Enable")+" audio tracks for stream: "+a.getId()),g.debug((e?"Disable":"Enable")+" video tracks for stream: "+a.getId()),a.paused=b,a.getLocalStreams().map(function(a){a.getAudioTracks().map(function(a){a.enabled=!c}),a.getVideoTracks().map(function(a){a.enabled=!e})})},h.pauseResumeLocalAVStream=function(a,b){h.enableDisableTracks(a,b);var c=a.conversation.getLocalParticipantUri();b.pausedBy&&(c=b.pausedBy,b.pausedBy=null),a.streamInfo.streamProfile.updateForPauseResume(b,c),h.sendProfileUpdate(a.conversation,a.streamInfo)},h.relayStreamEvent=function(a,b,c){var d=a.conversation.getRelayForDestUrl("*");null===d&&(d=a.conversation.createRelay(a.getId(),"*")),d.createRelayMessage().withCommand(b,c).send()},h.handleParticipantChange=function(b,c,e,f,h){g.debug("handleParticipantChange: uri="+e+", change="+c,f);var i,j,k,l=!1,m=d.CONVERSATIONSTATE.STREAM_CHANGED;switch(c){case d.CONVERSATION.ADD_STREAM:if(b.__participantsHistory.indexOf(e)<0&&b.__participantsHistory.push(e),i=b.getParticipant(e),i||(l=!0,i=b.localAddParticipant(e)),f&&f.length>0)for(g.debug("Adding streams: "+JSON.stringify(f,null,2)),j=0;j<f.length;j++)f[j].stream_id&&(k=i.getStreamInfo(f[j].stream_id),k||(m=d.CONVERSATIONSTATE.STREAM_ADDED,k=i.localAddStreamInfo(f[j].stream_id,f[j].stream_type,f[j].stream_options,f[j].stream_profile)),k&&("undefined"!=typeof f[j].stream_options&&k.localSetStreamOptions(f[j].stream_options),"undefined"!=typeof f[j].stream_profile&&k.localSetStreamProfile(f[j].stream_profile),"undefined"!=typeof f[j].size&&k.localSetStreamLayout(f[j].size),"undefined"!=typeof f[j].recording_status&&k.localSetRecording(f[j].recording_status),i.onParticipantStateChange&&!l&&(g.debug("Invoking onParticipantStateChange callback for change: "+m),i.onParticipantStateChange(m,k))));b.onParticipantChange&&l&&(g.debug("Invoking onParticipantChange callback for change: "+d.CONVERSATIONSTATE.STREAM_ADDED),b.onParticipantChange(b,d.CONVERSATIONSTATE.STREAM_ADDED,i));break;case d.CONVERSATION.REMOVE_STREAM:i=b.getParticipant(e);var o=0;if(i&&f&&f.length>0)for(g.debug("Removing streams: "+JSON.stringify(f,null,2)),j=0;j<f.length;j++)f[j].stream_id&&(g.debug("Removing stream ("+f[j].stream_id+") from participant: "+JSON.stringify(i,null,2)),k=i.getStreamInfo(f[j].stream_id),k||(k=new n(i,f[j].stream_id,f[j].stream_type,f[j].stream_options,f[j].stream_profile)),o=i.localRemoveStreamInfo(f[j].stream_id),i.onParticipantStateChange&&(g.debug("Invoking onParticipantStateChange callback for change: "+d.CONVERSATIONSTATE.STREAM_REMOVED),i.onParticipantStateChange(d.CONVERSATIONSTATE.STREAM_REMOVED,k)));if(o<=0&&(b.localRemoveParticipant(e),b.onParticipantChange)){i||(i=new a.Participant(b,e));var p=d.CONVERSATIONSTATE.STREAM_REMOVED;h&&(p=d.CONVERSATIONSTATE.STREAM_REJECTED),g.debug("Invoking onParticipantChange callback for change: "+p),b.onParticipantChange(b,p,i)}break;case d.CONVERSATION.STREAM_OPTIONS:case d.CONVERSATIONSTATE.STREAM_JOINED:case d.CONVERSATIONSTATE.STREAM_CHANGED:case d.CONVERSATIONSTATE.STREAM_ACTIVE:case d.CONVERSATIONSTATE.PROFILE_UPDATED:case d.CONVERSATIONSTATE.SIDEBAR_CREATED:if(c===d.CONVERSATIONSTATE.SIDEBAR_CREATED&&(g.debug("Sidebar created - disable short-circuit mode"),b.shortCircuitMode=!1),i=b.getParticipant(e),i&&f&&f.length>0)for(g.debug("Updating streams: "+JSON.stringify(f,null,2)),j=0;j<f.length;j++)f[j].stream_id&&(k=i.getStreamInfo(f[j].stream_id),!k&&i.notRemovedStream(f[j].stream_id)&&(k=i.localAddStreamInfo(f[j].stream_id,f[j].stream_type,f[j].stream_options,f[j].stream_profile)),k&&("undefined"!=typeof f[j].stream_options&&k.localSetStreamOptions(f[j].stream_options),"undefined"!=typeof f[j].stream_profile&&k.localSetStreamProfile(f[j].stream_profile),"undefined"!=typeof f[j].size&&k.localSetStreamLayout(f[j].size),"undefined"!=typeof f[j].recording_status&&k.localSetRecording(f[j].recording_status),c===d.CONVERSATIONSTATE.STREAM_ACTIVE&&(k.streamType=f[j].stream_type,g.debug("Stream "+k.getId()+" is active (updating type to: "+k.getType()+")"),k.localSetActive(!0)),i.onParticipantStateChange&&(c===d.CONVERSATION.STREAM_OPTIONS?(g.debug("Invoking onParticipantStateChange callback for change: "+d.CONVERSATIONSTATE.STREAM_CHANGED,k),i.onParticipantStateChange(d.CONVERSATIONSTATE.STREAM_CHANGED,k)):(g.debug("Invoking onParticipantStateChange callback for change: "+c,k),i.onParticipantStateChange(c,k)))));else console.log("Failed to process instruction - no participant found for: "+e)}},h.doRequest=function(a,b){function c(){var b,c;for(r=0;r<q.length;r++)switch(g.debug("Conversation modify request with instruction: "+q[r].instruction_name),q[r].instruction_name){case d.CONVERSATION.ADD_STREAM:if(q[r].participants)for(g.debug("Conversation modify request with participants: "+q[r].participants),b=[].concat(q[r].participants),c=0;c<b.length;c++)h.handleParticipantChange(a,q[r].instruction_name,b[c].uri,b[r].streams);break;case d.CONVERSATION.REMOVE_STREAM:if(q[r].participants)for(g.debug("Conversation modify request with participants: "+q[r].participants),b=[].concat(q[r].participants),c=0;c<b.length;c++)h.handleParticipantChange(a,q[r].instruction_name,b[c].uri,b[r].streams);break;case d.CONVERSATION.BEGIN_RECORD:a.onRecordingStatusChange&&a.onRecordingStatusChange(a,!0);break;case d.CONVERSATION.END_RECORD:a.onRecordingStatusChange&&a.onRecordingStatusChange(a,!1)}}var e=b.header,f=e.action,i=e.conversation_key,j=e.conversation_topic,k=e.instructions,l=e.conversation_info,m=e.stream_id,n=e.sidebar,o=e.allow_direct_calls,p=null,q=[],r=0;switch(g.debug("Have conversation request with action: "+f),k&&(q=[].concat(k),g.debug("Have conversation instructions: "+JSON.stringify(q,null,2))),m?(g.debug("Have conversation request for stream: "+m),p=a.getStreamForId(m),p||(p=a.getAudioVideoStream())):p=a.getAudioVideoStream(),f){case d.ACTION.START:for(g.debug("Conversation start request with conversation key: "+i),a.conversationKey=i,j&&(g.debug("Have conversation name: "+j),a.conversationTopic=j),"undefined"!=typeof o&&g.debug("Have short-circuit mode: "+o),o&&a.withShortCircuit(),n&&(g.debug("Have sidebar: "+n),a.sidebarId=n),r=0;r<q.length;r++)if(q[r].participants){g.debug("Conversation start request with participants: "+q[r].participants);for(var s=[].concat(q[r].participants),t=0;t<s.length;t++)h.handleParticipantChange(a,d.CONVERSATION.ADD_STREAM,s[t].uri,s[r].streams)}l&&h.processConversationInfo(a,l),g.debug("Conversation has "+a.getParticipants().length+" participants (including initiator)"),p.call.onMessage(b);break;case d.ACTION.MODIFY:q.length>0&&c();break;default:p.call.onMessage(b)}},h.doResponse=function(a,b){var c=b.header,e=c.action,f=c.conversation_key,i=c.conversation_topic,j=c.response_code,k=b.control.message_state,l=c.conversation_info,m=c.enquiry_data,n=c.stream_id,o=c.allow_direct_calls,p=c.sidebar,q=null;switch(g.debug("Have conversation response with action: "+e+" and code: "+j),n?(g.debug("Have conversation response for stream: "+n),q=a.getStreamForId(n),q||(q=a.getAudioVideoStream())):q=a.getAudioVideoStream(),e){case d.ACTION.START:g.debug("Conversation start response with conversation key: "+f),!a.conversationKey&&f&&(a.conversationKey=f),i&&(g.debug("Have conversation name: "+i),a.conversationTopic=i),"undefined"!=typeof o&&g.debug("Have short-circuit mode: "+o),o&&a.withShortCircuit(),p&&(g.debug("Have sidebar: "+p),a.sidebarId=p),q.call.onMessage(b);var r=200===j&&"final"===k;l?h.processConversationInfo(a,l):r&&h.sendConversationEnquiry(a);break;case d.ACTION.ENQUIRY:g.debug("Conversation enquiry response with conversation key: "+f),!a.conversationKey&&f&&(a.conversationKey=f),l||m?(h.processConversationInfo(a,l),h.processEnquiryResponse(a,m)):q.call.onMessage(b);break;case d.ACTION.MODIFY:g.info("Received modify response with code: "+j);break;default:q.call.onMessage(b)}},h.processConversationInfo=function(a,b){if(b){if(g.debug("Have some conversation info: "+JSON.stringify(b,null,2)),b.participants&&b.participants.length>0){var c=[].concat(b.participants);g.debug("Have some participants: "+JSON.stringify(c,null,2));for(var e=0;e<c.length;e++){var f=c[e].uri,i=c[e].streams;h.handleParticipantChange(a,d.CONVERSATION.ADD_STREAM,f,i)}}b.recording_status&&(a.localSetRecording(b.recording_status),a.onRecordingStatusChange&&a.onRecordingStatusChange(a,a.isRecording())),b.web_context&&!a.webContext&&(g.debug("Have some web context information: "+JSON.stringify(b.web_context)),a.webContext=b.web_context)}},h.processEnquiryResponse=function(a,b){if(b){var c=JSON.parse(b);g.debug("Received some enquiry data: "+JSON.stringify(c,null,2)),a.defaultEnquiryResponse(c),a.onEnquiryResponse&&(g.debug("Invoking conversation.onEnquiryResponse",a),a.onEnquiryResponse(c)),h.sendDelayedStartRequests(a)}},h.processInstructions=function(a,b,c){var e,f,i,j=[];for(e=0;e<b.length;e++){g.debug("Processing conversation instruction: "+b[e].instruction_name);var k,l=null;switch(b[e].instruction_name){case d.CONVERSATION.ADD_STREAM:case d.CONVERSATIONSTATE.STREAM_ADDED:case d.CONVERSATIONSTATE.STREAM_STARTED:if(c)for(j=[].concat(c),g.debug("Adding participants to conversation: "+JSON.stringify(j,null,2)),f=0;f<j.length;f++)i=j[f].streams,i||(i=[{stream_id:j[f].stream_id,stream_type:j[f].stream_type,stream_options:j[f].stream_options,recording_status:j[f].recording_status}]),h.handleParticipantChange(a,d.CONVERSATION.ADD_STREAM,j[f].uri,i);break;case d.CONVERSATION.REMOVE_STREAM:case d.CONVERSATIONSTATE.STREAM_REMOVED:case d.CONVERSATIONSTATE.STREAM_LEFT:case d.CONVERSATIONSTATE.STREAM_REJECTED:if(c)for(j=[].concat(c),g.debug("Removing participants from conversation: "+JSON.stringify(j,null,2)),f=0;f<j.length;f++)i=j[f].streams,i&&(i=i.filter(function(a){return a.stream_id===j[f].stream_id})),k&&0!==i.length||(i=[{stream_id:j[f].stream_id,stream_type:j[f].stream_type}]),h.handleParticipantChange(a,d.CONVERSATION.REMOVE_STREAM,j[f].uri,i,b[e].instruction_name===d.CONVERSATIONSTATE.STREAM_REJECTED);break;case d.CONVERSATION.BEGIN_RECORD:case d.CONVERSATIONSTATE.RECORDING_STARTED:if(c)if(j=[].concat(c),j.length>0&&"*"!==j[0].uri)for(f=0;f<j.length;f++)l=a.getParticipant(j[f].uri),l?(k=l.getStreamInfo(j[f].stream_id),k?(k.localSetRecording(!0),l.onParticipantStateChange&&l.onParticipantStateChange(d.CONVERSATIONSTATE.RECORDING_STARTED,k)):console.log("Failed to process instruction - no stream with id: "+j[f].stream_id+" found for participant: "+j[f].uri)):console.log("Failed to process instruction - no participant found for: "+j[f].uri);else a.localSetRecording(!0),a.onRecordingStatusChange&&a.onRecordingStatusChange(a,!0);break;case d.CONVERSATION.END_RECORD:case d.CONVERSATIONSTATE.RECORDING_ENDED:if(a.localSetRecording(!1),c)if(j=[].concat(c),j.length>0&&"*"!==j[0].uri)for(f=0;f<j.length;f++)l=a.getParticipant(j[f].uri),l?(k=l.getStreamInfo(j[f].stream_id),k?(k.localSetRecording(!1),l.onParticipantStateChange&&(g.debug("Invoking onParticipantStateChange callback for change: "+d.CONVERSATIONSTATE.RECORDING_ENDED),l.onParticipantStateChange(d.CONVERSATIONSTATE.RECORDING_ENDED,k))):console.log("Failed to process instruction - no stream with id: "+j[f].stream_id+" found for participant: "+j[f].uri)):console.log("Failed to process instruction - no participant found for: "+j[f].uri);else a.onRecordingStatusChange&&a.onRecordingStatusChange(a,!1);break;case d.CONVERSATION.STREAM_OPTIONS:case d.CONVERSATIONSTATE.STREAM_JOINED:case d.CONVERSATIONSTATE.STREAM_CHANGED:case d.CONVERSATIONSTATE.PROFILE_UPDATED:case d.CONVERSATIONSTATE.SIDEBAR_CREATED:if(c)for(j=[].concat(c),g.debug("Updating participants in conversation: "+JSON.stringify(j,null,2)),f=0;f<j.length;f++)i=j[f].streams,i||(i=[{stream_id:j[f].stream_id,stream_type:j[f].stream_type,stream_options:j[f].stream_options,recording_status:j[f].recording_status}]),h.handleParticipantChange(a,b[e].instruction_name,j[f].uri,i);break;case d.CONVERSATIONSTATE.STREAM_ACTIVE:if(c)for(j=[].concat(c),g.debug("Processing participants in conversation: "+JSON.stringify(j,null,2)),f=0;f<j.length;f++)i=[{stream_id:j[f].stream_id,stream_type:j[f].stream_type}],h.handleParticipantChange(a,b[e].instruction_name,j[f].uri,i);break;default:g.info("Unknown conversation instruction: "+b[e].instruction_name)}}},h.doMessage=function(b,c){function e(a){if(!a)return g.debug("Failed to process shutdown for invalid AV stream - ending conversation"),void b.end();var e=a.getStreamState().state;if(g.debug("Processing shutdown for conversation with "+b.streams.size()+" streams, AV stream to shutdown has id: "+a.getId()+", type:"+a.getType()+", state: "+e),b.streams.size()>1)switch(e){case d.CALLSTATE.ESTABLISHED:case d.CALLSTATE.UPDATED:case d.CALLSTATE.UPDATE_FAILED:case d.CALLSTATE.ERROR:g.debug("=== (conversation) doShutdownMessage ==="),a.call.setCallState(d.CALLSTATE.ENDED,"","shutdown");try{f.clearPeerConnection(a.call),a.call.peerConnection=null}catch(a){g.error("clear peer connection error: "+a)}for(var h=a.call.localMediaStreams,i=0;i<h.length;i++){var j=h[i];g.debug("Media stream "+i+": used by "+j.peerConnectionNum+" peer connections."),j&&(null===j.peerConnectionNum||j.peerConnectionNum<=0)&&(g.debug("Stop this media stream: [video tracks: "+j.getVideoTracks().length+", audio tracks: "+j.getAudioTracks().length+"]"),j.getTracks().forEach(function(a){a.stop()}))}b.streams.remove(a.getId());var k=b.getLocalParticipant();k&&(g.debug("Remove stream from local participants: "+a.getId()),k.localRemoveStreamInfo(a.getId())),0===b.streams.size()&&b.remove();break;default:a.call.onMessage(c)}else a.call.onMessage(c)}function i(b,c,e,f){var i=e.header,j=i.relay,k=j.from,l=j.msgId,m=j.relayId,o=i.stream_id,p=b.getRelayForId(m);g.debug("Processing Relay: Relay message from "+k,f);var q=f.commands;if(q){var r=[].concat(q);r.length>0&&g.debug("Have relay command message: "+JSON.stringify(r,null,2)),r.forEach(function(f){g.debug("Processing relay command: "+JSON.stringify(f,null,2));var i,j,m,o=f.directive,q=new a.StreamRequest(p,o,e.isRequest(),l,k),r=[].concat(f.arguments);switch(o){case d.CONVERSATION.STREAM_OPTIONS:var s=n.createStreamOptions(r[0].audio,r[0].video);g.debug("Request to modify media direction: "+JSON.stringify(s,null,2)),c.onUpdateStreamOptions?(g.debug("Calling onUpdateStreamOptions callback with arguments: options="+JSON.stringify(s,null,2)+", streamRequest="+JSON.stringify(q,null,2)),c.onUpdateStreamOptions(b,c,q,s)):q.decline("Not implemented");break;case d.CONVERSATION.PAUSE_RESUME_STREAM:i=r[0],i.pausedBy=q.from(),g.debug((i?"Pausing":"Resuming")+" local AV stream"),c.onPauseResumeStream?(g.debug("Calling onPauseResumeStream callback with arguments: paused="+JSON.stringify(i,null,2)+", streamRequest="+JSON.stringify(q,null,2)),c.onPauseResumeStream(b,c,q,i)):q.decline("Not implemented");break;case d.CONVERSATIONSTATE.STREAM_ACTIVE:m=r[0],h.handleParticipantChange(b,d.CONVERSATIONSTATE.STREAM_ACTIVE,m.uri,m.streams);break;case d.CONVERSATION.ADD_STREAM:m=b.getLocalParticipant(),j=r[0],g.debug("Adding "+j.stream_type+" stream to local participant with options: "+j.stream_options),m.onAddStream?(g.debug("Calling onAddStream callback with arguments: type="+j.stream_type+", options="+j.stream_options+", from="+k),m.onAddStream(b,m,q,j.stream_type,j.stream_options)):q.decline("Not implemented");break;case d.CONVERSATION.REMOTE_ADD_STREAM:j=r[0],m=b.getParticipant(k),m?(g.debug("Request to add "+j.stream_type+" stream to remote participant ("+k+") with options: "+j.stream_options),m.onAddRemoteStream?(g.debug("Calling onAddRemoteStream callback with arguments: type="+j.stream_type+", options="+j.stream_options+", from="+k),m.onAddRemoteStream(b,m,q,j.stream_type,j.stream_options)):q.decline("Not implemented")):(g.debug("No remote participant - cannot handle 'remote add stream' request"),q.decline("No remote participant"));break;default:g.debug("Unknown relay command directive: "+o),b.onRelayCommand&&b.onRelayCommand(b,c,q,o,r)}})}var s=f.text;if(s){var t=[].concat(s);t.length>0&&g.debug("Have relay text message: "+JSON.stringify(t,null,2)),t.forEach(function(a){g.debug("Processing relay text: "+a);var c=a.thread,d=a.content;b.onRelayText&&b.onRelayText(b,k,c,d)})}var u=f.data;if(u){var v=[].concat(u);v.length>0&&g.debug("Have relay data message: "+JSON.stringify(v,null,2)),v.forEach(function(a){g.debug("Processing relay data: "+a);var c=a.tag,d=a.content;if(0===c.indexOf("__wsc_internal_")){if("__wsc_internal_quality_monitor_new_status__"===c){var e=b.getParticipant(k),f=e.getStreamInfo(o);if(f){var h=f.getQualityMonitor();for(var i in d)if(d.hasOwnProperty(i)){var j=h.factorMonitors[i];"function"==typeof j&&j.call(h,d[i].value,d[i].hints)}}}}else b.onRelayData&&b.onRelayData(b,k,c,d)})}}var j=c.header,k=j.action,l=j.conversation_key,m=j.conversation_topic,o=j.conversation_info,p=j.participant,q=j.event,r=j.relay,s=j.stream_id,t=j.stream_type,u=j.sidebar,v=null,w=[],x=[];switch(g.debug("Have conversation message with action: "+k),s?(g.debug("Have conversation message for stream: "+s+" (type: "+t+")"),v=b.getStreamForId(s),v||(v=b.getAudioVideoStream())):v=b.getAudioVideoStream(),j.instructions&&(x=[].concat(j.instructions)),j.instruction_name&&(x=[].concat({instruction_name:j.instruction_name})),q&&q.event_name&&(x=[].concat({instruction_name:q.event_name})),x&&x.length>0&&g.debug("Have conversation instructions: "+JSON.stringify(x,null,2)),q&&q.participants&&(g.debug("Have event participants: "+JSON.stringify(q.participants,null,2)),w=[].concat(q.participants)),p&&(g.debug("Have target participant: "+p+", stream: "+s+"/"+t),w=[].concat({uri:p,stream_id:s,stream_type:t})),k){case d.ACTION.COMPLETE:null===b.conversationKey&&null!==l?b.conversationKey=l:null!==b.conversationKey&&(l=b.conversationKey),g.debug("Conversation complete message with key: "+l),m&&(g.debug("Have conversation name: "+m),b.conversationTopic=m),u&&(g.debug("Have sidebar: "+u),b.sidebarId=u);for(var y=0;y<x.length;y++)switch(g.debug("Conversation message with instruction: "+x[y].instruction_name),x[y].instruction_name){case d.CONVERSATION.BEGIN_RECORD:case d.CONVERSATIONSTATE.RECORDING_STARTED:b.localSetRecording(!0),b.onRecordingStatusChange&&b.onRecordingStatusChange(b,!0)}v.call.onMessage(c),o?h.processConversationInfo(b,o):h.sendConversationEnquiry(b);break;case d.ACTION.NOTIFY:x.length>0?h.processInstructions(b,x,w):l?g.warn("Ignoring notify message with no conversation instructions"):v.call.onMessage(c);break;case d.ACTION.RELAY:var z=b.getLocalParticipantUri();r.from&&(z=r.from);var A=[].concat(r.messages);A.forEach(function(a){i(b,v,c,a)});break;case d.ACTION.SHUTDOWN:e(v);break;default:v.call.onMessage(c)}h.doReliableRelay=function(a,b){var c=b.header,d=c.relay,e=d.from,f=d.relayId;g.debug("doReliableRelay received relay message from: "+e+" (with id: "+f+")",b);var h=null,j=c.stream_id,k=c.stream_type,l=null;if(j?(g.debug("Have reliable relay message for stream: "+j+" (type: "+k+")"),h=a.getStreamForId(j),h||(h=a.getAudioVideoStream())):h=a.getAudioVideoStream(),b.isFinalResponse())return g.debug("Processing reliable relay final response..."),l=a.getRelayForId(f),void(l&&l.processFinalResponse(b));if(b.isResponse())return g.debug("Processing reliable relay subsequent response..."),l=a.getRelayForId(f),void(l&&l.processSubsequentResponse(b));if(b.isError())return g.debug("Processing reliable relay error..."),l=a.getRelayForId(f),void(l&&l.processError(b));b.isRequest()&&(g.debug("Attempting to respond to reliable relay request..."),l=a.getRelayForId(f),void 0!==l&&null!==l||(g.debug("Creating new relay to respond to new incoming message"),l=a.createRelay(h.getId(),e,f)),g.debug("Responding to request message:"),l.respond(b)),g.debug("Iterating over relay messages...");var m=[].concat(d.messages);m.forEach(function(c){i(a,h,b,c)})}},h.doError=function(a,b){function c(){for(g.debug("=== doErrorMessage ==="),b.ack(a.session),q=0;q<p.length;q++){g.debug("Conversation error with instruction: "+p[q].instruction_name);var c,i=null;switch(p[q].instruction_name){case d.CONVERSATION.ADD_STREAM:m&&h.handleParticipantChange(a,d.CONVERSATION.REMOVE_STREAM,m,null);break;case d.CONVERSATION.REMOVE_STREAM:if(a.lastRemovedParticipant&&a.lastRemovedParticipant.uri===m){var j=a.lastRemovedParticipant.streams;h.handleParticipantChange(a,d.CONVERSATION.ADD_STREAM,m,j)}break;case d.CONVERSATION.BEGIN_RECORD:m&&"*"!==m?(f=a.getParticipant(m),f&&(c=f.getStreamInfo(n),c.localSetRecording(!1),f.onParticipantStateChange&&f.onParticipantStateChange(d.CONVERSATIONSTATE.RECORDING_ENDED,c))):(a.localSetRecording(!1),a.onRecordingStatusChange&&a.onRecordingStatusChange(a,!1)),i=d.CONVERSATION.END_RECORD;break;case d.CONVERSATION.END_RECORD:m&&"*"!==m?(f=a.getParticipant(m),f&&(c=f.getStreamInfo(n),c.localSetRecording(!0),f.onParticipantStateChange&&(g.debug("Invoking onParticipantStateChange callback for change: "+d.CONVERSATIONSTATE.RECORDING_STARTED),f.onParticipantStateChange(d.CONVERSATIONSTATE.RECORDING_STARTED,c)))):(a.localSetRecording(!0),
a.onRecordingStatusChange&&a.onRecordingStatusChange(a,!0))}}var o=new e.ErrorInfo(k,l);try{a.onError(o)}catch(a){g.error("Exception occurred while invoking onError callback: "+a)}}var f,i=b.header,j=i.action,k=i.error_code,l=i.reason,m=String(i.participant),n=i.stream_id,o=null,p=[],q=0;if(g.warn("Have conversation error with action: "+j+", code: "+k+" and reason: "+l),n)if(g.debug("Have conversation error for stream: "+n),o=a.getStreamForId(n)){o&&o.call&&o.call.collectClientLog(d.LOGTYPE.ERROR_LOG,d.ERRORLOG.ERROR_FROM_SERVER+":"+JSON.stringify(b));var r=o.call&&o.call.onCallError;if(r){var s=new e.ErrorInfo(d.ERRORCODE.SIGNALING_ERROR,k+"/"+l);r(s)}}else o=a.getAudioVideoStream();else o=a.getAudioVideoStream();switch(i.instructions&&(p=[].concat(i.instructions)),i.instruction_name&&(p=[].concat({instruction_name:i.instruction_name})),p&&p.length>0&&g.debug("Have conversation instructions: "+JSON.stringify(p,null,2)),m&&g.debug("Have target participant: "+m),j){case d.ACTION.START:o?o.call.onMessage(b):(g.error("Failed to forward error message to stream"),c());break;default:c()}},h.retrieveRecordingRules=function(a){return a.joiningConversation?(g.debug("Joining conversation, not retrieving recording rules"),!1):(g.info("Begin to retrieve recording rules",a),h.sendConversationEnquiry(a),!0)},h.sendDelayedStartRequests=function(a){for(g.debug("Sending "+a.pendingAVStreams.length+" delayed start requests");a.pendingAVStreams.length>0;){var b=a.pendingAVStreams.pop();b&&h.sendStartRequest(b)}},h.sendStartRequest=function(a){var b=a.conversation;g.debug("Starting stream with key: "+b.conversationKey);var c,e=JSON.parse("{}");a.extHeaders&&(e=a.extHeaders);var f=[];if(b.joiningConversation)g.debug("Joining conversation - not adding participants");else if(b.streams.size()<=1){var h=b.getParticipants().filter(function(a){return a.uri!==b.initiator});if(h.length>0){var i=[];for(c=0;c<h.length;c++)Array.prototype.push.apply(i,h[c].asJSONArray(a.getType()));g.debug("Adding participants to conversation: "+JSON.stringify(i,null,2)),f.push({instruction_name:d.CONVERSATION.ADD_STREAM,participants:i})}}g.info("Checking recording rules for automatic recording");var j=b.recordingRules;if(j&&b.alwaysRecordOnCreation&&!b.neverRecordOnCreation){g.info("Conversation will be recorded (with rules) "+j);var k={instruction_name:d.CONVERSATION.BEGIN_RECORD,recording_style:b.recordingStyle};if(j.participants){k.participants=[];for(var l=0;l<j.participants.length;l++)k.participants.push({uri:j.participants[l]})}j.include_associations&&(g.info("Adding associations "+j.include_associations),k.include_associations=j.include_associations),j.exclude_associations&&(g.info("Adding exclude associations "+j.exclude_associations),k.exclude_associations=j.exclude_associations),f.push(k)}else b.alwaysRecordOnCreation&&!b.neverRecordOnCreation&&(g.debug("Conversation will be recorded (without rules)"),f.push({instruction_name:d.CONVERSATION.BEGIN_RECORD,recording_style:b.recordingStyle}));if(e.instructions=f,b.conversationTopic&&(e.conversation_topic=b.conversationTopic),b.shortCircuitMode&&(e.allow_direct_calls=b.shortCircuitMode),b.conversationChannel&&(e.conversation_channel=b.conversationChannel),b.conversationKey&&(e.conversation_key=b.conversationKey),b.webContext&&(e.web_context=b.webContext),b.sidebarId&&(e.sidebar=b.sidebarId),e.stream_id&&e.stream_type){var m=a.streamId;a.streamId=e.stream_id,a.call.streamId=e.stream_id,a.call.callState.streamId=e.stream_id,a.call.streamType=e.stream_type,m!==a.streamId&&b.updateStreamId(a,m)}else e.stream_id=a.getId(),e.stream_type=a.getType();e.stream_profile=b.getLocalParticipant().getStreamInfo(e.stream_id).getStreamProfile(),g.debug("start with extHeaders: "+JSON.stringify(e,null,2)),a.call.shortCircuitMode=b.shortCircuitMode,a.call.start(a.localMediaStreams,e)},h.sendUpdateRequest=function(a,b,c,d){g.info("Begin to update stream with streamOptions: "+JSON.stringify(b),a);var e=a.conversation.getLocalParticipant().getStreamInfo(a.getId()),f=e.getStreamOptions();e.localSetStreamOptions(b),g.debug("Updating participant stream options from: "+JSON.stringify(f,null,2)+" to: "+JSON.stringify(b,null,2));var h=JSON.parse("{}");d&&(h=d),h.stream_id=a.getId(),h.stream_type=a.getType(),h.stream_options=b.asJSON(),a.conversation.conversationKey&&(h.conversation_key=a.conversation.conversationKey),a.conversation.webContext&&(h.web_context=a.conversation.webContext),a.conversation.sidebarId&&(h.sidebar=a.conversation.sidebarId),g.debug("update with extHeaders: "+JSON.stringify(h,null,2)),a.call.shortCircuitMode=a.conversation.shortCircuitMode,a.call.update(b,c,h)},h.sendAcceptResponse=function(a,b,c,d){g.info("Begin to accept request for stream with streamOptions: "+JSON.stringify(b,null,2),a);var e=a.conversation.getLocalParticipant().getStreamInfo(a.getId());e.localSetStreamOptions(b);var f=JSON.parse("{}");d&&(f=d),f.stream_id=a.getId(),f.stream_type=a.getType(),f.stream_options=b.asJSON(),g.debug("accept with extHeaders: "+JSON.stringify(f,null,2)),a.call.shortCircuitMode=a.conversation.shortCircuitMode,a.call.accept(b,c,f)},h.sendDeclineResponse=function(b,c,d){var e=b.getStreamState().state;g.info("Begin to decline request for stream in state: "+e,b);var f=JSON.parse("{}");if(d&&(f=d),f.stream_id=b.getId(),f.stream_type=b.getType(),e===a.CALLSTATE.UPDATING){var h=b.call.lastCallConfig;g.debug("accept with incoming streamOptions and extHeaders: "+JSON.stringify(f,null,2)),b.call.accept(null,null,f),setTimeout(function(){g.debug("accept with original streamOptions: "+JSON.stringify(h,null,2)+" and extHeaders: "+JSON.stringify(f,null,2)),b.update(h,null,f)},1e3)}else g.debug("decline with code: "+c+" and extHeaders: "+JSON.stringify(f,null,2)),b.call.decline(c,f),b.conversation.remove()},h.sendEndRequest=function(a,b){if(g.info("Begin to end stream",a),a.call){var c=JSON.parse("{}");b&&(c=b),a.conversation.webContext&&(c.web_context=a.conversation.webContext),a.conversation.sidebarId&&(c.sidebar=a.conversation.sidebarId),c.stream_id=a.getId(),c.stream_type=a.getType(),g.debug("end with extHeaders: "+JSON.stringify(c,null,2));var d=a.conversation.getLocalParticipant();d&&(g.debug("Remove stream from local participants: "+a.getId()),d.localRemoveStreamInfo(a.getId())),a.call.end(c),a.conversation.streams.remove(a.getId()),0===a.conversation.streams.size()&&a.conversation.remove()}},h.sendBeginRecording=function(a,b){var c=h.conversationRequest(a),e=[{instruction_name:d.CONVERSATION.BEGIN_RECORD,recording_style:a.recordingStyle}];b?(e[0].participants=[].concat({uri:b.getParticipant().getUri(),stream_id:b.getId(),stream_type:b.getType()}),c.header.stream_id=b.getId(),c.header.stream_type=b.getType()):(b=a.getAudioVideoStream(),b&&(c.header.stream_id=b.getId(),c.header.stream_type=b.getType())),c.header.instructions=e,g.debug("Sending conversation modify request to begin recording"),a.session.sendMessage(c)},h.sendEndRecording=function(a,b){var c=h.conversationRequest(a),e=[{instruction_name:d.CONVERSATION.END_RECORD}];b?(e[0].participants=[].concat({uri:b.getParticipant().getUri(),stream_id:b.getId(),stream_type:b.getType()}),c.header.stream_id=b.getId(),c.header.stream_type=b.getType()):(b=a.getAudioVideoStream(),b&&(c.header.stream_id=b.getId(),c.header.stream_type=b.getType())),c.header.instructions=e,g.debug("Sending conversation modify request to end recording"),a.session.sendMessage(c)},h.sendAddParticipant=function(a,b){var c=h.conversationRequest(a),e=[{instruction_name:d.CONVERSATION.ADD_STREAM,participants:b.asJSONArray()}];b.isRecording()&&e.push({instruction_name:d.CONVERSATION.BEGIN_RECORD,recording_style:a.recordingStyle,participants:[{uri:b.getUri()}]}),c.header.instructions=e;var f=a.getAudioVideoStream();f&&(c.header.stream_id=f.getId(),c.header.stream_type=f.getType()),g.debug("Sending conversation modify request to add participant"),a.session.sendMessage(c),a.onParticipantChange&&(g.debug("Invoking onParticipantChange callback for change: "+d.CONVERSATIONSTATE.STREAM_ADDED),a.onParticipantChange(a,d.CONVERSATIONSTATE.STREAM_ADDED,b))},h.sendRemoveParticipant=function(a,b,c){var e=h.conversationRequest(a),f=[{instruction_name:d.CONVERSATION.REMOVE_STREAM}];c?(f[0].participants=[].concat({uri:c.getParticipant().getUri(),stream_id:c.getId(),stream_type:c.getType()}),e.header.stream_id=c.getId(),e.header.stream_type=c.getType()):(f[0].participants=b.asJSONArray(),c=a.getAudioVideoStream(),c&&(e.header.stream_id=c.getId(),e.header.stream_type=c.getType())),e.header.instructions=f,g.debug("Sending conversation modify request to remove participant"),a.session.sendMessage(e)},h.sendRemoveAllParticipants=function(a){for(var b=h.conversationRequest(a),c=a.getParticipants(),e=[],f=0;f<c.length;f++)a.getLocalParticipantUri()!==c[f].getUri()&&Array.prototype.push.apply(e,c[f].asJSONArray());b.header.instructions=[{instruction_name:d.CONVERSATION.REMOVE_STREAM,participants:e},{instruction_name:d.CONVERSATION.END_RECORD}];var i=a.getAudioVideoStream();i&&(b.header.stream_id=i.getId(),b.header.stream_type=i.getType()),g.debug("Sending conversation modify request to remove all participants"),a.session.sendMessage(b)},h.sendProfileUpdate=function(a,b){var c=h.conversationRequest(a),e=[{instruction_name:d.CONVERSATION.UPDATE_PROFILE}];e[0].participants=[].concat({uri:b.getParticipant().getUri(),stream_id:b.getId(),stream_type:b.getType(),stream_profile:b.getStreamProfile()}),c.header.stream_id=b.getId(),c.header.stream_type=b.getType(),c.header.stream_profile=b.getStreamProfile(),c.header.instructions=e,g.debug("Sending conversation modify request to update profile"),a.session.sendMessage(c)},h.sendConversationEnquiry=function(a){var b=h.conversationRequest(a);b.header.action=d.ACTION.ENQUIRY,b.header.enquiry_data={},a.pendingTargetURI&&(b.header.enquiry_data.target=a.pendingTargetURI),a.conversationChannel&&(b.header.enquiry_data.channel=a.conversationChannel),a.webContext&&(b.header.enquiry_data.web_context=a.webContext);var c=a.getAudioVideoStream();c&&(b.header.stream_id=c.getId(),b.header.stream_type=c.getType()),g.debug("Sending conversation enquiry request"),a.session.sendMessage(b)},h.buildRelayMsg=function(a,b){g.debug("Building relay message for: "+JSON.stringify(b,null,2));var c=h.conversationRequest(a);c.control.type=d.TYPE.MESSAGE,c.header.action=d.ACTION.RELAY;var e;if("string"==typeof b)e="*"===b?"*":[{uri:b}];else{e=[];for(var f,i,j=[].concat(b),k=0;k<j.length;k++)j[k]&&(f=j[k].getParticipant(),i=f.getStreamInfos()[0],e.push({uri:f.getUri(),stream_id:i.getId(),stream_type:i.getType()}))}var l=a.getLocalParticipant(),m=l.getStreamInfos()[0];return c.header.relay={from:l.getUri(),messages:[{participants:e}]},c.header.stream_id=m.getId(),c.header.stream_type=m.getType(),c},h.determineRelayDestinations=function(a,b){var c,d=[];if("string"==typeof b)if("*"===b){var e=a.getParticipants();for(c=0;c<e.length;c++){var f=e[c].getUri();a.getLocalParticipantUri()!==f&&d.push({uri:f})}}else d=[{uri:b}];else{d=[];var g=[].concat(b);for(c=0;c<g.length;c++)g[c]&&d.push({uri:g[c].getParticipant().getUri(),stream_id:g[c].getId(),stream_type:g[c].getType()})}return d},h.buildReliableRelayMsg=function(a,b){var c=a.getMessageType(),e=a.getRelay(),f=a.getId(),i=a.isFinalMessage(),j=e.getDestination();g.debug("Building reliable relay "+c+" with: msgId="+f+" and relayId="+e.getId());var k=h.buildRelayMsg(e.getConversation(),j);return k.control.type=c,k.header.action=d.ACTION.RELIABLE_RELAY,c===d.TYPE.MESSAGE&&(k.header.action=d.ACTION.RELAY),k.header.relay.msgId=f,k.header.relay.relayId=e.getId(),b&&a.message&&(g.debug("Resending original message with correlation_id: "+a.message.control.correlation_id),k.control.sequence=a.message.control.sequence,k.control.correlation_id=a.message.control.correlation_id),c===d.TYPE.RESPONSE&&(g.debug("  as "+(i?"final":"subsequent")+" response"),i?k.control.message_state=d.MESSAGESTATE.FINAL:k.control.message_state=d.MESSAGESTATE.SUBSEQUENT),c===d.TYPE.ERROR&&(k.header.error_code=406),a.text&&(k.header.relay.messages[0].text=a.text),a.data&&(k.header.relay.messages[0].data=a.data),a.commands&&(k.header.relay.messages[0].commands=a.commands,c===d.TYPE.ERROR&&(k.header.reason=a.commands[0].arguments[0].reason)),k},h.sendStreamOptions=function(a,b,c,e,f){var h=a.getRelayForStream(b);null===h?h=a.createRelay(b.getId(),b):g.debug("Found relay with id: "+h.getId()),h.createCommand(d.CONVERSATION.STREAM_OPTIONS,[c.asJSON()]).withCallbacks(e,f).send()},h.sendPauseResume=function(a,b,c,e,f){var h=a.getSpecificRelayForStream(b);null===h?h=a.createRelay(b.getId(),b):g.debug("Found relay with id: "+h.getId()),h.createCommand(d.CONVERSATION.PAUSE_RESUME_STREAM,[c]).withCallbacks(e,f).send()},h.sendCancelRequest=function(a,b,c,e,f){var h=a.getRelayForStream(b);null===h?console.warn("No previous command for stream",b):(g.debug("Found relay with id: "+h.getId()),h.createCommand(d.CONVERSATION.CANCEL,[{original_directive:c}]).withCallbacks(e,f).send())},h.sendAddStream=function(a,b,c,e,f,i){var j=b.getStreamInfos()[0],k=b.getUri();g.debug("sendAddStream to participant: "+k+" with type: "+c);var l=a.getRelayForStream(j);null===l?l=a.createRelay(j.getId(),j):g.debug("Found relay with id: "+l.getId());var m={stream_type:c,stream_options:e.asJSON()},n=l.createCommand(d.CONVERSATION.ADD_STREAM,[m]).withCallbacks(f,i);a.isShortCircuit()?(g.debug("Short-circuit conversation - creating sidebar before adding stream"),h.sendCreateSidebar(a),a.pendingAddStreamRelay=n):(g.debug("Sending relay to add stream"),n.send())},h.sendDelayedAddStreamRequest=function(a){g.debug("sendDelayedAddStreamRequest",a.pendingAddStreamRelay),a.pendingAddStreamRelay&&(g.debug("Sending delayed relay to add stream"),a.pendingAddStreamRelay.send(),a.pendingAddStreamRelay=null)},h.sendStreamLayout=function(a,b,c,e){e||(e=a.getAudioVideoStream());var f=h.conversationRequest(a);f.header.instructions=[{instruction_name:d.CONVERSATION.STREAM_LAYOUT,participants:[{uri:b.getParticipant().getUri(),stream_id:b.getId(),stream_type:b.getType(),size:c}]}],f.header.stream_id=e.getId(),f.header.stream_type=e.getType(),g.debug("Sending conversation modify request to set stream size for "+b.participant.uri),a.session.sendMessage(f)},h.sendCreateSidebar=function(a){var b=a.getAudioVideoStream(),c=h.conversationRequest(a);c.header.instructions=[{instruction_name:d.CONVERSATION.CREATE_SIDEBAR}],c.header.stream_id=b.getId(),c.header.stream_type=b.getType(),g.debug("Sending conversation modify request to create sidebar"),a.session.sendMessage(c)},h.conversationRequest=function(a){var b=new e.Message;return b.control.type=d.TYPE.REQUEST,b.control.subsession_id=a.subSessionId,b.control.package_type=a.pkgInstance.packageType,b.control.ack_sequence=a.session.lastInboundSeq,b.header.initiator=a.session.userName,b.header.action=d.ACTION.MODIFY,a.conversationKey&&(b.header.conversation_key=a.conversationKey),a.conversationTopic&&(b.header.conversation_topic=a.conversationTopic),a.sidebarId&&(b.header.sidebar=a.sidebarId),b},h.getPauseResumeTargets=function(b){var c=b.audioConfig===d.MEDIADIRECTION.NONE,e=b.videoConfig===d.MEDIADIRECTION.NONE;return new a.PauseResume(c?d.PAUSERESUME.PAUSE:d.PAUSERESUME.RESUME,e?d.PAUSERESUME.PAUSE:d.PAUSERESUME.RESUME,d.PAUSERESUMEREASON.PAUSE_RESUME)},a.StreamInfo=n,a.AudioVideoStream=p,a.ScreenShareStream=q,a.Participant=o,a.Conversation=k,a.ConversationPackage=j,a.Connection=i,a.Relay=r,a.RelayMessage=s,a.QualityMonitor=u,a.PauseResume=l,a.StreamRequest=t,a.StreamProfile=m,console.log("conversation initialized."),a}(cloud||{});